'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const master_model_1 = require("../master/master.model");
const _ = require("underscore");
let config = require('../../../server/lib/stats/stats.config.json');
const BAR_SCHEMA = {
    now: Number,
    total: Number,
    regen: Number,
};
exports.BASE_STATS_SCHEMA = {
    str: Number,
    mag: Number,
    dex: Number,
    hp: Number,
    mp: Number,
};
const STATS_SCHEMA = {
    str: 3,
    mag: 2,
    dex: 2,
    lvl: 1,
    exp: 0,
    hp: {},
    mp: {},
    abilities: config.BEGIN_ABILITIES,
    primaryAbility: config.ABILITY_MELEE
};
class StatsModel extends master_model_1.default {
    init(files, app) {
        this.services = files.services;
        this.hasId = false;
        this.schema = _.clone(STATS_SCHEMA);
        for (let i in this.schema) {
            this.schema[i] = this.getSchemaType(this.schema[i]);
        }
    }
    getSchemaType(schema) {
        let type;
        if (typeof schema === "number") {
            type = Number;
        }
        else if (typeof schema === "string") {
            type = String;
        }
        else {
            if (Array.isArray(schema)) {
                type = [String];
            }
            else {
                type = BAR_SCHEMA;
            }
        }
        return type;
    }
    get priority() {
        return 35;
    }
    createModel() {
        this.setModel("Stats");
        this.addToSchema("Character", { stats: this.getModel().schema });
        this.listenForFieldAddition("Character", "stats");
        return Promise.resolve();
    }
    addFieldToModel(field, data, obj, reqBody) {
        data = _.clone(STATS_SCHEMA);
        let str = +reqBody.str;
        let mag = +reqBody.mag;
        let dex = +reqBody.dex;
        if (str > 0 && mag > 0 && dex > 0 && str + mag + dex == config.BEGIN_STATS_SUM) {
            data.str = str;
            data.mag = mag;
            data.dex = dex;
        }
        data.hp.now = data.hp.total = this.services.strToHp(data.str);
        data.mp.now = data.mp.total = this.services.magToMp(data.mag);
        data.hp.regen = config.BEGIN_HP_REGEN;
        data.mp.regen = config.BEGIN_MP_REGEN;
        obj[field] = data;
    }
}
exports.default = StatsModel;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NlcnZlci9saWIvc3RhdHMvc3RhdHMubW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOztBQUNiLHlEQUFpRDtBQUVqRCxnQ0FBZ0M7QUFDaEMsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLDZDQUE2QyxDQUFDLENBQUM7QUFFcEUsTUFBTSxVQUFVLEdBQUc7SUFDZixHQUFHLEVBQUUsTUFBTTtJQUNYLEtBQUssRUFBRSxNQUFNO0lBQ2IsS0FBSyxFQUFFLE1BQU07Q0FDaEIsQ0FBQTtBQUVZLFFBQUEsaUJBQWlCLEdBQUc7SUFDN0IsR0FBRyxFQUFFLE1BQU07SUFDWCxHQUFHLEVBQUUsTUFBTTtJQUNYLEdBQUcsRUFBRSxNQUFNO0lBQ1gsRUFBRSxFQUFFLE1BQU07SUFDVixFQUFFLEVBQUUsTUFBTTtDQUNiLENBQUM7QUFFRixNQUFNLFlBQVksR0FBRztJQUNqQixHQUFHLEVBQUUsQ0FBQztJQUNOLEdBQUcsRUFBRSxDQUFDO0lBQ04sR0FBRyxFQUFFLENBQUM7SUFDTixHQUFHLEVBQUUsQ0FBQztJQUNOLEdBQUcsRUFBRSxDQUFDO0lBQ04sRUFBRSxFQUFFLEVBQUU7SUFDTixFQUFFLEVBQUUsRUFBRTtJQUNOLFNBQVMsRUFBRSxNQUFNLENBQUMsZUFBZTtJQUNqQyxjQUFjLEVBQUUsTUFBTSxDQUFDLGFBQWE7Q0FDdkMsQ0FBQTtBQUVELGdCQUFnQyxTQUFRLHNCQUFXO0lBRy9DLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRztRQUNYLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQztRQUMvQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFcEMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDeEIs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LDZCQTJEQztBQUFBLENBQUMiLCJmaWxlIjoibGliL3N0YXRzL3N0YXRzLm1vZGVsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuaW1wb3J0IE1hc3Rlck1vZGVsIGZyb20gJy4uL21hc3Rlci9tYXN0ZXIubW9kZWwnO1xuaW1wb3J0IFN0YXRzU2VydmljZXMgZnJvbSAnLi9zdGF0cy5zZXJ2aWNlcyc7XG5pbXBvcnQgKiBhcyBfIGZyb20gJ3VuZGVyc2NvcmUnO1xubGV0IGNvbmZpZyA9IHJlcXVpcmUoJy4uLy4uLy4uL3NlcnZlci9saWIvc3RhdHMvc3RhdHMuY29uZmlnLmpzb24nKTtcblxuY29uc3QgQkFSX1NDSEVNQSA9IHtcbiAgICBub3c6IE51bWJlcixcbiAgICB0b3RhbDogTnVtYmVyLFxuICAgIHJlZ2VuOiBOdW1iZXIsXG59XG5cbmV4cG9ydCBjb25zdCBCQVNFX1NUQVRTX1NDSEVNQSA9IHtcbiAgICBzdHI6IE51bWJlcixcbiAgICBtYWc6IE51bWJlcixcbiAgICBkZXg6IE51bWJlcixcbiAgICBocDogTnVtYmVyLFxuICAgIG1wOiBOdW1iZXIsXG59O1xuXG5jb25zdCBTVEFUU19TQ0hFTUEgPSB7XG4gICAgc3RyOiAzLFxuICAgIG1hZzogMixcbiAgICBkZXg6IDIsXG4gICAgbHZsOiAxLFxuICAgIGV4cDogMCxcbiAgICBocDoge30sXG4gICAgbXA6IHt9LFxuICAgIGFiaWxpdGllczogY29uZmlnLkJFR0lOX0FCSUxJVElFUyxcbiAgICBwcmltYXJ5QWJpbGl0eTogY29uZmlnLkFCSUxJVFlfTUVMRUVcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU3RhdHNNb2RlbCBleHRlbmRzIE1hc3Rlck1vZGVsIHtcbiAgICBwcm90ZWN0ZWQgc2VydmljZXM6IFN0YXRzU2VydmljZXM7XG5cbiAgICBpbml0KGZpbGVzLCBhcHApIHtcbiAgICAgICAgdGhpcy5zZXJ2aWNlcyA9IGZpbGVzLnNlcnZpY2VzO1xuICAgICAgICB0aGlzLmhhc0lkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuc2NoZW1hID0gXy5jbG9uZShTVEFUU19TQ0hFTUEpO1xuXG4gICAgICAgIGZvciAobGV0IGkgaW4gdGhpcy5zY2hlbWEpIHtcbiAgICAgICAgICAgIHRoaXMuc2NoZW1hW2ldID0gdGhpcy5nZXRTY2hlbWFUeXBlKHRoaXMuc2NoZW1hW2ldKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0U2NoZW1hVHlwZShzY2hlbWEpIHtcbiAgICAgICAgbGV0IHR5cGU7XG4gICAgICAgIGlmICh0eXBlb2Ygc2NoZW1hID09PSBcIm51bWJlclwiKSB7XG4gICAgICAgICAgICB0eXBlID0gTnVtYmVyO1xuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzY2hlbWEgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgIHR5cGUgPSBTdHJpbmc7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShzY2hlbWEpKSB7XG4gICAgICAgICAgICAgICAgdHlwZSA9IFtTdHJpbmddO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0eXBlID0gQkFSX1NDSEVNQTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHlwZTtcbiAgICB9XG5cbiAgICBnZXQgcHJpb3JpdHkoKSB7XG4gICAgICAgIHJldHVybiAzNTtcbiAgICB9XG5cbiAgICBjcmVhdGVNb2RlbCgpIHtcbiAgICAgICAgdGhpcy5zZXRNb2RlbChcIlN0YXRzXCIpO1xuICAgICAgICB0aGlzLmFkZFRvU2NoZW1hKFwiQ2hhcmFjdGVyXCIsIHsgc3RhdHM6IHRoaXMuZ2V0TW9kZWwoKS5zY2hlbWEgfSk7XG5cbiAgICAgICAgdGhpcy5saXN0ZW5Gb3JGaWVsZEFkZGl0aW9uKFwiQ2hhcmFjdGVyXCIsIFwic3RhdHNcIik7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYWRkRmllbGRUb01vZGVsKGZpZWxkLCBkYXRhLCBvYmosIHJlcUJvZHkpIHtcbiAgICAgICAgZGF0YSA9IF8uY2xvbmUoU1RBVFNfU0NIRU1BKTtcblxuICAgICAgICBsZXQgc3RyID0gK3JlcUJvZHkuc3RyO1xuICAgICAgICBsZXQgbWFnID0gK3JlcUJvZHkubWFnO1xuICAgICAgICBsZXQgZGV4ID0gK3JlcUJvZHkuZGV4O1xuICAgICAgICBpZiAoc3RyID4gMCAmJiBtYWcgPiAwICYmIGRleCA+IDAgJiYgc3RyICsgbWFnICsgZGV4ID09IGNvbmZpZy5CRUdJTl9TVEFUU19TVU0pIHtcbiAgICAgICAgICAgIGRhdGEuc3RyID0gc3RyO1xuICAgICAgICAgICAgZGF0YS5tYWcgPSBtYWc7XG4gICAgICAgICAgICBkYXRhLmRleCA9IGRleDtcbiAgICAgICAgfVxuICAgICAgICBkYXRhLmhwLm5vdyA9IGRhdGEuaHAudG90YWwgPSB0aGlzLnNlcnZpY2VzLnN0clRvSHAoZGF0YS5zdHIpO1xuICAgICAgICBkYXRhLm1wLm5vdyA9IGRhdGEubXAudG90YWwgPSB0aGlzLnNlcnZpY2VzLm1hZ1RvTXAoZGF0YS5tYWcpO1xuICAgICAgICBkYXRhLmhwLnJlZ2VuID0gY29uZmlnLkJFR0lOX0hQX1JFR0VOO1xuICAgICAgICBkYXRhLm1wLnJlZ2VuID0gY29uZmlnLkJFR0lOX01QX1JFR0VOXG5cbiAgICAgICAgb2JqW2ZpZWxkXSA9IGRhdGE7XG4gICAgfVxufTsiXX0=
