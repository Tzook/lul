'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const socketio_router_base_1 = require("../socketio/socketio.router.base");
const _ = require("underscore");
let config = require('../../../server/lib/rooms/rooms.config.json');
class RoomsRouter extends socketio_router_base_1.default {
    init(files, app) {
        this.services = files.services;
        super.init(files, app);
    }
    initRoutes(app) {
        app.post(this.ROUTES.GENERATE, this.middleware.validateHasSercetKey.bind(this.middleware), this.controller.generateRoom.bind(this.controller));
    }
    getRoomInfo(room) {
        return this.services.getRoomInfo(room);
    }
    [config.SERVER_GETS.ENTERED_ROOM.name](data, socket) {
        socket.broadcast.to(socket.character.room).emit(this.CLIENT_GETS.JOIN_ROOM.name, {
            character: this.middleware.getPublicCharInfo(socket.character)
        });
        let roomObject = socket.adapter.rooms[socket.character.room];
        if (roomObject) {
            _.each(roomObject.sockets, (value, socketId) => {
                socket.emit(this.CLIENT_GETS.JOIN_ROOM.name, {
                    character: this.middleware.getPublicCharInfo(socket.map.get(socketId).character)
                });
            });
        }
        this.controller.socketJoinRoom(socket);
    }
    [config.SERVER_GETS.ENTER_PORTAL.name](data, socket) {
        let roomInfo = this.services.getRoomInfo(socket.character.room);
        if (!roomInfo) {
            this.sendError(data, socket, "No room info available!");
        }
        else if (!roomInfo.portals[data.portal]) {
            this.sendError(data, socket, "No portal with such key in room: " + socket.character.room);
        }
        else {
            let portal = roomInfo.portals[data.portal];
            let targetRoomInfo = this.services.getRoomInfo(portal.targetRoom);
            if (!targetRoomInfo) {
                this.sendError(data, socket, "No target room info available!");
            }
            else if (!targetRoomInfo.portals[portal.targetPortal]) {
                this.sendError(data, socket, "No target portal in room!");
            }
            else {
                let targetPortal = targetRoomInfo.portals[portal.targetPortal];
                this.moveRoom(socket, portal.targetRoom, targetPortal);
            }
        }
    }
    [config.SERVER_INNER.MOVE_TO_TOWN.name](data, socket) {
        let roomInfo = this.services.getRoomInfo(socket.character.room);
        if (!roomInfo) {
            this.sendError(data, socket, "No room info available for " + socket.character.room);
        }
        else {
            let targetRoomInfo = this.services.getRoomInfo(roomInfo.town);
            if (!targetRoomInfo) {
                this.sendError(data, socket, "No target room info available for " + roomInfo.town);
            }
            else {
                let targetPortal = this.controller.pickRandomPortal(targetRoomInfo);
                this.moveRoom(socket, targetRoomInfo.name, targetPortal);
            }
        }
    }
    moveRoom(socket, room, targetPortal) {
        socket.leave(socket.character.room);
        this.emitter.emit(config.SERVER_INNER.LEFT_ROOM.name, {}, socket);
        socket.character.room = room;
        socket.character.position.x = targetPortal.x;
        socket.character.position.y = targetPortal.y;
        socket.emit(this.CLIENT_GETS.MOVE_ROOM.name, {
            room,
            character: socket.character
        });
    }
    [config.SERVER_GETS.DISCONNECT.name](data, socket) {
        this.emitter.emit(config.SERVER_INNER.LEFT_ROOM.name, {}, socket);
    }
    [config.SERVER_INNER.LEFT_ROOM.name](data, socket) {
        this.controller.socketLeaveRoom(socket, socket.character.room);
        socket.broadcast.to(socket.character.room).emit(this.CLIENT_GETS.LEFT_ROOM.name, {
            id: socket.character._id
        });
    }
    [config.SERVER_GETS.BITCH_PLEASE.name](data, socket) {
        let key = data.key;
        this.controller.newBitchRequest(socket, key);
    }
    onConnected(socket) {
        socket.emit(this.CLIENT_GETS.MOVE_ROOM.name, {
            room: socket.character.room,
            character: socket.character,
        });
    }
}
exports.default = RoomsRouter;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NlcnZlci9saWIvcm9vbXMvcm9vbXMucm91dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7QUFDYiwyRUFBa0U7QUFDbEUsZ0NBQWdDO0FBSWhDLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO0FBRXBFLGlCQUFpQyxTQUFRLDhCQUFrQjtJQUsxRCxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUc7UUFDZCxJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUM7UUFDL0IsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDeEIsQ0FBQztJQUVTLFVBQVUsQ0FBQyxHQUFHO1FBQ3ZCLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQzVCLElBQUksQ0FBQyxVQUFVLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFDMUQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFTSxXQUFXLENBQUMsSUFBWTtRQUM5QixNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVELENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLE1BQWtCO1FBQzlELE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRTtZQUNoRixTQUFTLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxNQUFN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QyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFO1lBQ2xELElBQUksRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUk7WUFDM0IsU0FBUyxFQUFFLE1BQU0sQ0FBQyxTQUFTO1NBQzNCLENBQUMsQ0FBQztJQUNELENBQUM7Q0FDSjtBQTdHRCw4QkE2R0M7QUFBQSxDQUFDIiwiZmlsZSI6ImxpYi9yb29tcy9yb29tcy5yb3V0ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5pbXBvcnQgU29ja2V0aW9Sb3V0ZXJCYXNlIGZyb20gJy4uL3NvY2tldGlvL3NvY2tldGlvLnJvdXRlci5iYXNlJztcbmltcG9ydCAqIGFzIF8gZnJvbSAndW5kZXJzY29yZSc7XG5pbXBvcnQgUm9vbXNDb250cm9sbGVyIGZyb20gJy4vcm9vbXMuY29udHJvbGxlcic7XG5pbXBvcnQgUm9vbXNNaWRkbGV3YXJlIGZyb20gXCIuL3Jvb21zLm1pZGRsZXdhcmVcIjtcbmltcG9ydCBSb29tc1NlcnZpY2VzIGZyb20gXCIuL3Jvb21zLnNlcnZpY2VzXCI7XG5sZXQgY29uZmlnID0gcmVxdWlyZSgnLi4vLi4vLi4vc2VydmVyL2xpYi9yb29tcy9yb29tcy5jb25maWcuanNvbicpO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSb29tc1JvdXRlciBleHRlbmRzIFNvY2tldGlvUm91dGVyQmFzZSB7XG5cdHByb3RlY3RlZCBtaWRkbGV3YXJlOiBSb29tc01pZGRsZXdhcmU7XG5cdHByb3RlY3RlZCBjb250cm9sbGVyOiBSb29tc0NvbnRyb2xsZXI7XG5cdHByb3RlY3RlZCBzZXJ2aWNlczogUm9vbXNTZXJ2aWNlcztcblxuXHRpbml0KGZpbGVzLCBhcHApIHtcblx0XHR0aGlzLnNlcnZpY2VzID0gZmlsZXMuc2VydmljZXM7XG5cdFx0c3VwZXIuaW5pdChmaWxlcywgYXBwKTtcblx0fVxuXG5cdHByb3RlY3RlZCBpbml0Um91dGVzKGFwcCkge1xuXHRcdGFwcC5wb3N0KHRoaXMuUk9VVEVTLkdFTkVSQVRFLFxuXHRcdFx0dGhpcy5taWRkbGV3YXJlLnZhbGlkYXRlSGFzU2VyY2V0S2V5LmJpbmQodGhpcy5taWRkbGV3YXJlKSxcblx0XHRcdHRoaXMuY29udHJvbGxlci5nZW5lcmF0ZVJvb20uYmluZCh0aGlzLmNvbnRyb2xsZXIpKTtcblx0fVxuXG5cdHB1YmxpYyBnZXRSb29tSW5mbyhyb29tOiBzdHJpbmcpOiBST09NX01PREVMfHVuZGVmaW5lZCB7XG5cdFx0cmV0dXJuIHRoaXMuc2VydmljZXMuZ2V0Um9vbUluZm8ocm9vbSk7XG5cdH1cblxuXHRbY29uZmlnLlNFUlZFUl9HRVRTLkVOVEVSRURfUk9PTS5uYW1lXShkYXRhLCBzb2NrZXQ6IEdhbWVTb2NrZXQpIHtcblx0XHRzb2NrZXQuYnJvYWRjYXN0LnRvKHNvY2tldC5jaGFyYWN0ZXIucm9vbSkuZW1pdCh0aGlzLkNMSUVOVF9HRVRTLkpPSU5fUk9PTS5uYW1lLCB7XG5cdFx0XHRjaGFyYWN0ZXI6IHRoaXMubWlkZGxld2FyZS5nZXRQdWJsaWNDaGFySW5mbyhzb2NrZXQuY2hhcmFjdGVyKVxuXHRcdH0pO1xuXHRcdGxldCByb29tT2JqZWN0ID0gc29ja2V0LmFkYXB0ZXIucm9vbXNbc29ja2V0LmNoYXJhY3Rlci5yb29tXTtcblx0XHRpZiAocm9vbU9iamVjdCkge1xuXHRcdFx0Xy5lYWNoKHJvb21PYmplY3Quc29ja2V0cywgKHZhbHVlLCBzb2NrZXRJZDogc3RyaW5nKSA9PiB7XG5cdFx0XHRcdHNvY2tldC5lbWl0KHRoaXMuQ0xJRU5UX0dFVFMuSk9JTl9ST09NLm5hbWUsIHtcblx0XHRcdFx0XHRjaGFyYWN0ZXI6IHRoaXMubWlkZGxld2FyZS5nZXRQdWJsaWNDaGFySW5mbyhzb2NrZXQubWFwLmdldChzb2NrZXRJZCkuY2hhcmFjdGVyKVxuXHRcdFx0XHR9KTtcblx0XHRcdH0pO1xuXHRcdH1cblxuXHRcdHRoaXMuY29udHJvbGxlci5zb2NrZXRKb2luUm9vbShzb2NrZXQpO1xuXHR9XG5cblx0W2NvbmZpZy5TRVJWRVJfR0VUUy5FTlRFUl9QT1JUQUwubmFtZV0oZGF0YSwgc29ja2V0OiBHYW1lU29ja2V0KSB7XG5cdFx0bGV0IHJvb21JbmZvID0gdGhpcy5zZXJ2aWNlcy5nZXRSb29tSW5mbyhzb2NrZXQuY2hhcmFjdGVyLnJvb20pO1xuXHRcdGlmICghcm9vbUluZm8pIHtcblx0XHRcdHRoaXMuc2VuZEVycm9yKGRhdGEsIHNvY2tldCwgXCJObyByb29tIGluZm8gYXZhaWxhYmxlIVwiKTtcblx0XHR9IGVsc2UgaWYgKCFyb29tSW5mby5wb3J0YWxzW2RhdGEucG9ydGFsXSkge1xuXHRcdFx0dGhpcy5zZW5kRXJyb3IoZGF0YSwgc29ja2V0LCBcIk5vIHBvcnRhbCB3aXRoIHN1Y2gga2V5IGluIHJvb206IFwiICsgc29ja2V0LmNoYXJhY3Rlci5yb29tKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0bGV0IHBvcnRhbCA9IHJvb21JbmZvLnBvcnRhbHNbZGF0YS5wb3J0YWxdO1xuXHRcdFx0bGV0IHRhcmdldFJvb21JbmZvID0gdGhpcy5zZXJ2aWNlcy5nZXRSb29tSW5mbyhwb3J0YWwudGFyZ2V0Um9vbSk7XG5cdFx0XHRpZiAoIXRhcmdldFJvb21JbmZvKSB7XG5cdFx0XHRcdHRoaXMuc2VuZEVycm9yKGRhdGEsIHNvY2tldCwgXCJObyB0YXJnZXQgcm9vbSBpbmZvIGF2YWlsYWJsZSFcIik7XG5cdFx0XHR9IGVsc2UgaWYgKCF0YXJnZXRSb29tSW5mby5wb3J0YWxzW3BvcnRhbC50YXJnZXRQb3J0YWxdKSB7XG5cdFx0XHRcdHRoaXMuc2VuZEVycm9yKGRhdGEsIHNvY2tldCwgXCJObyB0YXJnZXQgcG9ydGFsIGluIHJvb20hXCIpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0bGV0IHRhcmdldFBvcnRhbCA9IHRhcmdldFJvb21JbmZvLnBvcnRhbHNbcG9ydGFsLnRhcmdldFBvcnRhbF07XG5cdFx0XHRcdHRoaXMubW92ZVJvb20oc29ja2V0LCBwb3J0YWwudGFyZ2V0Um9vbSwgdGFyZ2V0UG9ydGFsKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRbY29uZmlnLlNFUlZFUl9JTk5FUi5NT1ZFX1RPX1RPV04ubmFtZV0gKGRhdGEsIHNvY2tldDogR2FtZVNvY2tldCkge1xuXHRcdGxldCByb29tSW5mbyA9IHRoaXMuc2VydmljZXMuZ2V0Um9vbUluZm8oc29ja2V0LmNoYXJhY3Rlci5yb29tKTtcblx0XHRpZiAoIXJvb21JbmZvKSB7XG5cdFx0XHR0aGlzLnNlbmRFcnJvcihkYXRhLCBzb2NrZXQsIFwiTm8gcm9vbSBpbmZvIGF2YWlsYWJsZSBmb3IgXCIgKyBzb2NrZXQuY2hhcmFjdGVyLnJvb20pO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRsZXQgdGFyZ2V0Um9vbUluZm8gPSB0aGlzLnNlcnZpY2VzLmdldFJvb21JbmZvKHJvb21JbmZvLnRvd24pO1xuXHRcdFx0aWYgKCF0YXJnZXRSb29tSW5mbykge1xuXHRcdFx0XHR0aGlzLnNlbmRFcnJvcihkYXRhLCBzb2NrZXQsIFwiTm8gdGFyZ2V0IHJvb20gaW5mbyBhdmFpbGFibGUgZm9yIFwiICsgcm9vbUluZm8udG93bik7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRsZXQgdGFyZ2V0UG9ydGFsID0gdGhpcy5jb250cm9sbGVyLnBpY2tSYW5kb21Qb3J0YWwodGFyZ2V0Um9vbUluZm8pO1xuXHRcdFx0XHR0aGlzLm1vdmVSb29tKHNvY2tldCwgdGFyZ2V0Um9vbUluZm8ubmFtZSwgdGFyZ2V0UG9ydGFsKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIG1vdmVSb29tKHNvY2tldDogR2FtZVNvY2tldCwgcm9vbTogc3RyaW5nLCB0YXJnZXRQb3J0YWw6IFBPUlRBTF9NT0RFTCkge1xuXHRcdHNvY2tldC5sZWF2ZShzb2NrZXQuY2hhcmFjdGVyLnJvb20pO1xuXG4gICAgICAgIHRoaXMuZW1pdHRlci5lbWl0KGNvbmZpZy5TRVJWRVJfSU5ORVIuTEVGVF9ST09NLm5hbWUsIHt9LCBzb2NrZXQpO1xuXHRcdFxuXHRcdHNvY2tldC5jaGFyYWN0ZXIucm9vbSA9IHJvb207XG5cdFx0c29ja2V0LmNoYXJhY3Rlci5wb3NpdGlvbi54ID0gdGFyZ2V0UG9ydGFsLng7XG5cdFx0c29ja2V0LmNoYXJhY3Rlci5wb3NpdGlvbi55ID0gdGFyZ2V0UG9ydGFsLnk7XG5cdFx0c29ja2V0LmVtaXQodGhpcy5DTElFTlRfR0VUUy5NT1ZFX1JPT00ubmFtZSwge1xuXHRcdFx0cm9vbSxcblx0XHRcdGNoYXJhY3Rlcjogc29ja2V0LmNoYXJhY3RlclxuXHRcdH0pO1xuXG5cdH1cblxuXHRbY29uZmlnLlNFUlZFUl9HRVRTLkRJU0NPTk5FQ1QubmFtZV0oZGF0YSwgc29ja2V0OiBHYW1lU29ja2V0KSB7XG5cdFx0dGhpcy5lbWl0dGVyLmVtaXQoY29uZmlnLlNFUlZFUl9JTk5FUi5MRUZUX1JPT00ubmFtZSwge30sIHNvY2tldCk7XG5cdH1cblxuXHRbY29uZmlnLlNFUlZFUl9JTk5FUi5MRUZUX1JPT00ubmFtZV0oZGF0YSwgc29ja2V0OiBHYW1lU29ja2V0KSB7XG5cdFx0dGhpcy5jb250cm9sbGVyLnNvY2tldExlYXZlUm9vbShzb2NrZXQsIHNvY2tldC5jaGFyYWN0ZXIucm9vbSk7XG5cdFxuXHRcdHNvY2tldC5icm9hZGNhc3QudG8oc29ja2V0LmNoYXJhY3Rlci5yb29tKS5lbWl0KHRoaXMuQ0xJRU5UX0dFVFMuTEVGVF9ST09NLm5hbWUsIHtcblx0XHRcdCBpZDogc29ja2V0LmNoYXJhY3Rlci5faWRcblx0XHR9KTtcblx0fVxuXG5cdFtjb25maWcuU0VSVkVSX0dFVFMuQklUQ0hfUExFQVNFLm5hbWVdKGRhdGEsIHNvY2tldDogR2FtZVNvY2tldCkge1xuXHRcdGxldCBrZXkgPSBkYXRhLmtleTtcblx0XHR0aGlzLmNvbnRyb2xsZXIubmV3Qml0Y2hSZXF1ZXN0KHNvY2tldCwga2V5KTtcblx0fVxuXG4gICAgcHVibGljIG9uQ29ubmVjdGVkKHNvY2tldDogR2FtZVNvY2tldCkge1xuICAgICAgICBzb2NrZXQuZW1pdCh0aGlzLkNMSUVOVF9HRVRTLk1PVkVfUk9PTS5uYW1lLCB7XG5cdFx0XHRyb29tOiBzb2NrZXQuY2hhcmFjdGVyLnJvb20sXG5cdFx0XHRjaGFyYWN0ZXI6IHNvY2tldC5jaGFyYWN0ZXIsXG5cdFx0fSk7XG4gICAgfVxufTsiXX0=
