'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const master_middleware_1 = require("../master/master.middleware");
let config = require('../../../server/lib/items/items.config.json');
exports.NO_SLOT = -1;
class ItemsMiddleware extends master_middleware_1.default {
    getFirstAvailableSlot(socket, blacklist = new Set()) {
        for (var slot = 0; slot < config.MAX_ITEMS; slot++) {
            if (blacklist.has(slot)) {
                continue;
            }
            if (!this.hasItem(socket, slot)) {
                break;
            }
        }
        return slot < config.MAX_ITEMS ? slot : exports.NO_SLOT;
    }
    isValidItemSlot(slot) {
        return slot >= 0 && slot < config.MAX_ITEMS;
    }
    hasItem(socket, slot) {
        return this.isItem(socket.character.items[slot]);
    }
    isItem(item) {
        return !!item.key;
    }
    isMisc(item) {
        return item.cap > 1 && !this.isGold(item);
    }
    isGold(item) {
        return item.key === "gold";
    }
    getStackSlots(socket, item, itemInfo, blacklist = new Set()) {
        let { stack } = item;
        let slots = [];
        for (let slot = 0; slot < config.MAX_ITEMS; slot++) {
            if (stack <= 0) {
                break;
            }
            let slotItem = socket.character.items[slot];
            if (slotItem.key === item.key && slotItem.stack < itemInfo.cap) {
                slots.push(slot);
                stack -= (itemInfo.cap - slotItem.stack);
            }
        }
        for (let slot = 0; slot < config.MAX_ITEMS; slot++) {
            if (blacklist.has(slot)) {
                continue;
            }
            if (stack <= 0) {
                break;
            }
            if (!this.hasItem(socket, slot)) {
                slots.push(slot);
                stack -= itemInfo.cap;
            }
        }
        return stack <= 0 ? slots : [];
    }
    getItemsSlots(socket, items) {
        let itemsToSlots = {};
        let blacklist = new Set();
        for (let item of items) {
            let itemInfo = this.services.getItemInfo(item.key);
            if (this.isMisc(itemInfo)) {
                let slots = this.getStackSlots(socket, item, itemInfo, blacklist);
                if (slots.length === 0) {
                    return false;
                }
                else {
                    slots.forEach(slot => blacklist.add(slot));
                    itemsToSlots[item.key] = slots;
                }
            }
            else if (!this.isGold(itemInfo)) {
                let slot = this.getFirstAvailableSlot(socket, blacklist);
                if (slot === exports.NO_SLOT) {
                    return false;
                }
                else {
                    blacklist.add(slot);
                    itemsToSlots[item.key] = [slot];
                }
            }
        }
        return itemsToSlots;
    }
}
exports.default = ItemsMiddleware;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NlcnZlci9saWIvaXRlbXMvaXRlbXMubWlkZGxld2FyZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7O0FBQ2IsbUVBQTJEO0FBRTNELElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO0FBRXZELFFBQUEsT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBRTFCLHFCQUFxQyxTQUFRLDJCQUFnQjtJQUd6RCxxQkFBcUIsQ0FBQyxNQUFrQixFQUFFLFlBQXlCLElBQUksR0FBRyxFQUFFO1FBQ3hFLEdBQUcsQ0FBQyxDQUFDLElBQUksSUFBSSxHQUFHLENBQUMsRUFBRSxJQUFJLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsRUFBRSxDQUFDO1lBQ2pELEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN0QixRQUFRLENBQUM7WUFDYixDQUFDO1lBQ1YsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2pDLEtBQUssQ0FBQztZQUNQLENBQUM7UUFDRixDQUFDO1FBQ0ssTUFBTSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsU0FBUyxHQUFHLElBQUksR0FBRyxlQUFPLENBQUM7SUFDcEQsQ0FBQztJQUVELGVBQWUsQ0FBQyxJQUFZO1FBQ3hCLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLElBQUksR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDO0lBQ2hELENBQUM7SUFFRCxPQUFPLENBQUMsTUFBa0IsRUFBRSxJQUFZO1FBQ3BDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVELE1BQU0sQ0FBQyxJ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SyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUN4QixNQUFNLENBQUMsS0FBSyxDQUFDO2dCQUNkLENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ1AsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLElBQUksU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO29CQUMzQyxZQUFZLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQztnQkFDaEMsQ0FBQztZQUNGLENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDbkMsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQztnQkFDekQsRUFBRSxDQUFDLENBQUMsSUFBSSxLQUFLLGVBQU8sQ0FBQyxDQUFDLENBQUM7b0JBQ3RCLE1BQU0sQ0FBQyxLQUFLLENBQUM7Z0JBQ2QsQ0FBQztnQkFBQyxJQUFJLENBQUMsQ0FBQztvQkFDUCxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUNwQixZQUFZLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2pDLENBQUM7WUFDRixDQUFDO1FBQ0YsQ0FBQztRQUNELE1BQU0sQ0FBQyxZQUFZLENBQUM7SUFDckIsQ0FBQztDQUNEO0FBNUZELGtDQTRGQztBQUFBLENBQUMiLCJmaWxlIjoibGliL2l0ZW1zL2l0ZW1zLm1pZGRsZXdhcmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5pbXBvcnQgTWFzdGVyTWlkZGxld2FyZSBmcm9tICcuLi9tYXN0ZXIvbWFzdGVyLm1pZGRsZXdhcmUnO1xuaW1wb3J0IEl0ZW1zU2VydmljZXMgZnJvbSAnLi9pdGVtcy5zZXJ2aWNlcyc7XG5sZXQgY29uZmlnID0gcmVxdWlyZSgnLi4vLi4vLi4vc2VydmVyL2xpYi9pdGVtcy9pdGVtcy5jb25maWcuanNvbicpO1xuXG5leHBvcnQgY29uc3QgTk9fU0xPVCA9IC0xO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBJdGVtc01pZGRsZXdhcmUgZXh0ZW5kcyBNYXN0ZXJNaWRkbGV3YXJlIHtcbiAgICBwcm90ZWN0ZWQgc2VydmljZXM6IEl0ZW1zU2VydmljZXM7XG5cbiAgICBnZXRGaXJzdEF2YWlsYWJsZVNsb3Qoc29ja2V0OiBHYW1lU29ja2V0LCBibGFja2xpc3Q6IFNldDxudW1iZXI+ID0gbmV3IFNldCgpKTogbnVtYmVyIHtcbiAgICAgICAgZm9yICh2YXIgc2xvdCA9IDA7IHNsb3QgPCBjb25maWcuTUFYX0lURU1TOyBzbG90KyspIHtcbiAgICAgICAgICAgIGlmIChibGFja2xpc3QuaGFzKHNsb3QpKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG5cdFx0XHRpZiAoIXRoaXMuaGFzSXRlbShzb2NrZXQsIHNsb3QpKSB7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0fVxuXHRcdH1cbiAgICAgICAgcmV0dXJuIHNsb3QgPCBjb25maWcuTUFYX0lURU1TID8gc2xvdCA6IE5PX1NMT1Q7XG4gICAgfVxuXG4gICAgaXNWYWxpZEl0ZW1TbG90KHNsb3Q6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gc2xvdCA+PSAwICYmIHNsb3QgPCBjb25maWcuTUFYX0lURU1TO1xuICAgIH1cblxuICAgIGhhc0l0ZW0oc29ja2V0OiBHYW1lU29ja2V0LCBzbG90OiBudW1iZXIpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaXNJdGVtKHNvY2tldC5jaGFyYWN0ZXIuaXRlbXNbc2xvdF0pO1xuICAgIH1cblxuICAgIGlzSXRlbShpdGVtOiBJVEVNX0lOU1RBTkNFKSB7XG4gICAgICAgIHJldHVybiAhIWl0ZW0ua2V5O1xuICAgIH1cblxuICAgIGlzTWlzYyhpdGVtOiBJVEVNX01PREVMKSB7XG4gICAgICAgIHJldHVybiBpdGVtLmNhcCA+IDEgJiYgIXRoaXMuaXNHb2xkKGl0ZW0pO1xuICAgIH1cblxuICAgIGlzR29sZChpdGVtOiBJVEVNX0lOU1RBTkNFKSB7XG4gICAgICAgIHJldHVybiBpdGVtLmtleSA9PT0gXCJnb2xkXCI7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFN0YWNrU2xvdHMoc29ja2V0OiBHYW1lU29ja2V0LCBpdGVtOiBJVEVNX0lOU1RBTkNFLCBpdGVtSW5mbzogSVRFTV9NT0RFTCwgYmxhY2tsaXN0OiBTZXQ8bnVtYmVyPiA9IG5ldyBTZXQoKSk6IG51bWJlcltdIHsgXG4gICAgICAgIGxldCB7c3RhY2t9ID0gaXRlbTtcbiAgICAgICAgbGV0IHNsb3RzID0gW107XG4gICAgICAgIC8vIHN0ZXAgMSA6IGdldCBzbG90cyB3aXRoIHRoZSBzYW1lIGl0ZW0sIGFuZCBmaWxsIHRoZW0gZmlyc3RcbiAgICAgICAgZm9yIChsZXQgc2xvdCA9IDA7IHNsb3QgPCBjb25maWcuTUFYX0lURU1TOyBzbG90KyspIHtcbiAgICAgICAgICAgIGlmIChzdGFjayA8PSAwKSB7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsZXQgc2xvdEl0ZW0gPSBzb2NrZXQuY2hhcmFjdGVyLml0ZW1zW3Nsb3RdO1xuICAgICAgICAgICAgaWYgKHNsb3RJdGVtLmtleSA9PT0gaXRlbS5rZXkgJiYgc2xvdEl0ZW0uc3RhY2sgPCBpdGVtSW5mby5jYXApIHtcblx0XHRcdFx0c2xvdHMucHVzaChzbG90KTtcbiAgICAgICAgICAgICAgICBzdGFjayAtPSAoaXRlbUluZm8uY2FwIC0gc2xvdEl0ZW0uc3RhY2spO1xuICAgICAgICAgICAgfVxuXHRcdH1cblxuICAgICAgICAvLyBzdGVwIDIgOiBnZXQgZW1wdHkgc2xvdHMgXG4gICAgICAgIGZvciAobGV0IHNsb3QgPSAwOyBzbG90IDwgY29uZmlnLk1BWF9JVEVNUzsgc2xvdCsrKSB7XG4gICAgICAgICAgICBpZiAoYmxhY2tsaXN0LmhhcyhzbG90KSkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN0YWNrIDw9IDApIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghdGhpcy5oYXNJdGVtKHNvY2tldCwgc2xvdCkpIHtcblx0XHRcdFx0c2xvdHMucHVzaChzbG90KTtcbiAgICAgICAgICAgICAgICBzdGFjayAtPSBpdGVtSW5mby5jYXA7XG5cdFx0XHR9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gc3RhY2sgPD0gMCA/IHNsb3RzIDogW107XG4gICAgfVxuXG5cdHB1YmxpYyBnZXRJdGVtc1Nsb3RzKHNvY2tldDogR2FtZVNvY2tldCwgaXRlbXM6IElURU1fSU5TVEFOQ0VbXSk6IGZhbHNlfHtba2V5OiBzdHJpbmddOiBudW1iZXJbXX0ge1xuXHRcdGxldCBpdGVtc1RvU2xvdHMgPSB7fTtcblx0XHRsZXQgYmxhY2tsaXN0OiBTZXQ8bnVtYmVyPiA9IG5ldyBTZXQoKTtcblx0XHRmb3IgKGxldCBpdGVtIG9mIGl0ZW1zKSB7XG5cdFx0XHRsZXQgaXRlbUluZm8gPSB0aGlzLnNlcnZpY2VzLmdldEl0ZW1JbmZvKGl0ZW0ua2V5KTtcblx0XHRcdGlmICh0aGlzLmlzTWlzYyhpdGVtSW5mbykpIHtcblx0XHRcdFx0bGV0IHNsb3RzID0gdGhpcy5nZXRTdGFja1Nsb3RzKHNvY2tldCwgaXRlbSwgaXRlbUluZm8sIGJsYWNrbGlzdCk7XG5cdFx0XHRcdGlmIChzbG90cy5sZW5ndGggPT09IDApIHtcblx0XHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0c2xvdHMuZm9yRWFjaChzbG90ID0+IGJsYWNrbGlzdC5hZGQoc2xvdCkpO1xuXHRcdFx0XHRcdGl0ZW1zVG9TbG90c1tpdGVtLmtleV0gPSBzbG90cztcblx0XHRcdFx0fVxuXHRcdFx0fSBlbHNlIGlmICghdGhpcy5pc0dvbGQoaXRlbUluZm8pKSB7XG5cdFx0XHRcdGxldCBzbG90ID0gdGhpcy5nZXRGaXJzdEF2YWlsYWJsZVNsb3Qoc29ja2V0LCBibGFja2xpc3QpO1xuXHRcdFx0XHRpZiAoc2xvdCA9PT0gTk9fU0xPVCkge1xuXHRcdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRibGFja2xpc3QuYWRkKHNsb3QpO1xuXHRcdFx0XHRcdGl0ZW1zVG9TbG90c1tpdGVtLmtleV0gPSBbc2xvdF07XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cdFx0cmV0dXJuIGl0ZW1zVG9TbG90cztcblx0fVxufTsiXX0=
