'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const socketio_router_base_1 = require("../socketio/socketio.router.base");
let dropsConfig = require('../../../server/lib/drops/drops.config.json');
let config = require('../../../server/lib/items/items.config.json');
class ItemsRouter extends socketio_router_base_1.default {
    init(files, app) {
        this.services = files.services;
        super.init(files, app);
    }
    initRoutes(app) {
        app.post(this.ROUTES.GENERATE, this.middleware.validateHasSercetKey.bind(this.middleware), this.controller.generateItems.bind(this.controller));
    }
    getItemInfo(key) {
        return this.services.getItemInfo(key);
    }
    getItemInstance(key) {
        return this.services.getItemInstance(key);
    }
    getItemsCounts(socket) {
        let map = new Map();
        for (let item of socket.character.items) {
            let currentCount = map.get(item.key) || 0;
            map.set(item.key, currentCount + (item.stack || 1));
        }
        return map;
    }
    getItemsSlots(socket, items) {
        return this.middleware.getItemsSlots(socket, items);
    }
    [config.SERVER_GETS.ITEM_PICK.name](data, socket) {
        this.emitter.emit(dropsConfig.SERVER_INNER.ITEM_PICK.name, data, socket, (item) => {
            let itemInfo = this.getItemInfo(item.key);
            if (itemInfo.cap > 1) {
                return;
            }
            let slot = this.middleware.getFirstAvailableSlot(socket);
            if (!(slot >= 0)) {
                this.sendError(data, socket, config.LOGS.INVENTORY_FULL.MSG, true, true);
            }
            else {
                this[config.SERVER_INNER.ITEM_ADD.name]({ slots: [slot], item }, socket);
                return true;
            }
        });
    }
    [config.SERVER_INNER.ITEM_ADD.name](data, socket) {
        let { slots, item } = data;
        let itemInfo = this.getItemInfo(item.key);
        if (!this.middleware.isGold(item) && !this.middleware.isMisc(itemInfo)) {
            socket.character.items.set(slots[0], item);
            socket.emit(this.CLIENT_GETS.ITEM_ADD.name, { slot: slots[0], item });
        }
    }
    [config.SERVER_INNER.ITEM_REMOVE.name](data, socket) {
        let { stack, key } = data.item;
        let itemInfo = this.getItemInfo(key);
        if (!this.middleware.isMisc(itemInfo)) {
            for (let slot = 0; slot < socket.character.items.length; slot++) {
                let item = socket.character.items[slot];
                if (item.key === key) {
                    this.deleteItem(socket, slot);
                    if (--stack === 0) {
                        break;
                    }
                }
            }
        }
    }
    deleteItem(socket, slot) {
        socket.character.items.set(slot, {});
        socket.emit(this.CLIENT_GETS.ITEM_DELETE.name, { slot });
    }
    [config.SERVER_GETS.ITEM_DROP.name](data, socket) {
        let slot = data.slot;
        if (!this.middleware.hasItem(socket, slot)) {
            this.sendError(data, socket, "Trying to drop an item but nothing's there!");
        }
        else {
            let item = socket.character.items[slot];
            this.emitter.emit(dropsConfig.SERVER_INNER.ITEMS_DROP.name, {}, socket, [item]);
            this.deleteItem(socket, slot);
        }
    }
    [config.SERVER_GETS.ITEM_MOVE.name](data, socket) {
        if (!this.middleware.isValidItemSlot(data.from)
            || !this.middleware.isValidItemSlot(data.to)) {
            this.sendError(data, socket, "Invalid slots!");
        }
        else {
            let itemFrom = socket.character.items[data.from];
            let itemTo = socket.character.items[data.to];
            socket.character.items.set(data.to, itemFrom);
            socket.character.items.set(data.from, itemTo);
            socket.emit(this.CLIENT_GETS.ITEM_MOVE.name, {
                id: socket.character._id,
                from: data.from,
                to: data.to
            });
        }
    }
}
exports.default = ItemsRouter;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NlcnZlci9saWIvaXRlbXMvaXRlbXMucm91dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7QUFDYiwyRUFBa0U7QUFJbEUsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLDZDQUE2QyxDQUFDLENBQUM7QUFDekUsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLDZDQUE2QyxDQUFDLENBQUM7QUFFcEUsaUJBQWlDLFNBQVEsOEJBQWtCO0lBSzFELElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRztRQUNkLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQztRQUMvQixLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztJQUN4QixDQUFDO0lBRVMsVUFBVSxDQUFDLEdBQUc7UUFDdkIsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFDNUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUMxRCxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVNLFdBQVcsQ0FBQyxHQUFXO1FBQzdCLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBRU0sZUFBZSxDQUFDLEdBQVc7UUFDakMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzNDLENBQUM7SUFFTSxjQUFjLENBQUMsTUFBa0I7UUFDdkMsSUFBSSxHQUFHLEdBQWlCLElBQUksR0FBRyxFQUFFLENBQUM7UUFDbEMsR0FBRyxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FB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QUssQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7WUFFN0MsTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDOUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFDOUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUU7Z0JBQzVDLEVBQUUsRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUc7Z0JBQ3hCLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtnQkFDZixFQUFFLEVBQUUsSUFBSSxDQUFDLEVBQUU7YUFDWCxDQUFDLENBQUM7UUFDSixDQUFDO0lBQ0YsQ0FBQztDQUNEO0FBL0dELDhCQStHQztBQUFBLENBQUMiLCJmaWxlIjoibGliL2l0ZW1zL2l0ZW1zLnJvdXRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcbmltcG9ydCBTb2NrZXRpb1JvdXRlckJhc2UgZnJvbSAnLi4vc29ja2V0aW8vc29ja2V0aW8ucm91dGVyLmJhc2UnO1xuaW1wb3J0IEl0ZW1zTWlkZGxld2FyZSBmcm9tIFwiLi9pdGVtcy5taWRkbGV3YXJlXCI7XG5pbXBvcnQgSXRlbXNDb250cm9sbGVyIGZyb20gJy4vaXRlbXMuY29udHJvbGxlcic7XG5pbXBvcnQgSXRlbXNTZXJ2aWNlcyBmcm9tICcuL2l0ZW1zLnNlcnZpY2VzJztcbmxldCBkcm9wc0NvbmZpZyA9IHJlcXVpcmUoJy4uLy4uLy4uL3NlcnZlci9saWIvZHJvcHMvZHJvcHMuY29uZmlnLmpzb24nKTtcbmxldCBjb25maWcgPSByZXF1aXJlKCcuLi8uLi8uLi9zZXJ2ZXIvbGliL2l0ZW1zL2l0ZW1zLmNvbmZpZy5qc29uJyk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEl0ZW1zUm91dGVyIGV4dGVuZHMgU29ja2V0aW9Sb3V0ZXJCYXNlIHtcblx0cHJvdGVjdGVkIG1pZGRsZXdhcmU6IEl0ZW1zTWlkZGxld2FyZTtcblx0cHJvdGVjdGVkIGNvbnRyb2xsZXI6IEl0ZW1zQ29udHJvbGxlcjtcblx0cHJvdGVjdGVkIHNlcnZpY2VzOiBJdGVtc1NlcnZpY2VzO1xuXG5cdGluaXQoZmlsZXMsIGFwcCkge1xuXHRcdHRoaXMuc2VydmljZXMgPSBmaWxlcy5zZXJ2aWNlcztcblx0XHRzdXBlci5pbml0KGZpbGVzLCBhcHApO1xuXHR9XG5cblx0cHJvdGVjdGVkIGluaXRSb3V0ZXMoYXBwKSB7XG5cdFx0YXBwLnBvc3QodGhpcy5ST1VURVMuR0VORVJBVEUsXG5cdFx0XHR0aGlzLm1pZGRsZXdhcmUudmFsaWRhdGVIYXNTZXJjZXRLZXkuYmluZCh0aGlzLm1pZGRsZXdhcmUpLFxuXHRcdFx0dGhpcy5jb250cm9sbGVyLmdlbmVyYXRlSXRlbXMuYmluZCh0aGlzLmNvbnRyb2xsZXIpKTtcblx0fVxuXG5cdHB1YmxpYyBnZXRJdGVtSW5mbyhrZXk6IHN0cmluZyk6IElURU1fTU9ERUx8dW5kZWZpbmVkIHtcblx0XHRyZXR1cm4gdGhpcy5zZXJ2aWNlcy5nZXRJdGVtSW5mbyhrZXkpO1xuXHR9XG5cblx0cHVibGljIGdldEl0ZW1JbnN0YW5jZShrZXk6IHN0cmluZyk6IElURU1fSU5TVEFOQ0V8dW5kZWZpbmVkIHtcblx0XHRyZXR1cm4gdGhpcy5zZXJ2aWNlcy5nZXRJdGVtSW5zdGFuY2Uoa2V5KTtcblx0fVxuXG5cdHB1YmxpYyBnZXRJdGVtc0NvdW50cyhzb2NrZXQ6IEdhbWVTb2NrZXQpIHtcblx0XHRsZXQgbWFwOiBJVEVNU19DT1VOVFMgPSBuZXcgTWFwKCk7XG5cdFx0Zm9yIChsZXQgaXRlbSBvZiBzb2NrZXQuY2hhcmFjdGVyLml0ZW1zKSB7XG5cdFx0XHRsZXQgY3VycmVudENvdW50ID0gbWFwLmdldChpdGVtLmtleSkgfHwgMDtcblx0XHRcdG1hcC5zZXQoaXRlbS5rZXksIGN1cnJlbnRDb3VudCArIChpdGVtLnN0YWNrIHx8IDEpKTtcblx0XHR9XG5cdFx0cmV0dXJuIG1hcDtcblx0fVxuXG5cdHB1YmxpYyBnZXRJdGVtc1Nsb3RzKHNvY2tldDogR2FtZVNvY2tldCwgaXRlbXM6IElURU1fSU5TVEFOQ0VbXSk6IGZhbHNlfHtba2V5OiBzdHJpbmddOiBudW1iZXJbXX0ge1xuXHRcdHJldHVybiB0aGlzLm1pZGRsZXdhcmUuZ2V0SXRlbXNTbG90cyhzb2NrZXQsIGl0ZW1zKTtcblx0fVxuXG5cdFtjb25maWcuU0VSVkVSX0dFVFMuSVRFTV9QSUNLLm5hbWVdKGRhdGEsIHNvY2tldDogR2FtZVNvY2tldCkge1xuXHRcdHRoaXMuZW1pdHRlci5lbWl0KGRyb3BzQ29uZmlnLlNFUlZFUl9JTk5FUi5JVEVNX1BJQ0submFtZSwgZGF0YSwgc29ja2V0LCAoaXRlbTogSVRFTV9JTlNUQU5DRSk6IGFueSA9PiB7XG5cdFx0XHRsZXQgaXRlbUluZm8gPSB0aGlzLmdldEl0ZW1JbmZvKGl0ZW0ua2V5KTtcbiAgICAgICAgICAgIGlmIChpdGVtSW5mby5jYXAgPiAxKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGV0IHNsb3QgPSB0aGlzLm1pZGRsZXdhcmUuZ2V0Rmlyc3RBdmFpbGFibGVTbG90KHNvY2tldCk7XG5cdFx0XHRpZiAoIShzbG90ID49IDApKSB7IFxuXHRcdFx0XHR0aGlzLnNlbmRFcnJvcihkYXRhLCBzb2NrZXQsIGNvbmZpZy5MT0dTLklOVkVOVE9SWV9GVUxMLk1TRywgdHJ1ZSwgdHJ1ZSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0aGlzW2NvbmZpZy5TRVJWRVJfSU5ORVIuSVRFTV9BREQubmFtZV0oe3Nsb3RzOiBbc2xvdF0sIGl0ZW19LCBzb2NrZXQpO1xuXHRcdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHRcdH1cdFxuXHRcdH0pO1xuXHR9XG5cblx0W2NvbmZpZy5TRVJWRVJfSU5ORVIuSVRFTV9BREQubmFtZV0oZGF0YToge3Nsb3RzOiBudW1iZXJbXSwgaXRlbTogSVRFTV9JTlNUQU5DRX0sIHNvY2tldDogR2FtZVNvY2tldCkge1xuXHRcdGxldCB7c2xvdHMsIGl0ZW19ID0gZGF0YTtcblx0XHRsZXQgaXRlbUluZm8gPSB0aGlzLmdldEl0ZW1JbmZvKGl0ZW0ua2V5KTtcblx0XHRpZiAoIXRoaXMubWlkZGxld2FyZS5pc0dvbGQoaXRlbSkgJiYgIXRoaXMubWlkZGxld2FyZS5pc01pc2MoaXRlbUluZm8pKSB7XG5cdFx0XHRzb2NrZXQuY2hhcmFjdGVyLml0ZW1zLnNldChzbG90c1swXSwgaXRlbSk7XG5cdFx0XHRzb2NrZXQuZW1pdCh0aGlzLkNMSUVOVF9HRVRTLklURU1fQURELm5hbWUsIHsgc2xvdDogc2xvdHNbMF0sIGl0ZW0gfSk7XG5cdFx0fVxuXHR9XG5cblx0W2NvbmZpZy5TRVJWRVJfSU5ORVIuSVRFTV9SRU1PVkUubmFtZV0oZGF0YToge2l0ZW06IElURU1fSU5TVEFOQ0V9LCBzb2NrZXQ6IEdhbWVTb2NrZXQpIHtcblx0XHRsZXQge3N0YWNrLCBrZXl9ID0gZGF0YS5pdGVtO1xuXHRcdGxldCBpdGVtSW5mbyA9IHRoaXMuZ2V0SXRlbUluZm8oa2V5KTtcblx0XHRpZiAoIXRoaXMubWlkZGxld2FyZS5pc01pc2MoaXRlbUluZm8pKSB7XG5cdFx0XHRmb3IgKGxldCBzbG90ID0gMDsgc2xvdCA8IHNvY2tldC5jaGFyYWN0ZXIuaXRlbXMubGVuZ3RoOyBzbG90KyspIHtcblx0XHRcdFx0bGV0IGl0ZW0gPSBzb2NrZXQuY2hhcmFjdGVyLml0ZW1zW3Nsb3RdO1xuXHRcdFx0XHRpZiAoaXRlbS5rZXkgPT09IGtleSkge1xuXHRcdFx0XHRcdHRoaXMuZGVsZXRlSXRlbShzb2NrZXQsIHNsb3QpO1xuXHRcdFx0XHRcdGlmICgtLXN0YWNrID09PSAwKSB7XG5cdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgZGVsZXRlSXRlbShzb2NrZXQ6IEdhbWVTb2NrZXQsIHNsb3Q6IG51bWJlcikge1xuXHRcdHNvY2tldC5jaGFyYWN0ZXIuaXRlbXMuc2V0KHNsb3QsIHt9KTtcblx0XHRzb2NrZXQuZW1pdCh0aGlzLkNMSUVOVF9HRVRTLklURU1fREVMRVRFLm5hbWUsIHsgc2xvdCB9KTtcblx0fVxuXG5cdFtjb25maWcuU0VSVkVSX0dFVFMuSVRFTV9EUk9QLm5hbWVdKGRhdGEsIHNvY2tldDogR2FtZVNvY2tldCkge1xuXHRcdGxldCBzbG90ID0gZGF0YS5zbG90O1xuXHRcdGlmICghdGhpcy5taWRkbGV3YXJlLmhhc0l0ZW0oc29ja2V0LCBzbG90KSkge1xuXHRcdFx0dGhpcy5zZW5kRXJyb3IoZGF0YSwgc29ja2V0LCBcIlRyeWluZyB0byBkcm9wIGFuIGl0ZW0gYnV0IG5vdGhpbmcncyB0aGVyZSFcIik7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGxldCBpdGVtID0gc29ja2V0LmNoYXJhY3Rlci5pdGVtc1tzbG90XTtcblx0XHRcdHRoaXMuZW1pdHRlci5lbWl0KGRyb3BzQ29uZmlnLlNFUlZFUl9JTk5FUi5JVEVNU19EUk9QLm5hbWUsIHt9LCBzb2NrZXQsIFtpdGVtXSk7XG5cdFx0XHR0aGlzLmRlbGV0ZUl0ZW0oc29ja2V0LCBzbG90KTtcblx0XHR9XG5cdH1cblxuXHRbY29uZmlnLlNFUlZFUl9HRVRTLklURU1fTU9WRS5uYW1lXShkYXRhLCBzb2NrZXQ6IEdhbWVTb2NrZXQpIHtcblx0XHRpZiAoIXRoaXMubWlkZGxld2FyZS5pc1ZhbGlkSXRlbVNsb3QoZGF0YS5mcm9tKVxuXHRcdCBcdHx8ICF0aGlzLm1pZGRsZXdhcmUuaXNWYWxpZEl0ZW1TbG90KGRhdGEudG8pKSB7XG5cdFx0XHR0aGlzLnNlbmRFcnJvcihkYXRhLCBzb2NrZXQsIFwiSW52YWxpZCBzbG90cyFcIik7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGxldCBpdGVtRnJvbSA9IHNvY2tldC5jaGFyYWN0ZXIuaXRlbXNbZGF0YS5mcm9tXTtcblx0XHRcdGxldCBpdGVtVG8gPSBzb2NrZXQuY2hhcmFjdGVyLml0ZW1zW2RhdGEudG9dO1xuXG5cdFx0XHRzb2NrZXQuY2hhcmFjdGVyLml0ZW1zLnNldChkYXRhLnRvLCBpdGVtRnJvbSk7XG5cdFx0XHRzb2NrZXQuY2hhcmFjdGVyLml0ZW1zLnNldChkYXRhLmZyb20sIGl0ZW1Ubyk7XG5cdFx0XHRzb2NrZXQuZW1pdCh0aGlzLkNMSUVOVF9HRVRTLklURU1fTU9WRS5uYW1lLCB7XG5cdFx0XHRcdGlkOiBzb2NrZXQuY2hhcmFjdGVyLl9pZCxcblx0XHRcdFx0ZnJvbTogZGF0YS5mcm9tLFxuXHRcdFx0XHR0bzogZGF0YS50b1xuXHRcdFx0fSk7XG5cdFx0fVxuXHR9XG59O1xuIl19
