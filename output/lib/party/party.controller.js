'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const master_controller_1 = require("../master/master.controller");
let config = require('../../../server/lib/party/party.config.json');
class PartyController extends master_controller_1.default {
    constructor() {
        super(...arguments);
        this.charToParty = new Map();
    }
    init(files, app) {
        this.middleware = files.middleware;
        super.init(files, app);
    }
    getCharParty(socket) {
        return this.getParty(socket.character.name);
    }
    getParty(name) {
        return this.charToParty.get(name);
        ;
    }
    createParty(socket) {
        socket.emit(config.CLIENT_GETS.CREATE_PARTY.name, {});
        let party = {
            name: this.services.getPartyName(),
            leader: socket.character.name,
            members: new Set(),
            invitees: new Map(),
        };
        this.charToParty.set(socket.character.name, party);
        socket.join(party.name);
    }
    inviteToParty(inviteeSocket, party) {
        inviteeSocket.emit(config.CLIENT_GETS.INVITE_TO_PARTY.name, {});
        party.invitees.set(inviteeSocket.character.name, setTimeout(() => {
            party.invitees.delete(inviteeSocket.character.name);
        }, config.INVITE_EXPIRE_TIME));
    }
    joinParty(socket, party) {
        socket.join(party.name);
        this.io.to(party.name).emit(config.CLIENT_GETS.JOIN_PARTY.name, {
            char_name: socket.character.name
        });
        this.tellPartyMembers(socket, party);
        this.charToParty.set(socket.character.name, party);
        party.members.add(socket.character.name);
        clearTimeout(party.invitees.get(socket.character.name));
        party.invitees.delete(socket.character.name);
    }
    leaveParty(socket, party) {
        this.io.to(party.name).emit(config.CLIENT_GETS.LEAVE_PARTY.name, {
            char_name: socket.character.name
        });
        socket.leave(party.name);
        if (this.middleware.isLeader(socket.character.name, party)) {
            if (party.members.size > 0) {
                party.leader = this.services.pickLeader(socket, party);
                this.io.to(party.name).emit(config.CLIENT_GETS.LEAD_PARTY.name, {
                    char_name: party.leader
                });
            }
            else {
                for (let [, timeout] of party.invitees) {
                    clearTimeout(timeout);
                }
            }
        }
        else {
            party.members.delete(socket.character.name);
        }
        this.charToParty.delete(socket.character.name);
    }
    makeLeader(socket, charName, party) {
        this.io.to(party.name).emit(config.CLIENT_GETS.LEAD_PARTY.name, {
            char_name: charName
        });
        party.leader = charName;
        party.members.delete(charName);
        party.members.add(socket.character.name);
    }
    kickFromParty(socket, charName, party) {
        this.io.to(party.name).emit(config.CLIENT_GETS.KICK_FROM_PARTY.name, {
            char_name: charName
        });
        let kickedSocket = socket.map.get(charName);
        if (kickedSocket) {
            kickedSocket.leave(party.name);
        }
        party.members.delete(charName);
        this.charToParty.delete(charName);
    }
    tellPartyMembers(socket, party) {
        socket.emit(config.CLIENT_GETS.PARTY_MEMBERS.name, {
            leader_name: party.leader,
            chars_names: Array.from(party.members)
        });
    }
    getPartyMembersInMap(socket) {
        let sockets = [];
        let party = this.getCharParty(socket);
        if (!party) {
            sockets.push(socket);
        }
        else {
            let allPartyMembers = this.services.getAllPartyMembers(party);
            for (let memberName of allPartyMembers) {
                let memberSocket = socket.map.get(memberName);
                if (memberSocket && memberSocket.character.room === socket.character.room && memberSocket.alive) {
                    sockets.push(memberSocket);
                }
            }
        }
        return sockets;
    }
    arePartyMembers(name1, name2) {
        let areMembers = false;
        let party = this.getParty(name1);
        if (party) {
            areMembers = this.middleware.isInParty(name2, party);
        }
        return areMembers;
    }
}
exports.default = PartyController;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NlcnZlci9saWIvcGFydHkvcGFydHkuY29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7O0FBQ2IsbUVBQTJEO0FBRzNELElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO0FBRXBFLHFCQUFxQyxTQUFRLDJCQUFnQjtJQUE3RDs7UUFHWSxnQkFBVyxHQUE2QixJQUFJLEdBQUcsRUFBRSxDQUFDO0lBbUk5RCxDQUFDO0lBaklBLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRztRQUNkLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQztRQUNuQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztJQUN4QixDQUFDO0lBRVMsWUFBWSxDQUFDLE1BQWtCO1FBQ2xDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEQsQ0FBQztJQUVNLFFBQVEsQ0FBQyxJQUFZO1FBQ3hCLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUFBLENBQUM7SUFDdkMsQ0FBQztJQUVNLFdBQVcsQ0FBQyxNQUFrQjtRQUNqQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN0RCxJQUFJLEtBQUssR0FBZ0I7WUFDckIsSUFBSSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxFQUFFO1lBQ2xDLE1BQU0sRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUk7WUFDN0IsT0FBTyxFQUFFLElBQUksR0FBRyxFQUFFO1lBQ2xCLFFBQVEsRUFBRSxJQUFJLEdBQUcsRUFBRTtTQUN0QixDQUFDO1FBQ0YsSUFBSSxDQUFDLFdBQVcsQ0FBQyxH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LEtBQUssTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLElBQUksWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7b0JBQzlGLE9BQU8sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBQy9CLENBQUM7WUFDTCxDQUFDO1FBQ0wsQ0FBQztRQUNELE1BQU0sQ0FBQyxPQUFPLENBQUM7SUFDbkIsQ0FBQztJQUVNLGVBQWUsQ0FBQyxLQUFhLEVBQUUsS0FBYTtRQUMvQyxJQUFJLFVBQVUsR0FBRyxLQUFLLENBQUM7UUFDdkIsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNqQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ1IsVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN6RCxDQUFDO1FBQ0QsTUFBTSxDQUFDLFVBQVUsQ0FBQztJQUN0QixDQUFDO0NBQ0o7QUF0SUQsa0NBc0lDO0FBQUEsQ0FBQyIsImZpbGUiOiJsaWIvcGFydHkvcGFydHkuY29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcbmltcG9ydCBNYXN0ZXJDb250cm9sbGVyIGZyb20gJy4uL21hc3Rlci9tYXN0ZXIuY29udHJvbGxlcic7XG5pbXBvcnQgUGFydHlTZXJ2aWNlcyBmcm9tICcuL3BhcnR5LnNlcnZpY2VzJztcbmltcG9ydCBQYXJ0eU1pZGRsZXdhcmUgZnJvbSAnLi9wYXJ0eS5taWRkbGV3YXJlJztcbmxldCBjb25maWcgPSByZXF1aXJlKCcuLi8uLi8uLi9zZXJ2ZXIvbGliL3BhcnR5L3BhcnR5LmNvbmZpZy5qc29uJyk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBhcnR5Q29udHJvbGxlciBleHRlbmRzIE1hc3RlckNvbnRyb2xsZXIge1xuICAgIHByb3RlY3RlZCBzZXJ2aWNlczogUGFydHlTZXJ2aWNlcztcbiAgICBwcm90ZWN0ZWQgbWlkZGxld2FyZTogUGFydHlNaWRkbGV3YXJlO1xuICAgIHByaXZhdGUgY2hhclRvUGFydHk6IE1hcDxzdHJpbmcsIFBBUlRZX01PREVMPiA9IG5ldyBNYXAoKTtcblxuXHRpbml0KGZpbGVzLCBhcHApIHtcblx0XHR0aGlzLm1pZGRsZXdhcmUgPSBmaWxlcy5taWRkbGV3YXJlO1xuXHRcdHN1cGVyLmluaXQoZmlsZXMsIGFwcCk7XG5cdH1cblxuICAgIHB1YmxpYyBnZXRDaGFyUGFydHkoc29ja2V0OiBHYW1lU29ja2V0KTogUEFSVFlfTU9ERUx8dW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UGFydHkoc29ja2V0LmNoYXJhY3Rlci5uYW1lKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0UGFydHkobmFtZTogc3RyaW5nKTogUEFSVFlfTU9ERUx8dW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2hhclRvUGFydHkuZ2V0KG5hbWUpOztcbiAgICB9XG5cbiAgICBwdWJsaWMgY3JlYXRlUGFydHkoc29ja2V0OiBHYW1lU29ja2V0KSB7XG4gICAgICAgIHNvY2tldC5lbWl0KGNvbmZpZy5DTElFTlRfR0VUUy5DUkVBVEVfUEFSVFkubmFtZSwge30pO1xuICAgICAgICBsZXQgcGFydHk6IFBBUlRZX01PREVMID0ge1xuICAgICAgICAgICAgbmFtZTogdGhpcy5zZXJ2aWNlcy5nZXRQYXJ0eU5hbWUoKSxcbiAgICAgICAgICAgIGxlYWRlcjogc29ja2V0LmNoYXJhY3Rlci5uYW1lLFxuICAgICAgICAgICAgbWVtYmVyczogbmV3IFNldCgpLFxuICAgICAgICAgICAgaW52aXRlZXM6IG5ldyBNYXAoKSxcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5jaGFyVG9QYXJ0eS5zZXQoc29ja2V0LmNoYXJhY3Rlci5uYW1lLCBwYXJ0eSk7XG4gICAgICAgIHNvY2tldC5qb2luKHBhcnR5Lm5hbWUpO1xuICAgIH1cblxuICAgIHB1YmxpYyBpbnZpdGVUb1BhcnR5KGludml0ZWVTb2NrZXQ6IEdhbWVTb2NrZXQsIHBhcnR5OiBQQVJUWV9NT0RFTCkge1xuICAgICAgICBpbnZpdGVlU29ja2V0LmVtaXQoY29uZmlnLkNMSUVOVF9HRVRTLklOVklURV9UT19QQVJUWS5uYW1lLCB7fSk7XG4gICAgICAgIHBhcnR5Lmludml0ZWVzLnNldChpbnZpdGVlU29ja2V0LmNoYXJhY3Rlci5uYW1lLCBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgaW52aXRhdGlvbiBhZnRlciBhIGNlcnRhaW4gYW1vdW50IG9mIHRpbWVcbiAgICAgICAgICAgIHBhcnR5Lmludml0ZWVzLmRlbGV0ZShpbnZpdGVlU29ja2V0LmNoYXJhY3Rlci5uYW1lKTtcbiAgICAgICAgfSwgY29uZmlnLklOVklURV9FWFBJUkVfVElNRSkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBqb2luUGFydHkoc29ja2V0OiBHYW1lU29ja2V0LCBwYXJ0eTogUEFSVFlfTU9ERUwpIHtcbiAgICAgICAgc29ja2V0LmpvaW4ocGFydHkubmFtZSk7XG5cbiAgICAgICAgdGhpcy5pby50byhwYXJ0eS5uYW1lKS5lbWl0KGNvbmZpZy5DTElFTlRfR0VUUy5KT0lOX1BBUlRZLm5hbWUsIHtcbiAgICAgICAgICAgIGNoYXJfbmFtZTogc29ja2V0LmNoYXJhY3Rlci5uYW1lXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnRlbGxQYXJ0eU1lbWJlcnMoc29ja2V0LCBwYXJ0eSk7XG5cbiAgICAgICAgdGhpcy5jaGFyVG9QYXJ0eS5zZXQoc29ja2V0LmNoYXJhY3Rlci5uYW1lLCBwYXJ0eSk7XG4gICAgICAgIHBhcnR5Lm1lbWJlcnMuYWRkKHNvY2tldC5jaGFyYWN0ZXIubmFtZSk7XG4gICAgICAgIGNsZWFyVGltZW91dChwYXJ0eS5pbnZpdGVlcy5nZXQoc29ja2V0LmNoYXJhY3Rlci5uYW1lKSk7XG4gICAgICAgIHBhcnR5Lmludml0ZWVzLmRlbGV0ZShzb2NrZXQuY2hhcmFjdGVyLm5hbWUpO1xuICAgIH1cblxuICAgIHB1YmxpYyBsZWF2ZVBhcnR5KHNvY2tldDogR2FtZVNvY2tldCwgcGFydHk6IFBBUlRZX01PREVMKSB7XG4gICAgICAgIHRoaXMuaW8udG8ocGFydHkubmFtZSkuZW1pdChjb25maWcuQ0xJRU5UX0dFVFMuTEVBVkVfUEFSVFkubmFtZSwge1xuICAgICAgICAgICAgY2hhcl9uYW1lOiBzb2NrZXQuY2hhcmFjdGVyLm5hbWVcbiAgICAgICAgfSk7XG4gICAgICAgIHNvY2tldC5sZWF2ZShwYXJ0eS5uYW1lKTtcblxuICAgICAgICBpZiAodGhpcy5taWRkbGV3YXJlLmlzTGVhZGVyKHNvY2tldC5jaGFyYWN0ZXIubmFtZSwgcGFydHkpKSB7XG4gICAgICAgICAgICBpZiAocGFydHkubWVtYmVycy5zaXplID4gMCkge1xuICAgICAgICAgICAgICAgIHBhcnR5LmxlYWRlciA9IHRoaXMuc2VydmljZXMucGlja0xlYWRlcihzb2NrZXQsIHBhcnR5KTtcbiAgICAgICAgICAgICAgICB0aGlzLmlvLnRvKHBhcnR5Lm5hbWUpLmVtaXQoY29uZmlnLkNMSUVOVF9HRVRTLkxFQURfUEFSVFkubmFtZSwge1xuICAgICAgICAgICAgICAgICAgICBjaGFyX25hbWU6IHBhcnR5LmxlYWRlclxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBwYXJ0eSBpcyBkaXNiYW5kZWQuIFxuICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBwZW5kaW5nIGludml0YXRpb25zXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgWywgdGltZW91dF0gb2YgcGFydHkuaW52aXRlZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHBhcnR5Lm1lbWJlcnMuZGVsZXRlKHNvY2tldC5jaGFyYWN0ZXIubmFtZSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNoYXJUb1BhcnR5LmRlbGV0ZShzb2NrZXQuY2hhcmFjdGVyLm5hbWUpO1xuICAgIH1cblxuICAgIHB1YmxpYyBtYWtlTGVhZGVyKHNvY2tldDogR2FtZVNvY2tldCwgY2hhck5hbWU6IHN0cmluZywgcGFydHk6IFBBUlRZX01PREVMKSB7XG4gICAgICAgIHRoaXMuaW8udG8ocGFydHkubmFtZSkuZW1pdChjb25maWcuQ0xJRU5UX0dFVFMuTEVBRF9QQVJUWS5uYW1lLCB7XG4gICAgICAgICAgICBjaGFyX25hbWU6IGNoYXJOYW1lXG4gICAgICAgIH0pO1xuICAgICAgICBwYXJ0eS5sZWFkZXIgPSBjaGFyTmFtZTtcbiAgICAgICAgcGFydHkubWVtYmVycy5kZWxldGUoY2hhck5hbWUpO1xuICAgICAgICBwYXJ0eS5tZW1iZXJzLmFkZChzb2NrZXQuY2hhcmFjdGVyLm5hbWUpO1xuICAgIH1cblxuICAgIHB1YmxpYyBraWNrRnJvbVBhcnR5KHNvY2tldDogR2FtZVNvY2tldCwgY2hhck5hbWU6IHN0cmluZywgcGFydHk6IFBBUlRZX01PREVMKSB7XG4gICAgICAgIHRoaXMuaW8udG8ocGFydHkubmFtZSkuZW1pdChjb25maWcuQ0xJRU5UX0dFVFMuS0lDS19GUk9NX1BBUlRZLm5hbWUsIHtcbiAgICAgICAgICAgIGNoYXJfbmFtZTogY2hhck5hbWVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IGtpY2tlZFNvY2tldCA9IHNvY2tldC5tYXAuZ2V0KGNoYXJOYW1lKTtcbiAgICAgICAgaWYgKGtpY2tlZFNvY2tldCkge1xuICAgICAgICAgICAgLy8gcGFydHkgbWVtYmVyIGlzIG9ubGluZSAtIHJlbW92ZSBoaW1cbiAgICAgICAgICAgIGtpY2tlZFNvY2tldC5sZWF2ZShwYXJ0eS5uYW1lKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcGFydHkubWVtYmVycy5kZWxldGUoY2hhck5hbWUpO1xuICAgICAgICB0aGlzLmNoYXJUb1BhcnR5LmRlbGV0ZShjaGFyTmFtZSk7XG4gICAgfVxuXG4gICAgcHVibGljIHRlbGxQYXJ0eU1lbWJlcnMoc29ja2V0OiBHYW1lU29ja2V0LCBwYXJ0eTogUEFSVFlfTU9ERUwpIHtcbiAgICAgICAgc29ja2V0LmVtaXQoY29uZmlnLkNMSUVOVF9HRVRTLlBBUlRZX01FTUJFUlMubmFtZSwge1xuICAgICAgICAgICAgbGVhZGVyX25hbWU6IHBhcnR5LmxlYWRlcixcbiAgICAgICAgICAgIGNoYXJzX25hbWVzOiBBcnJheS5mcm9tKHBhcnR5Lm1lbWJlcnMpXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRQYXJ0eU1lbWJlcnNJbk1hcChzb2NrZXQ6IEdhbWVTb2NrZXQpOiBHYW1lU29ja2V0W10ge1xuICAgICAgICBsZXQgc29ja2V0cyA9IFtdO1xuICAgICAgICBsZXQgcGFydHkgPSB0aGlzLmdldENoYXJQYXJ0eShzb2NrZXQpO1xuICAgICAgICBpZiAoIXBhcnR5KSB7XG4gICAgICAgICAgICBzb2NrZXRzLnB1c2goc29ja2V0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxldCBhbGxQYXJ0eU1lbWJlcnMgPSB0aGlzLnNlcnZpY2VzLmdldEFsbFBhcnR5TWVtYmVycyhwYXJ0eSk7XG4gICAgICAgICAgICBmb3IgKGxldCBtZW1iZXJOYW1lIG9mIGFsbFBhcnR5TWVtYmVycykge1xuICAgICAgICAgICAgICAgIGxldCBtZW1iZXJTb2NrZXQgPSBzb2NrZXQubWFwLmdldChtZW1iZXJOYW1lKTtcbiAgICAgICAgICAgICAgICBpZiAobWVtYmVyU29ja2V0ICYmIG1lbWJlclNvY2tldC5jaGFyYWN0ZXIucm9vbSA9PT0gc29ja2V0LmNoYXJhY3Rlci5yb29tICYmIG1lbWJlclNvY2tldC5hbGl2ZSkge1xuICAgICAgICAgICAgICAgICAgICBzb2NrZXRzLnB1c2gobWVtYmVyU29ja2V0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNvY2tldHM7XG4gICAgfVxuXG4gICAgcHVibGljIGFyZVBhcnR5TWVtYmVycyhuYW1lMTogc3RyaW5nLCBuYW1lMjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGxldCBhcmVNZW1iZXJzID0gZmFsc2U7XG4gICAgICAgIGxldCBwYXJ0eSA9IHRoaXMuZ2V0UGFydHkobmFtZTEpO1xuICAgICAgICBpZiAocGFydHkpIHtcbiAgICAgICAgICAgIGFyZU1lbWJlcnMgPSB0aGlzLm1pZGRsZXdhcmUuaXNJblBhcnR5KG5hbWUyLCBwYXJ0eSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFyZU1lbWJlcnM7XG4gICAgfVxufTsiXX0=
