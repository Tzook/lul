'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const socketio_router_base_1 = require("../socketio/socketio.router.base");
let config = require('../../../server/lib/equips/equips.config.json');
let dropsConfig = require('../../../server/lib/drops/drops.config.json');
let statsConfig = require('../../../server/lib/stats/stats.config.json');
let SERVER_GETS = config.SERVER_GETS;
class EquipsRouter extends socketio_router_base_1.default {
    init(files, app) {
        super.init(files, app);
        this.mongoose = files.model.mongoose;
        this.itemsRouter = files.routers.items;
    }
    initRoutes(app) {
        app.post(this.ROUTES.BEGIN, this.middleware.validateHasSercetKey.bind(this.middleware), this.controller.beginEquips.bind(this.controller));
    }
    [SERVER_GETS.EQUIP_ITEM.name](data, socket) {
        let from = data.from;
        let to = data.to;
        if (this.middleware.isValidItemSlot(from)
            && this.middleware.isValidEquipSlot(to)
            && this.middleware.hasItem(socket, from)) {
            let item = socket.character.items[from];
            let itemInfo = this.itemsRouter.getItemInfo(item.key);
            if (!itemInfo) {
                this.sendError(data, socket, "Could not find item info for item " + item.key);
            }
            else if (!this.middleware.canWearEquip(socket, itemInfo, to)) {
                this.sendError(data, socket, "Item cannot be equipped there");
            }
            else {
                this.removeStats(to, socket);
                this.middleware.swapEquipAndItem(socket, from, to);
                this.addStats(to, socket);
                this.io.to(socket.character.room).emit(this.CLIENT_GETS.EQUIP_ITEM.name, {
                    id: socket.character._id,
                    from,
                    to,
                    equipped_item: item,
                });
            }
        }
        else {
            this.sendError(data, socket, "Invalid slots!");
        }
    }
    [SERVER_GETS.UNEQUIP_ITEM.name](data, socket) {
        let from = data.from;
        let to = data.to;
        if (this.middleware.isValidEquipSlot(from)
            && this.middleware.isValidItemSlot(to)
            && this.middleware.hasEquip(socket, from)) {
            if (this.middleware.hasItem(socket, to)
                && !this.middleware.canWearEquip(socket, this.itemsRouter.getItemInfo(socket.character.items[to].key), from)) {
                this.sendError(data, socket, "Cannot unequip to slot!");
            }
            else {
                this.removeStats(from, socket);
                this.middleware.swapEquipAndItem(socket, to, from);
                this.addStats(from, socket);
                this.io.to(socket.character.room).emit(this.CLIENT_GETS.UNEQUIP_ITEM.name, {
                    id: socket.character._id,
                    from,
                    to,
                    equipped_item: socket.character.equips[from],
                });
            }
        }
        else {
            this.sendError(data, socket, "Invalid slots!");
        }
    }
    [SERVER_GETS.USE_EQUIP.name](data, socket) {
        let slot = this.middleware.getFirstAvailableSlot(socket);
        if (slot >= 0) {
            this[SERVER_GETS.UNEQUIP_ITEM.name]({
                from: data.slot,
                to: slot
            }, socket);
        }
        else {
            this.sendError(data, socket, "Cannot unequip to slot!");
        }
    }
    [SERVER_GETS.USE_ITEM.name](data, socket) {
        let itemSlot = data.slot;
        if (this.middleware.isValidItemSlot(itemSlot)) {
            let item = socket.character.items[itemSlot];
            let itemInfo = this.itemsRouter.getItemInfo(item.key);
            if (!itemInfo) {
                this.sendError(data, socket, "Could not find item info for item " + item.key);
            }
            else if (this.middleware.isValidEquipItem(itemInfo)) {
                this[SERVER_GETS.EQUIP_ITEM.name]({
                    from: itemSlot,
                    to: itemInfo.type
                }, socket);
            }
            else {
                this.sendError(data, socket, "Item not equipable!");
            }
        }
        else {
            this.sendError(data, socket, "Invalid slot!");
        }
    }
    [SERVER_GETS.DROP_EQUIP.name](data, socket) {
        let slot = data.slot;
        if (this.middleware.hasEquip(socket, slot)) {
            let equip = socket.character.equips[slot];
            this.emitter.emit(dropsConfig.SERVER_INNER.ITEMS_DROP.name, {}, socket, [equip]);
            this.removeStats(slot, socket);
            let ItemsModels = this.mongoose.model("Item");
            socket.character.equips[slot] = new ItemsModels({});
            this.io.to(socket.character.room).emit(this.CLIENT_GETS.DELETE_EQUIP.name, {
                id: socket.character._id,
                slot
            });
        }
        else {
            this.sendError(data, socket, "Invalid slot!");
        }
    }
    addStats(slot, socket) {
        let equip = socket.character.equips[slot];
        this.emitter.emit(statsConfig.SERVER_INNER.STATS_ADD.name, { stats: equip }, socket);
    }
    removeStats(slot, socket) {
        let equip = socket.character.equips[slot];
        this.emitter.emit(statsConfig.SERVER_INNER.STATS_REMOVE.name, { stats: equip }, socket);
    }
}
exports.default = EquipsRouter;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NlcnZlci9saWIvZXF1aXBzL2VxdWlwcy5yb3V0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOztBQUNiLDJFQUFrRTtBQUlsRSxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsK0NBQStDLENBQUMsQ0FBQztBQUN0RSxJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsNkNBQTZDLENBQUMsQ0FBQztBQUN6RSxJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsNkNBQTZDLENBQUMsQ0FBQztBQUN6RSxJQUFJLFdBQVcsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDO0FBRXJDLGtCQUFrQyxTQUFRLDhCQUFrQjtJQU0zRCxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUc7UUFDZCxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztRQUN2QixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDO1FBQ3JDLElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7SUFDeEMsQ0FBQztJQUVTLFVBQVUsQ0FBQyxHQUFHO1FBQ3ZCLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQ3pCLElBQUksQ0FBQyxVQUFVLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFDMUQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFRCxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLE1BQWtCO1FBQ3JELElBQUksSUFBSSxHQUFXLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDN0IsSUFBSSxFQUFFLEdBQVcsSUFBSSxDQUFDLEVBQUUsQ0FBQztR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SUFBSSxDQUFDLENBQUM7WUFDUCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsZUFBZSxDQUFDLENBQUM7UUFDL0MsQ0FBQztJQUNGLENBQUM7SUFFTyxRQUFRLENBQUMsSUFBWSxFQUFFLE1BQWtCO1FBQ2hELElBQUksS0FBSyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUN0RixDQUFDO0lBRU8sV0FBVyxDQUFDLElBQVksRUFBRSxNQUFrQjtRQUNuRCxJQUFJLEtBQUssR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMxQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDekYsQ0FBQztDQUNEO0FBeklELCtCQXlJQztBQUFBLENBQUMiLCJmaWxlIjoibGliL2VxdWlwcy9lcXVpcHMucm91dGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuaW1wb3J0IFNvY2tldGlvUm91dGVyQmFzZSBmcm9tICcuLi9zb2NrZXRpby9zb2NrZXRpby5yb3V0ZXIuYmFzZSc7XG5pbXBvcnQgRXF1aXBzTWlkZGxld2FyZSBmcm9tICcuL2VxdWlwcy5taWRkbGV3YXJlJztcbmltcG9ydCBJdGVtc1JvdXRlciBmcm9tICcuLi9pdGVtcy9pdGVtcy5yb3V0ZXInO1xuaW1wb3J0IEVxdWlwc0NvbnRyb2xsZXIgZnJvbSAnLi9lcXVpcHMuY29udHJvbGxlcic7XG5sZXQgY29uZmlnID0gcmVxdWlyZSgnLi4vLi4vLi4vc2VydmVyL2xpYi9lcXVpcHMvZXF1aXBzLmNvbmZpZy5qc29uJyk7XG5sZXQgZHJvcHNDb25maWcgPSByZXF1aXJlKCcuLi8uLi8uLi9zZXJ2ZXIvbGliL2Ryb3BzL2Ryb3BzLmNvbmZpZy5qc29uJyk7XG5sZXQgc3RhdHNDb25maWcgPSByZXF1aXJlKCcuLi8uLi8uLi9zZXJ2ZXIvbGliL3N0YXRzL3N0YXRzLmNvbmZpZy5qc29uJyk7XG5sZXQgU0VSVkVSX0dFVFMgPSBjb25maWcuU0VSVkVSX0dFVFM7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEVxdWlwc1JvdXRlciBleHRlbmRzIFNvY2tldGlvUm91dGVyQmFzZSB7XG5cdHByb3RlY3RlZCBjb250cm9sbGVyOiBFcXVpcHNDb250cm9sbGVyO1xuXHRwcm90ZWN0ZWQgbWlkZGxld2FyZTogRXF1aXBzTWlkZGxld2FyZTtcblx0cHJvdGVjdGVkIG1vbmdvb3NlO1xuXHRwcm90ZWN0ZWQgaXRlbXNSb3V0ZXI6IEl0ZW1zUm91dGVyO1xuXHRcblx0aW5pdChmaWxlcywgYXBwKSB7XG5cdFx0c3VwZXIuaW5pdChmaWxlcywgYXBwKTtcblx0XHR0aGlzLm1vbmdvb3NlID0gZmlsZXMubW9kZWwubW9uZ29vc2U7XG5cdFx0dGhpcy5pdGVtc1JvdXRlciA9IGZpbGVzLnJvdXRlcnMuaXRlbXM7XG5cdH1cblxuXHRwcm90ZWN0ZWQgaW5pdFJvdXRlcyhhcHApIHtcblx0XHRhcHAucG9zdCh0aGlzLlJPVVRFUy5CRUdJTixcblx0XHRcdHRoaXMubWlkZGxld2FyZS52YWxpZGF0ZUhhc1NlcmNldEtleS5iaW5kKHRoaXMubWlkZGxld2FyZSksXG5cdFx0XHR0aGlzLmNvbnRyb2xsZXIuYmVnaW5FcXVpcHMuYmluZCh0aGlzLmNvbnRyb2xsZXIpKTtcblx0fVxuXG5cdFtTRVJWRVJfR0VUUy5FUVVJUF9JVEVNLm5hbWVdKGRhdGEsIHNvY2tldDogR2FtZVNvY2tldCkge1xuXHRcdGxldCBmcm9tOiBudW1iZXIgPSBkYXRhLmZyb207XG5cdFx0bGV0IHRvOiBzdHJpbmcgPSBkYXRhLnRvO1xuXHRcdGlmICh0aGlzLm1pZGRsZXdhcmUuaXNWYWxpZEl0ZW1TbG90KGZyb20pXG5cdFx0XHQmJiB0aGlzLm1pZGRsZXdhcmUuaXNWYWxpZEVxdWlwU2xvdCh0bylcblx0XHRcdCYmIHRoaXMubWlkZGxld2FyZS5oYXNJdGVtKHNvY2tldCwgZnJvbSkpIHtcblxuXHRcdFx0bGV0IGl0ZW0gPSBzb2NrZXQuY2hhcmFjdGVyLml0ZW1zW2Zyb21dO1xuXHRcdFx0bGV0IGl0ZW1JbmZvID0gdGhpcy5pdGVtc1JvdXRlci5nZXRJdGVtSW5mbyhpdGVtLmtleSk7XG5cdFx0XHRpZiAoIWl0ZW1JbmZvKSB7XG5cdFx0XHRcdHRoaXMuc2VuZEVycm9yKGRhdGEsIHNvY2tldCwgXCJDb3VsZCBub3QgZmluZCBpdGVtIGluZm8gZm9yIGl0ZW0gXCIgKyBpdGVtLmtleSk7XG5cdFx0XHR9IGVsc2UgaWYgKCF0aGlzLm1pZGRsZXdhcmUuY2FuV2VhckVxdWlwKHNvY2tldCwgaXRlbUluZm8sIHRvKSkge1xuXHRcdFx0XHR0aGlzLnNlbmRFcnJvcihkYXRhLCBzb2NrZXQsIFwiSXRlbSBjYW5ub3QgYmUgZXF1aXBwZWQgdGhlcmVcIik7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0aGlzLnJlbW92ZVN0YXRzKHRvLCBzb2NrZXQpO1xuXHRcdFx0XHR0aGlzLm1pZGRsZXdhcmUuc3dhcEVxdWlwQW5kSXRlbShzb2NrZXQsIGZyb20sIHRvKTtcblx0XHRcdFx0dGhpcy5hZGRTdGF0cyh0bywgc29ja2V0KTtcblxuXHRcdFx0XHR0aGlzLmlvLnRvKHNvY2tldC5jaGFyYWN0ZXIucm9vbSkuZW1pdCh0aGlzLkNMSUVOVF9HRVRTLkVRVUlQX0lURU0ubmFtZSwge1xuXHRcdFx0XHRcdGlkOiBzb2NrZXQuY2hhcmFjdGVyLl9pZCxcblx0XHRcdFx0XHRmcm9tLFxuXHRcdFx0XHRcdHRvLFxuXHRcdFx0XHRcdGVxdWlwcGVkX2l0ZW06IGl0ZW0sXG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXHRcdH0gZWxzZSB7XG5cdFx0XHR0aGlzLnNlbmRFcnJvcihkYXRhLCBzb2NrZXQsIFwiSW52YWxpZCBzbG90cyFcIik7XG5cdFx0fVxuXHR9XG5cblx0W1NFUlZFUl9HRVRTLlVORVFVSVBfSVRFTS5uYW1lXShkYXRhLCBzb2NrZXQ6IEdhbWVTb2NrZXQpIHtcblx0XHRsZXQgZnJvbTogc3RyaW5nID0gZGF0YS5mcm9tO1xuXHRcdGxldCB0bzogbnVtYmVyID0gZGF0YS50bztcblx0XHRpZiAodGhpcy5taWRkbGV3YXJlLmlzVmFsaWRFcXVpcFNsb3QoZnJvbSlcblx0XHRcdCYmIHRoaXMubWlkZGxld2FyZS5pc1ZhbGlkSXRlbVNsb3QodG8pXG5cdFx0XHQmJiB0aGlzLm1pZGRsZXdhcmUuaGFzRXF1aXAoc29ja2V0LCBmcm9tKSkge1xuXG5cdFx0XHRpZiAodGhpcy5taWRkbGV3YXJlLmhhc0l0ZW0oc29ja2V0LCB0bylcblx0XHRcdFx0JiYgIXRoaXMubWlkZGxld2FyZS5jYW5XZWFyRXF1aXAoc29ja2V0LCB0aGlzLml0ZW1zUm91dGVyLmdldEl0ZW1JbmZvKHNvY2tldC5jaGFyYWN0ZXIuaXRlbXNbdG9dLmtleSksIGZyb20pKSB7XG5cdFx0XHRcdC8vIGlmIHRoZSB3YW50ZWQgc2xvdCBhbHJlYWR5IGhhcyBhbiBpdGVtLCBjaGVjayBpZiBpdCBjYW4gYmUgcmVwbGFjZWRcblx0XHRcdFx0dGhpcy5zZW5kRXJyb3IoZGF0YSwgc29ja2V0LCBcIkNhbm5vdCB1bmVxdWlwIHRvIHNsb3QhXCIpO1xuXHRcdFx0fSBlbHNlIHtcblxuXHRcdFx0XHR0aGlzLnJlbW92ZVN0YXRzKGZyb20sIHNvY2tldCk7XG5cdFx0XHRcdHRoaXMubWlkZGxld2FyZS5zd2FwRXF1aXBBbmRJdGVtKHNvY2tldCwgdG8sIGZyb20pO1xuXHRcdFx0XHR0aGlzLmFkZFN0YXRzKGZyb20sIHNvY2tldCk7XG5cblx0XHRcdFx0dGhpcy5pby50byhzb2NrZXQuY2hhcmFjdGVyLnJvb20pLmVtaXQodGhpcy5DTElFTlRfR0VUUy5VTkVRVUlQX0lURU0ubmFtZSwge1xuXHRcdFx0XHRcdGlkOiBzb2NrZXQuY2hhcmFjdGVyLl9pZCxcblx0XHRcdFx0XHRmcm9tLFxuXHRcdFx0XHRcdHRvLFxuXHRcdFx0XHRcdGVxdWlwcGVkX2l0ZW06IHNvY2tldC5jaGFyYWN0ZXIuZXF1aXBzW2Zyb21dLFxuXHRcdFx0XHR9KTtcblx0XHRcdH1cblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5zZW5kRXJyb3IoZGF0YSwgc29ja2V0LCBcIkludmFsaWQgc2xvdHMhXCIpO1xuXHRcdH1cblx0fVxuXG5cdFtTRVJWRVJfR0VUUy5VU0VfRVFVSVAubmFtZV0oZGF0YSwgc29ja2V0OiBHYW1lU29ja2V0KSB7XG5cdFx0bGV0IHNsb3QgPSB0aGlzLm1pZGRsZXdhcmUuZ2V0Rmlyc3RBdmFpbGFibGVTbG90KHNvY2tldCk7XG5cdFx0aWYgKHNsb3QgPj0gMCkge1xuXHRcdFx0dGhpc1tTRVJWRVJfR0VUUy5VTkVRVUlQX0lURU0ubmFtZV0oe1xuXHRcdFx0XHRmcm9tOiBkYXRhLnNsb3QsXG5cdFx0XHRcdHRvOiBzbG90XG5cdFx0XHR9LCBzb2NrZXQpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR0aGlzLnNlbmRFcnJvcihkYXRhLCBzb2NrZXQsIFwiQ2Fubm90IHVuZXF1aXAgdG8gc2xvdCFcIik7XG5cdFx0fVxuXHR9XG5cblx0W1NFUlZFUl9HRVRTLlVTRV9JVEVNLm5hbWVdKGRhdGEsIHNvY2tldDogR2FtZVNvY2tldCkge1xuXHRcdGxldCBpdGVtU2xvdDogbnVtYmVyID0gZGF0YS5zbG90O1xuXHRcdGlmICh0aGlzLm1pZGRsZXdhcmUuaXNWYWxpZEl0ZW1TbG90KGl0ZW1TbG90KSkge1xuXHRcdFx0bGV0IGl0ZW0gPSBzb2NrZXQuY2hhcmFjdGVyLml0ZW1zW2l0ZW1TbG90XTtcblx0XHRcdGxldCBpdGVtSW5mbyA9IHRoaXMuaXRlbXNSb3V0ZXIuZ2V0SXRlbUluZm8oaXRlbS5rZXkpO1xuXHRcdFx0aWYgKCFpdGVtSW5mbykge1xuXHRcdFx0XHR0aGlzLnNlbmRFcnJvcihkYXRhLCBzb2NrZXQsIFwiQ291bGQgbm90IGZpbmQgaXRlbSBpbmZvIGZvciBpdGVtIFwiICsgaXRlbS5rZXkpO1xuXHRcdFx0fSBlbHNlIGlmICh0aGlzLm1pZGRsZXdhcmUuaXNWYWxpZEVxdWlwSXRlbShpdGVtSW5mbykpIHtcblx0XHRcdFx0dGhpc1tTRVJWRVJfR0VUUy5FUVVJUF9JVEVNLm5hbWVdKHtcblx0XHRcdFx0XHRmcm9tOiBpdGVtU2xvdCxcblx0XHRcdFx0XHR0bzogaXRlbUluZm8udHlwZVxuXHRcdFx0XHR9LCBzb2NrZXQpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhpcy5zZW5kRXJyb3IoZGF0YSwgc29ja2V0LCBcIkl0ZW0gbm90IGVxdWlwYWJsZSFcIik7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRoaXMuc2VuZEVycm9yKGRhdGEsIHNvY2tldCwgXCJJbnZhbGlkIHNsb3QhXCIpO1xuXHRcdH1cblx0fVxuXG5cdFtTRVJWRVJfR0VUUy5EUk9QX0VRVUlQLm5hbWVdKGRhdGEsIHNvY2tldDogR2FtZVNvY2tldCkge1xuXHRcdGxldCBzbG90ID0gZGF0YS5zbG90O1xuXHRcdGlmICh0aGlzLm1pZGRsZXdhcmUuaGFzRXF1aXAoc29ja2V0LCBzbG90KSkge1xuXHRcdFx0bGV0IGVxdWlwID0gc29ja2V0LmNoYXJhY3Rlci5lcXVpcHNbc2xvdF07XG5cblx0XHRcdHRoaXMuZW1pdHRlci5lbWl0KGRyb3BzQ29uZmlnLlNFUlZFUl9JTk5FUi5JVEVNU19EUk9QLm5hbWUsIHsgfSwgc29ja2V0LCBbZXF1aXBdKTtcblx0XHRcdHRoaXMucmVtb3ZlU3RhdHMoc2xvdCwgc29ja2V0KTtcblxuXHRcdFx0bGV0IEl0ZW1zTW9kZWxzID0gdGhpcy5tb25nb29zZS5tb2RlbChcIkl0ZW1cIik7XG5cdFx0XHRzb2NrZXQuY2hhcmFjdGVyLmVxdWlwc1tzbG90XSA9IG5ldyBJdGVtc01vZGVscyh7fSk7XG5cdFx0XHR0aGlzLmlvLnRvKHNvY2tldC5jaGFyYWN0ZXIucm9vbSkuZW1pdCh0aGlzLkNMSUVOVF9HRVRTLkRFTEVURV9FUVVJUC5uYW1lLCB7XG5cdFx0XHRcdGlkOiBzb2NrZXQuY2hhcmFjdGVyLl9pZCxcblx0XHRcdFx0c2xvdFxuXHRcdFx0fSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRoaXMuc2VuZEVycm9yKGRhdGEsIHNvY2tldCwgXCJJbnZhbGlkIHNsb3QhXCIpO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgYWRkU3RhdHMoc2xvdDogc3RyaW5nLCBzb2NrZXQ6IEdhbWVTb2NrZXQpIHtcblx0XHRsZXQgZXF1aXAgPSBzb2NrZXQuY2hhcmFjdGVyLmVxdWlwc1tzbG90XTtcblx0XHR0aGlzLmVtaXR0ZXIuZW1pdChzdGF0c0NvbmZpZy5TRVJWRVJfSU5ORVIuU1RBVFNfQURELm5hbWUsIHsgc3RhdHM6IGVxdWlwIH0sIHNvY2tldCk7XG5cdH1cblxuXHRwcml2YXRlIHJlbW92ZVN0YXRzKHNsb3Q6IHN0cmluZywgc29ja2V0OiBHYW1lU29ja2V0KSB7XG5cdFx0bGV0IGVxdWlwID0gc29ja2V0LmNoYXJhY3Rlci5lcXVpcHNbc2xvdF07XG5cdFx0dGhpcy5lbWl0dGVyLmVtaXQoc3RhdHNDb25maWcuU0VSVkVSX0lOTkVSLlNUQVRTX1JFTU9WRS5uYW1lLCB7IHN0YXRzOiBlcXVpcCB9LCBzb2NrZXQpO1xuXHR9XG59O1xuIl19
