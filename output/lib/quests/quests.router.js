'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const socketio_router_base_1 = require("../socketio/socketio.router.base");
const _ = require("underscore");
let config = require('../../../server/lib/quests/quests.config.json');
let statsConfig = require('../../../server/lib/stats/stats.config.json');
let itemsConfig = require('../../../server/lib/items/items.config.json');
class QuestsRouter extends socketio_router_base_1.default {
    init(files, app) {
        this.services = files.services;
        this.itemsRouter = files.routers.items;
        this.partyRouter = files.routers.party;
        super.init(files, app);
    }
    initRoutes(app) {
        app.post(this.ROUTES.GENERATE, this.middleware.validateHasSercetKey.bind(this.middleware), this.controller.generateQuests.bind(this.controller));
    }
    [config.SERVER_GETS.QUEST_START.name](data, socket) {
        let questKey = data.id;
        let questInfo = this.services.getQuestInfo(questKey);
        let unmetReason;
        if (!questInfo) {
            this.sendError(data, socket, "Could not find a quest with such key, so can't start.");
        }
        else if (socket.character.quests.progress[questKey]) {
            this.sendError(data, socket, "Already started this quest!");
        }
        else if (socket.character.quests.done[questKey]) {
            this.sendError(data, socket, "Already finished this quest!");
        }
        else if (unmetReason = this.services.questReqUnmetReason(socket.character, questInfo)) {
            this.sendError(data, socket, "Character does not meet the quest requirement: " + unmetReason);
        }
        else {
            this.services.startQuest(socket.character.quests, questInfo);
            socket.emit(this.CLIENT_GETS.QUEST_START.name, { id: questKey });
        }
    }
    [config.SERVER_GETS.QUEST_DONE.name](data, socket) {
        let questKey = data.id;
        let questInfo = this.services.getQuestInfo(questKey);
        let unmetReason;
        let slots;
        if (!questInfo) {
            this.sendError(data, socket, "Could not find a quest with such key so can't complete.");
        }
        else if (!socket.character.quests.progress[questKey]) {
            this.sendError(data, socket, "Quest cannot be completed, it is not in progress!");
        }
        else if (unmetReason = this.services.questFinishUnmetReason(socket.character, this.itemsRouter.getItemsCounts(socket), questInfo)) {
            this.sendError(data, socket, "Quest does not meet finishing criteria: " + unmetReason);
        }
        else if (!(slots = this.itemsRouter.getItemsSlots(socket, (questInfo.reward || {}).items || []))) {
            this.sendError(data, socket, `There must be ${questInfo.reward.items.length} empty slots for the quest rewards.`);
        }
        else {
            this.services.finishQuest(socket.character.quests, questInfo);
            socket.emit(this.CLIENT_GETS.QUEST_DONE.name, { id: questKey });
            _.forEach((questInfo.cond || {}).loot, (stack, key) => {
                this.emitter.emit(itemsConfig.SERVER_INNER.ITEM_REMOVE.name, { item: { stack, key } }, socket);
            });
            if ((questInfo.reward || {}).exp) {
                this.emitter.emit(statsConfig.SERVER_INNER.GAIN_EXP.name, { exp: questInfo.reward.exp }, socket);
            }
            if ((questInfo.reward || {}).stats) {
                this.emitter.emit(statsConfig.SERVER_INNER.GAIN_STATS.name, { stats: questInfo.reward.stats }, socket);
            }
            _.forEach((questInfo.reward || {}).items, item => {
                let instance = this.itemsRouter.getItemInstance(item.key);
                if (item.stack > 0) {
                    instance.stack = item.stack;
                }
                let itemSlots = slots[item.key];
                this.emitter.emit(itemsConfig.SERVER_INNER.ITEM_ADD.name, { slots: itemSlots, item: instance }, socket);
            });
        }
    }
    [config.SERVER_GETS.QUEST_ABORT.name](data, socket) {
        let questKey = data.id;
        let questInfo = this.services.getQuestInfo(questKey);
        if (!questInfo) {
            this.sendError(data, socket, "Could not find a quest with such key so can't abort.");
        }
        else if (!socket.character.quests.progress[questKey]) {
            this.sendError(data, socket, "Quest cannot be aborted, it is not in progress!");
        }
        else {
            this.services.abortQuest(socket.character.quests, questInfo);
            socket.emit(this.CLIENT_GETS.QUEST_ABORT.name, { id: questKey });
        }
    }
    [config.SERVER_INNER.HUNT_MOB.name](data, socket) {
        let partySockets = this.partyRouter.getPartyMembersInMap(socket);
        for (let memberSocket of partySockets) {
            let quests = memberSocket.character.quests.hunt[data.id] || {};
            let fields = new Set();
            for (let questKey in quests) {
                let questInfo = this.services.getQuestInfo(questKey);
                if (quests[questKey] < questInfo.cond.hunt[data.id]) {
                    quests[questKey]++;
                    memberSocket.emit(this.CLIENT_GETS.QUEST_HUNT_PROGRESS.name, { id: questKey, mob_id: data.id, value: quests[questKey] });
                    fields.add("hunt");
                    console.log("Hunt for quest", data.id, questKey, quests[questKey]);
                }
            }
            this.services.markModified(memberSocket.character.quests, fields);
        }
    }
}
exports.default = QuestsRouter;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NlcnZlci9saWIvcXVlc3RzL3F1ZXN0cy5yb3V0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOztBQUNiLDJFQUFrRTtBQUtsRSxnQ0FBZ0M7QUFFaEMsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLCtDQUErQyxDQUFDLENBQUM7QUFDdEUsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLDZDQUE2QyxDQUFDLENBQUM7QUFDekUsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLDZDQUE2QyxDQUFDLENBQUM7QUFFekUsa0JBQWtDLFNBQVEsOEJBQWtCO0lBTzNELElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRztRQUNkLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQztRQUMvQixJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7UUFDN0MsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDeEIsQ0FBQztJQUVTLFVBQVUsQ0FBQyxHQUFHO1FBQ3ZCLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQzVCLElBQUksQ0FBQyxVQUFVLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFDMUQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQ3hELENBQUM7SUFFRCxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxNQUFrQjtRQUM3RCxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDO1FBQ3ZCLElBQUksU0FB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USxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQzFCLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUNyRCxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDbEQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7b0JBQ25CLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsUUFBUSxDQUFDLEVBQUMsQ0FBQyxDQUFDO29CQUN4SCxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUNuQixPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsUUFBUSxFQUFFLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO2dCQUN2RSxDQUFDO1lBQ0wsQ0FBQztZQUNELElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ3RFLENBQUM7SUFDUixDQUFDO0NBQ0Q7QUFqSEQsK0JBaUhDO0FBQUEsQ0FBQyIsImZpbGUiOiJsaWIvcXVlc3RzL3F1ZXN0cy5yb3V0ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5pbXBvcnQgU29ja2V0aW9Sb3V0ZXJCYXNlIGZyb20gJy4uL3NvY2tldGlvL3NvY2tldGlvLnJvdXRlci5iYXNlJztcbmltcG9ydCBRdWVzdHNNaWRkbGV3YXJlIGZyb20gXCIuL3F1ZXN0cy5taWRkbGV3YXJlXCI7XG5pbXBvcnQgUXVlc3RzQ29udHJvbGxlciBmcm9tIFwiLi9xdWVzdHMuY29udHJvbGxlclwiO1xuaW1wb3J0IFF1ZXN0c1NlcnZpY2VzIGZyb20gJy4vcXVlc3RzLnNlcnZpY2VzJztcbmltcG9ydCBJdGVtc1JvdXRlciBmcm9tICcuLi9pdGVtcy9pdGVtcy5yb3V0ZXInO1xuaW1wb3J0ICogYXMgXyBmcm9tICd1bmRlcnNjb3JlJztcbmltcG9ydCBQYXJ0eVJvdXRlciBmcm9tICcuLi9wYXJ0eS9wYXJ0eS5yb3V0ZXInO1xubGV0IGNvbmZpZyA9IHJlcXVpcmUoJy4uLy4uLy4uL3NlcnZlci9saWIvcXVlc3RzL3F1ZXN0cy5jb25maWcuanNvbicpO1xubGV0IHN0YXRzQ29uZmlnID0gcmVxdWlyZSgnLi4vLi4vLi4vc2VydmVyL2xpYi9zdGF0cy9zdGF0cy5jb25maWcuanNvbicpO1xubGV0IGl0ZW1zQ29uZmlnID0gcmVxdWlyZSgnLi4vLi4vLi4vc2VydmVyL2xpYi9pdGVtcy9pdGVtcy5jb25maWcuanNvbicpO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBRdWVzdHNSb3V0ZXIgZXh0ZW5kcyBTb2NrZXRpb1JvdXRlckJhc2Uge1xuXHRwcm90ZWN0ZWQgbWlkZGxld2FyZTogUXVlc3RzTWlkZGxld2FyZTtcblx0cHJvdGVjdGVkIGNvbnRyb2xsZXI6IFF1ZXN0c0NvbnRyb2xsZXI7XG5cdHByb3RlY3RlZCBzZXJ2aWNlczogUXVlc3RzU2VydmljZXM7XG5cdHByb3RlY3RlZCBpdGVtc1JvdXRlcjogSXRlbXNSb3V0ZXI7XG4gICAgcHJvdGVjdGVkIHBhcnR5Um91dGVyOiBQYXJ0eVJvdXRlcjtcblxuXHRpbml0KGZpbGVzLCBhcHApIHtcblx0XHR0aGlzLnNlcnZpY2VzID0gZmlsZXMuc2VydmljZXM7XG5cdFx0dGhpcy5pdGVtc1JvdXRlciA9IGZpbGVzLnJvdXRlcnMuaXRlbXM7XG4gICAgICAgIHRoaXMucGFydHlSb3V0ZXIgPSBmaWxlcy5yb3V0ZXJzLnBhcnR5O1xuXHRcdHN1cGVyLmluaXQoZmlsZXMsIGFwcCk7XG5cdH1cblxuXHRwcm90ZWN0ZWQgaW5pdFJvdXRlcyhhcHApIHtcblx0XHRhcHAucG9zdCh0aGlzLlJPVVRFUy5HRU5FUkFURSxcblx0XHRcdHRoaXMubWlkZGxld2FyZS52YWxpZGF0ZUhhc1NlcmNldEtleS5iaW5kKHRoaXMubWlkZGxld2FyZSksXG5cdFx0XHR0aGlzLmNvbnRyb2xsZXIuZ2VuZXJhdGVRdWVzdHMuYmluZCh0aGlzLmNvbnRyb2xsZXIpKTtcblx0fVxuXG5cdFtjb25maWcuU0VSVkVSX0dFVFMuUVVFU1RfU1RBUlQubmFtZV0oZGF0YSwgc29ja2V0OiBHYW1lU29ja2V0KSB7XG5cdFx0bGV0IHF1ZXN0S2V5ID0gZGF0YS5pZDtcblx0XHRsZXQgcXVlc3RJbmZvID0gdGhpcy5zZXJ2aWNlcy5nZXRRdWVzdEluZm8ocXVlc3RLZXkpO1xuXHRcdGxldCB1bm1ldFJlYXNvbjtcblx0XHRpZiAoIXF1ZXN0SW5mbykge1xuXHRcdFx0dGhpcy5zZW5kRXJyb3IoZGF0YSwgc29ja2V0LCBcIkNvdWxkIG5vdCBmaW5kIGEgcXVlc3Qgd2l0aCBzdWNoIGtleSwgc28gY2FuJ3Qgc3RhcnQuXCIpO1xuXHRcdH0gZWxzZSBpZiAoc29ja2V0LmNoYXJhY3Rlci5xdWVzdHMucHJvZ3Jlc3NbcXVlc3RLZXldKSB7XG5cdFx0XHR0aGlzLnNlbmRFcnJvcihkYXRhLCBzb2NrZXQsIFwiQWxyZWFkeSBzdGFydGVkIHRoaXMgcXVlc3QhXCIpO1xuXHRcdH0gZWxzZSBpZiAoc29ja2V0LmNoYXJhY3Rlci5xdWVzdHMuZG9uZVtxdWVzdEtleV0pIHtcblx0XHRcdHRoaXMuc2VuZEVycm9yKGRhdGEsIHNvY2tldCwgXCJBbHJlYWR5IGZpbmlzaGVkIHRoaXMgcXVlc3QhXCIpO1xuXHRcdH0gZWxzZSBpZiAodW5tZXRSZWFzb24gPSB0aGlzLnNlcnZpY2VzLnF1ZXN0UmVxVW5tZXRSZWFzb24oc29ja2V0LmNoYXJhY3RlciwgcXVlc3RJbmZvKSkge1xuXHRcdFx0dGhpcy5zZW5kRXJyb3IoZGF0YSwgc29ja2V0LCBcIkNoYXJhY3RlciBkb2VzIG5vdCBtZWV0IHRoZSBxdWVzdCByZXF1aXJlbWVudDogXCIgKyB1bm1ldFJlYXNvbik7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRoaXMuc2VydmljZXMuc3RhcnRRdWVzdChzb2NrZXQuY2hhcmFjdGVyLnF1ZXN0cywgcXVlc3RJbmZvKTtcblx0XHRcdHNvY2tldC5lbWl0KHRoaXMuQ0xJRU5UX0dFVFMuUVVFU1RfU1RBUlQubmFtZSwgeyBpZDogcXVlc3RLZXkgfSk7XG5cdFx0fVxuXHR9XG5cblx0W2NvbmZpZy5TRVJWRVJfR0VUUy5RVUVTVF9ET05FLm5hbWVdKGRhdGEsIHNvY2tldDogR2FtZVNvY2tldCkge1xuXHRcdGxldCBxdWVzdEtleSA9IGRhdGEuaWQ7XG5cdFx0bGV0IHF1ZXN0SW5mbyA9IHRoaXMuc2VydmljZXMuZ2V0UXVlc3RJbmZvKHF1ZXN0S2V5KTtcblx0XHRsZXQgdW5tZXRSZWFzb247XG5cdFx0bGV0IHNsb3RzOiB7W2tleTogc3RyaW5nXTogbnVtYmVyW119fGZhbHNlO1xuXHRcdGlmICghcXVlc3RJbmZvKSB7XG5cdFx0XHR0aGlzLnNlbmRFcnJvcihkYXRhLCBzb2NrZXQsIFwiQ291bGQgbm90IGZpbmQgYSBxdWVzdCB3aXRoIHN1Y2gga2V5IHNvIGNhbid0IGNvbXBsZXRlLlwiKTtcblx0XHR9IGVsc2UgaWYgKCFzb2NrZXQuY2hhcmFjdGVyLnF1ZXN0cy5wcm9ncmVzc1txdWVzdEtleV0pIHtcblx0XHRcdHRoaXMuc2VuZEVycm9yKGRhdGEsIHNvY2tldCwgXCJRdWVzdCBjYW5ub3QgYmUgY29tcGxldGVkLCBpdCBpcyBub3QgaW4gcHJvZ3Jlc3MhXCIpO1xuXHRcdH0gZWxzZSBpZiAodW5tZXRSZWFzb24gPSB0aGlzLnNlcnZpY2VzLnF1ZXN0RmluaXNoVW5tZXRSZWFzb24oc29ja2V0LmNoYXJhY3RlciwgdGhpcy5pdGVtc1JvdXRlci5nZXRJdGVtc0NvdW50cyhzb2NrZXQpLCBxdWVzdEluZm8pKSB7XG5cdFx0XHR0aGlzLnNlbmRFcnJvcihkYXRhLCBzb2NrZXQsIFwiUXVlc3QgZG9lcyBub3QgbWVldCBmaW5pc2hpbmcgY3JpdGVyaWE6IFwiICsgdW5tZXRSZWFzb24pO1xuXHRcdH0gZWxzZSBpZiAoIShzbG90cyA9IHRoaXMuaXRlbXNSb3V0ZXIuZ2V0SXRlbXNTbG90cyhzb2NrZXQsIChxdWVzdEluZm8ucmV3YXJkIHx8IHt9KS5pdGVtcyB8fCBbXSkpKSB7XG5cdFx0XHR0aGlzLnNlbmRFcnJvcihkYXRhLCBzb2NrZXQsIGBUaGVyZSBtdXN0IGJlICR7cXVlc3RJbmZvLnJld2FyZC5pdGVtcy5sZW5ndGh9IGVtcHR5IHNsb3RzIGZvciB0aGUgcXVlc3QgcmV3YXJkcy5gKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5zZXJ2aWNlcy5maW5pc2hRdWVzdChzb2NrZXQuY2hhcmFjdGVyLnF1ZXN0cywgcXVlc3RJbmZvKTtcblx0XHRcdHNvY2tldC5lbWl0KHRoaXMuQ0xJRU5UX0dFVFMuUVVFU1RfRE9ORS5uYW1lLCB7IGlkOiBxdWVzdEtleSB9KTtcblx0XHRcdFxuXHRcdFx0Xy5mb3JFYWNoKChxdWVzdEluZm8uY29uZCB8fCB7fSkubG9vdCwgKHN0YWNrLCBrZXkpID0+IHtcblx0XHRcdFx0dGhpcy5lbWl0dGVyLmVtaXQoaXRlbXNDb25maWcuU0VSVkVSX0lOTkVSLklURU1fUkVNT1ZFLm5hbWUsIHtpdGVtOiB7IHN0YWNrLCBrZXkgfX0sIHNvY2tldCk7XG5cdFx0XHR9KTtcblxuXHRcdFx0Ly8gcmV3YXJkIGV4cFxuXHRcdFx0aWYgKChxdWVzdEluZm8ucmV3YXJkIHx8IHt9KS5leHApIHtcblx0XHRcdFx0dGhpcy5lbWl0dGVyLmVtaXQoc3RhdHNDb25maWcuU0VSVkVSX0lOTkVSLkdBSU5fRVhQLm5hbWUsIHsgZXhwOiBxdWVzdEluZm8ucmV3YXJkLmV4cCB9LCBzb2NrZXQpO1xuXHRcdFx0fVxuXG5cdFx0XHQvLyBUT0RPIGNsYXNzXG5cdFx0XHRcblx0XHRcdC8vIHJld2FyZCBzdGF0c1xuXHRcdFx0aWYgKChxdWVzdEluZm8ucmV3YXJkIHx8IHt9KS5zdGF0cykge1xuXHRcdFx0XHR0aGlzLmVtaXR0ZXIuZW1pdChzdGF0c0NvbmZpZy5TRVJWRVJfSU5ORVIuR0FJTl9TVEFUUy5uYW1lLCB7IHN0YXRzOiBxdWVzdEluZm8ucmV3YXJkLnN0YXRzIH0sIHNvY2tldCk7XG5cdFx0XHR9XG5cblx0XHRcdC8vIHJld2FyZCBpdGVtc1xuXHRcdFx0Xy5mb3JFYWNoKChxdWVzdEluZm8ucmV3YXJkIHx8IHt9KS5pdGVtcywgaXRlbSA9PiB7XG5cdFx0XHRcdGxldCBpbnN0YW5jZSA9IHRoaXMuaXRlbXNSb3V0ZXIuZ2V0SXRlbUluc3RhbmNlKGl0ZW0ua2V5KTtcblx0XHRcdFx0aWYgKGl0ZW0uc3RhY2sgPiAwKSB7XG5cdFx0XHRcdFx0aW5zdGFuY2Uuc3RhY2sgPSBpdGVtLnN0YWNrO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGxldCBpdGVtU2xvdHMgPSBzbG90c1tpdGVtLmtleV07XG5cdFx0XHRcdHRoaXMuZW1pdHRlci5lbWl0KGl0ZW1zQ29uZmlnLlNFUlZFUl9JTk5FUi5JVEVNX0FERC5uYW1lLCB7IHNsb3RzOiBpdGVtU2xvdHMsIGl0ZW06IGluc3RhbmNlIH0sIHNvY2tldCk7XG5cdFx0XHR9KTtcblx0XHR9XG5cdH1cblxuXHRbY29uZmlnLlNFUlZFUl9HRVRTLlFVRVNUX0FCT1JULm5hbWVdKGRhdGEsIHNvY2tldDogR2FtZVNvY2tldCkge1xuXHRcdGxldCBxdWVzdEtleSA9IGRhdGEuaWQ7XG5cdFx0bGV0IHF1ZXN0SW5mbyA9IHRoaXMuc2VydmljZXMuZ2V0UXVlc3RJbmZvKHF1ZXN0S2V5KTtcblx0XHRpZiAoIXF1ZXN0SW5mbykge1xuXHRcdFx0dGhpcy5zZW5kRXJyb3IoZGF0YSwgc29ja2V0LCBcIkNvdWxkIG5vdCBmaW5kIGEgcXVlc3Qgd2l0aCBzdWNoIGtleSBzbyBjYW4ndCBhYm9ydC5cIik7XG5cdFx0fSBlbHNlIGlmICghc29ja2V0LmNoYXJhY3Rlci5xdWVzdHMucHJvZ3Jlc3NbcXVlc3RLZXldKSB7XG5cdFx0XHR0aGlzLnNlbmRFcnJvcihkYXRhLCBzb2NrZXQsIFwiUXVlc3QgY2Fubm90IGJlIGFib3J0ZWQsIGl0IGlzIG5vdCBpbiBwcm9ncmVzcyFcIik7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRoaXMuc2VydmljZXMuYWJvcnRRdWVzdChzb2NrZXQuY2hhcmFjdGVyLnF1ZXN0cywgcXVlc3RJbmZvKVxuXHRcdFx0c29ja2V0LmVtaXQodGhpcy5DTElFTlRfR0VUUy5RVUVTVF9BQk9SVC5uYW1lLCB7IGlkOiBxdWVzdEtleSB9KTtcblx0XHR9XG5cdH1cblxuXHRbY29uZmlnLlNFUlZFUl9JTk5FUi5IVU5UX01PQi5uYW1lXShkYXRhLCBzb2NrZXQ6IEdhbWVTb2NrZXQpIHtcbiAgICAgICAgbGV0IHBhcnR5U29ja2V0cyA9IHRoaXMucGFydHlSb3V0ZXIuZ2V0UGFydHlNZW1iZXJzSW5NYXAoc29ja2V0KTtcbiAgICAgICAgZm9yIChsZXQgbWVtYmVyU29ja2V0IG9mIHBhcnR5U29ja2V0cykge1xuICAgICAgICAgICAgbGV0IHF1ZXN0cyA9IG1lbWJlclNvY2tldC5jaGFyYWN0ZXIucXVlc3RzLmh1bnRbZGF0YS5pZF0gfHwge307XG4gICAgICAgICAgICBsZXQgZmllbGRzOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTtcbiAgICAgICAgICAgIGZvciAobGV0IHF1ZXN0S2V5IGluIHF1ZXN0cykge1xuICAgICAgICAgICAgICAgIGxldCBxdWVzdEluZm8gPSB0aGlzLnNlcnZpY2VzLmdldFF1ZXN0SW5mbyhxdWVzdEtleSk7XG4gICAgICAgICAgICAgICAgaWYgKHF1ZXN0c1txdWVzdEtleV0gPCBxdWVzdEluZm8uY29uZC5odW50W2RhdGEuaWRdKSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXN0c1txdWVzdEtleV0rKztcbiAgICAgICAgICAgICAgICAgICAgbWVtYmVyU29ja2V0LmVtaXQodGhpcy5DTElFTlRfR0VUUy5RVUVTVF9IVU5UX1BST0dSRVNTLm5hbWUsIHsgaWQ6IHF1ZXN0S2V5LCBtb2JfaWQ6IGRhdGEuaWQsIHZhbHVlOiBxdWVzdHNbcXVlc3RLZXldfSk7XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkcy5hZGQoXCJodW50XCIpO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkh1bnQgZm9yIHF1ZXN0XCIsIGRhdGEuaWQsIHF1ZXN0S2V5LCBxdWVzdHNbcXVlc3RLZXldKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNlcnZpY2VzLm1hcmtNb2RpZmllZChtZW1iZXJTb2NrZXQuY2hhcmFjdGVyLnF1ZXN0cywgZmllbGRzKTtcbiAgICAgICAgfVxuXHR9XG59O1xuIl19
