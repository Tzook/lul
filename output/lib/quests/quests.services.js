'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const master_services_1 = require("../master/master.services");
const _ = require("underscore");
class QuestsServices extends master_services_1.default {
    constructor() {
        super(...arguments);
        this.questsInfo = new Map();
    }
    startQuest(quests, questInfo) {
        quests.progress[questInfo.key] = {};
        let fields = new Set(["progress"]);
        for (var mobKey in ((questInfo.cond || {}).hunt || {})) {
            quests.hunt[mobKey] = quests.hunt[mobKey] || {};
            quests.hunt[mobKey][questInfo.key] = 0;
            fields.add("hunt");
        }
        this.markModified(quests, fields);
    }
    finishQuest(quests, questInfo) {
        this.removeQuest(quests, questInfo);
        quests.done[questInfo.key] = {};
        quests.markModified("done");
    }
    abortQuest(quests, questInfo) {
        this.removeQuest(quests, questInfo);
    }
    removeQuest(quests, questInfo) {
        delete quests.progress[questInfo.key];
        let fields = new Set(["progress"]);
        for (var mobKey in ((questInfo.cond || {}).hunt || {})) {
            delete quests.hunt[mobKey][questInfo.key];
            if (_.isEmpty(quests.hunt[mobKey])) {
                delete quests.hunt[mobKey];
            }
            fields.add("hunt");
        }
        this.markModified(quests, fields);
    }
    markModified(quests, fields) {
        for (let field of fields) {
            quests.markModified(field);
        }
    }
    questReqUnmetReason(char, questInfo) {
        let req = questInfo.req;
        if (req) {
            if (req.lvl && char.stats.lvl < req.lvl) {
                return `level ${char.stats.lvl} / ${req.lvl}`;
            }
            for (var i in (req.quests || [])) {
                let reqQuest = req.quests[i];
                if (!char.quests.done[reqQuest]) {
                    return `quest id '${reqQuest}'`;
                }
            }
        }
        return "";
    }
    questFinishUnmetReason(char, itemsCounts, questInfo) {
        for (var itemKey in ((questInfo.cond || {}).loot || {})) {
            let progress = itemKey === "gold" ? char.gold : itemsCounts.get(itemKey);
            let target = questInfo.cond.loot[itemKey];
            if (progress < target) {
                return `loot ${progress} / ${target} ${itemKey}`;
            }
        }
        for (var mobKey in ((questInfo.cond || {}).hunt || {})) {
            let progress = char.quests.hunt[mobKey][questInfo.key];
            let target = questInfo.cond.hunt[mobKey];
            if (progress < target) {
                return `hunt ${progress} / ${target} ${mobKey}`;
            }
        }
        return "";
    }
    generateQuests(quests) {
        console.log("Generating quests from data:", quests);
        let models = [];
        (quests || []).forEach(quest => {
            let questSchema = { key: quest.key };
            {
                let conditions = {};
                (quest.conditions || []).forEach(condition => {
                    conditions[condition.condition] = conditions[condition.condition] || {};
                    conditions[condition.condition][condition.conditionType] = +condition.targetProgress;
                    questSchema.cond = conditions;
                });
            }
            {
                let req = {};
                if (quest.minLevel > 0)
                    req.lvl = +quest.minLevel;
                if (quest.requiredClass)
                    req.class = quest.requiredClass;
                let reqQuests = [];
                (quest.RequiredQuests || []).forEach(reqQuest => {
                    reqQuests.push(reqQuest.key);
                    req.quests = reqQuests;
                });
                if (!_.isEmpty(req)) {
                    questSchema.req = req;
                }
            }
            {
                let rewards = {};
                if (quest.rewardClass)
                    rewards.class = quest.rewardClass;
                if (quest.rewardExp > 0)
                    rewards.exp = +quest.rewardExp;
                if (quest.rewardPrimaryAbility)
                    rewards.ability = quest.rewardPrimaryAbility;
                let stats = {};
                if (quest.rewardSTR > 0)
                    stats.str = +quest.rewardSTR;
                if (quest.rewardMAG > 0)
                    stats.mag = +quest.rewardMAG;
                if (quest.rewardDEX > 0)
                    stats.dex = +quest.rewardDEX;
                if (quest.rewardHP > 0)
                    stats.hp = +quest.rewardHP;
                if (quest.rewardMP > 0)
                    stats.mp = +quest.rewardMP;
                if (!_.isEmpty(stats)) {
                    rewards.stats = stats;
                }
                let items = [];
                (quest.rewardItems || []).forEach(item => {
                    let rewardItem = { key: item.key };
                    if (item.stack > 1) {
                        rewardItem.stack = +item.stack;
                    }
                    items.push(rewardItem);
                    rewards.items = items;
                });
                if (!_.isEmpty(rewards)) {
                    questSchema.reward = rewards;
                }
            }
            let questModel = new this.Model(questSchema);
            models.push(questModel);
        });
        return this.Model.remove({})
            .then(d => this.Model.create(models));
    }
    getQuestInfo(key) {
        return this.questsInfo.get(key);
    }
    getQuests() {
        return this.Model.find({}).lean()
            .then((docs) => {
            docs.forEach(doc => {
                this.questsInfo.set(doc.key, doc);
            });
            console.log("got quests");
            return this.questsInfo;
        });
    }
}
exports.default = QuestsServices;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NlcnZlci9saWIvcXVlc3RzL3F1ZXN0cy5zZXJ2aWNlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7O0FBQ2IsK0RBQXVEO0FBQ3ZELGdDQUFnQztBQUVoQyxvQkFBb0MsU0FBUSx5QkFBYztJQUExRDs7UUFDUyxlQUFVLEdBQTZCLElBQUksR0FBRyxFQUFFLENBQUM7SUF1SzFELENBQUM7SUFyS1UsVUFBVSxDQUFDLE1BQW1CLEVBQUUsU0FBc0I7UUFDekQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ3BDLElBQUksTUFBTSxHQUFnQixJQUFJLEdBQUcsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7UUFFaEQsR0FBRyxDQUFDLENBQUMsSUFBSSxNQUFNLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyRCxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2hELE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN2QyxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3ZCLENBQUM7UUFDRCxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRU0sV0FBVyxDQUFDLE1BQW1CLEVBQUUsU0FBc0I7UUFDMUQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDcEMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFD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O0lBQ2pDLENBQUM7SUFFUyxTQUFTO1FBQ2xCLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUU7YUFDL0IsSUFBSSxDQUFDLENBQUMsSUFBbUI7WUFDekIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHO2dCQUNmLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDbkMsQ0FBQyxDQUFDLENBQUM7WUFDSCxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzFCLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBQ3hCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNEO0FBeEtELGlDQXdLQztBQUFBLENBQUMiLCJmaWxlIjoibGliL3F1ZXN0cy9xdWVzdHMuc2VydmljZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5pbXBvcnQgTWFzdGVyU2VydmljZXMgZnJvbSAnLi4vbWFzdGVyL21hc3Rlci5zZXJ2aWNlcyc7XHRcbmltcG9ydCAqIGFzIF8gZnJvbSAndW5kZXJzY29yZSc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFF1ZXN0c1NlcnZpY2VzIGV4dGVuZHMgTWFzdGVyU2VydmljZXMge1xuXHRwcml2YXRlIHF1ZXN0c0luZm86IE1hcDxzdHJpbmcsIFFVRVNUX01PREVMPiA9IG5ldyBNYXAoKTtcblxuICAgIHB1YmxpYyBzdGFydFF1ZXN0KHF1ZXN0czogQ0hBUl9RVUVTVFMsIHF1ZXN0SW5mbzogUVVFU1RfTU9ERUwpIHtcbiAgICAgICAgcXVlc3RzLnByb2dyZXNzW3F1ZXN0SW5mby5rZXldID0ge307XG4gICAgICAgIGxldCBmaWVsZHM6IFNldDxzdHJpbmc+ID0gbmV3IFNldChbXCJwcm9ncmVzc1wiXSk7XG5cbiAgICAgICAgZm9yICh2YXIgbW9iS2V5IGluICgocXVlc3RJbmZvLmNvbmQgfHwge30pLmh1bnQgfHwge30pKSB7XG4gICAgICAgICAgICBxdWVzdHMuaHVudFttb2JLZXldID0gcXVlc3RzLmh1bnRbbW9iS2V5XSB8fCB7fTtcbiAgICAgICAgICAgIHF1ZXN0cy5odW50W21vYktleV1bcXVlc3RJbmZvLmtleV0gPSAwO1xuICAgICAgICAgICAgZmllbGRzLmFkZChcImh1bnRcIik7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5tYXJrTW9kaWZpZWQocXVlc3RzLCBmaWVsZHMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBmaW5pc2hRdWVzdChxdWVzdHM6IENIQVJfUVVFU1RTLCBxdWVzdEluZm86IFFVRVNUX01PREVMKSB7XG4gICAgICAgIHRoaXMucmVtb3ZlUXVlc3QocXVlc3RzLCBxdWVzdEluZm8pO1xuICAgICAgICBxdWVzdHMuZG9uZVtxdWVzdEluZm8ua2V5XSA9IHt9O1xuICAgICAgICBxdWVzdHMubWFya01vZGlmaWVkKFwiZG9uZVwiKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWJvcnRRdWVzdChxdWVzdHM6IENIQVJfUVVFU1RTLCBxdWVzdEluZm86IFFVRVNUX01PREVMKSB7XG4gICAgICAgIHRoaXMucmVtb3ZlUXVlc3QocXVlc3RzLCBxdWVzdEluZm8pO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVtb3ZlUXVlc3QocXVlc3RzOiBDSEFSX1FVRVNUUywgcXVlc3RJbmZvOiBRVUVTVF9NT0RFTCkge1xuICAgICAgICBkZWxldGUgcXVlc3RzLnByb2dyZXNzW3F1ZXN0SW5mby5rZXldO1xuICAgICAgICBsZXQgZmllbGRzOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoW1wicHJvZ3Jlc3NcIl0pO1xuICAgICAgICBmb3IgKHZhciBtb2JLZXkgaW4gKChxdWVzdEluZm8uY29uZCB8fCB7fSkuaHVudCB8fCB7fSkpIHtcbiAgICAgICAgICAgIGRlbGV0ZSBxdWVzdHMuaHVudFttb2JLZXldW3F1ZXN0SW5mby5rZXldO1xuICAgICAgICAgICAgaWYgKF8uaXNFbXB0eShxdWVzdHMuaHVudFttb2JLZXldKSkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBxdWVzdHMuaHVudFttb2JLZXldO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZmllbGRzLmFkZChcImh1bnRcIik7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5tYXJrTW9kaWZpZWQocXVlc3RzLCBmaWVsZHMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBtYXJrTW9kaWZpZWQocXVlc3RzOiBDSEFSX1FVRVNUUywgZmllbGRzOiBTZXQ8c3RyaW5nPikge1xuICAgICAgICBmb3IgKGxldCBmaWVsZCBvZiBmaWVsZHMpIHtcbiAgICAgICAgICAgIHF1ZXN0cy5tYXJrTW9kaWZpZWQoZmllbGQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHF1ZXN0UmVxVW5tZXRSZWFzb24oY2hhcjogQ2hhciwgcXVlc3RJbmZvOiBRVUVTVF9NT0RFTCk6IHN0cmluZyB7XG4gICAgICAgIGxldCByZXEgPSBxdWVzdEluZm8ucmVxO1xuICAgICAgICBpZiAocmVxKSB7XG4gICAgICAgICAgICBpZiAocmVxLmx2bCAmJiBjaGFyLnN0YXRzLmx2bCA8IHJlcS5sdmwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYGxldmVsICR7Y2hhci5zdGF0cy5sdmx9IC8gJHtyZXEubHZsfWA7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIFRPRE8gYWRkIGNsYXNzIGNoZWNrXG5cbiAgICAgICAgICAgIGZvciAodmFyIGkgaW4gKHJlcS5xdWVzdHMgfHwgW10pKSB7XG4gICAgICAgICAgICAgICAgbGV0IHJlcVF1ZXN0ID0gcmVxLnF1ZXN0c1tpXTtcbiAgICAgICAgICAgICAgICBpZiAoIWNoYXIucXVlc3RzLmRvbmVbcmVxUXVlc3RdKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBgcXVlc3QgaWQgJyR7cmVxUXVlc3R9J2A7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBcIlwiO1xuICAgIH1cblxuICAgIHB1YmxpYyBxdWVzdEZpbmlzaFVubWV0UmVhc29uKGNoYXI6IENoYXIsIGl0ZW1zQ291bnRzOiBJVEVNU19DT1VOVFMsIHF1ZXN0SW5mbzogUVVFU1RfTU9ERUwpOiBzdHJpbmcge1xuICAgICAgICBmb3IgKHZhciBpdGVtS2V5IGluICgocXVlc3RJbmZvLmNvbmQgfHwge30pLmxvb3QgfHwge30pKSB7XG4gICAgICAgICAgICBsZXQgcHJvZ3Jlc3MgPSBpdGVtS2V5ID09PSBcImdvbGRcIiA/IGNoYXIuZ29sZCA6IGl0ZW1zQ291bnRzLmdldChpdGVtS2V5KTtcbiAgICAgICAgICAgIGxldCB0YXJnZXQgPSBxdWVzdEluZm8uY29uZC5sb290W2l0ZW1LZXldO1xuICAgICAgICAgICAgaWYgKHByb2dyZXNzIDwgdGFyZ2V0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGBsb290ICR7cHJvZ3Jlc3N9IC8gJHt0YXJnZXR9ICR7aXRlbUtleX1gO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIG1vYktleSBpbiAoKHF1ZXN0SW5mby5jb25kIHx8IHt9KS5odW50IHx8IHt9KSkge1xuICAgICAgICAgICAgbGV0IHByb2dyZXNzID0gY2hhci5xdWVzdHMuaHVudFttb2JLZXldW3F1ZXN0SW5mby5rZXldO1xuICAgICAgICAgICAgbGV0IHRhcmdldCA9IHF1ZXN0SW5mby5jb25kLmh1bnRbbW9iS2V5XTtcbiAgICAgICAgICAgIGlmIChwcm9ncmVzcyA8IHRhcmdldCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBgaHVudCAke3Byb2dyZXNzfSAvICR7dGFyZ2V0fSAke21vYktleX1gO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBcIlwiO1xuICAgIH1cblxuICAgIC8vIEhUVFAgZnVuY3Rpb25zXG5cdC8vID09PT09PT09PT09PT09PT09XG4gICAgcHVibGljIGdlbmVyYXRlUXVlc3RzKHF1ZXN0czogYW55W10pOiBQcm9taXNlPGFueT4ge1xuXHRcdGNvbnNvbGUubG9nKFwiR2VuZXJhdGluZyBxdWVzdHMgZnJvbSBkYXRhOlwiLCBxdWVzdHMpO1xuXHRcdFxuXHRcdGxldCBtb2RlbHMgPSBbXTtcblxuXHRcdChxdWVzdHMgfHwgW10pLmZvckVhY2gocXVlc3QgPT4ge1xuXHRcdFx0bGV0IHF1ZXN0U2NoZW1hOiBRVUVTVF9NT0RFTCA9IHsga2V5OiBxdWVzdC5rZXkgfTtcbiAgICAgICAgICAgIC8vIGNvbmRpdGlvbnNcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBsZXQgY29uZGl0aW9uczogUVVFU1RfQ09ORElUSU9OUyA9IHt9O1xuICAgICAgICAgICAgICAgIChxdWVzdC5jb25kaXRpb25zIHx8IFtdKS5mb3JFYWNoKGNvbmRpdGlvbiA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbnNbY29uZGl0aW9uLmNvbmRpdGlvbl0gPSBjb25kaXRpb25zW2NvbmRpdGlvbi5jb25kaXRpb25dIHx8IHt9O1xuICAgICAgICAgICAgICAgICAgICBjb25kaXRpb25zW2NvbmRpdGlvbi5jb25kaXRpb25dW2NvbmRpdGlvbi5jb25kaXRpb25UeXBlXSA9ICtjb25kaXRpb24udGFyZ2V0UHJvZ3Jlc3M7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXN0U2NoZW1hLmNvbmQgPSBjb25kaXRpb25zO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gcmVxdWlyZW1lbnRzXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbGV0IHJlcTogUVVFU1RfUkVRVUlSRU1FTlRTID0ge307XG4gICAgICAgICAgICAgICAgaWYgKHF1ZXN0Lm1pbkxldmVsID4gMCkgcmVxLmx2bCA9ICtxdWVzdC5taW5MZXZlbDtcbiAgICAgICAgICAgICAgICBpZiAocXVlc3QucmVxdWlyZWRDbGFzcykgcmVxLmNsYXNzID0gcXVlc3QucmVxdWlyZWRDbGFzcztcbiAgICAgICAgICAgICAgICBsZXQgcmVxUXVlc3RzID0gW107XG4gICAgICAgICAgICAgICAgKHF1ZXN0LlJlcXVpcmVkUXVlc3RzIHx8IFtdKS5mb3JFYWNoKHJlcVF1ZXN0ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVxUXVlc3RzLnB1c2gocmVxUXVlc3Qua2V5KTtcbiAgICAgICAgICAgICAgICAgICAgcmVxLnF1ZXN0cyA9IHJlcVF1ZXN0cztcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShyZXEpKSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXN0U2NoZW1hLnJlcSA9IHJlcTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyByZXdhcmRzXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbGV0IHJld2FyZHM6IFFVRVNUX1JFV0FSRFMgPSB7fTtcbiAgICAgICAgICAgICAgICBpZiAocXVlc3QucmV3YXJkQ2xhc3MpIHJld2FyZHMuY2xhc3MgPSBxdWVzdC5yZXdhcmRDbGFzcztcbiAgICAgICAgICAgICAgICBpZiAocXVlc3QucmV3YXJkRXhwID4gMCkgcmV3YXJkcy5leHAgPSArcXVlc3QucmV3YXJkRXhwO1xuICAgICAgICAgICAgICAgIGlmIChxdWVzdC5yZXdhcmRQcmltYXJ5QWJpbGl0eSkgcmV3YXJkcy5hYmlsaXR5ID0gcXVlc3QucmV3YXJkUHJpbWFyeUFiaWxpdHk7XG5cbiAgICAgICAgICAgICAgICAvLyBzdGF0c1xuICAgICAgICAgICAgICAgIGxldCBzdGF0czogQkFTRV9TVEFUU19NT0RFTCA9IHt9O1xuICAgICAgICAgICAgICAgIGlmIChxdWVzdC5yZXdhcmRTVFIgPiAwKSBzdGF0cy5zdHIgPSArcXVlc3QucmV3YXJkU1RSO1xuICAgICAgICAgICAgICAgIGlmIChxdWVzdC5yZXdhcmRNQUcgPiAwKSBzdGF0cy5tYWcgPSArcXVlc3QucmV3YXJkTUFHO1xuICAgICAgICAgICAgICAgIGlmIChxdWVzdC5yZXdhcmRERVggPiAwKSBzdGF0cy5kZXggPSArcXVlc3QucmV3YXJkREVYO1xuICAgICAgICAgICAgICAgIGlmIChxdWVzdC5yZXdhcmRIUCA+IDApIHN0YXRzLmhwID0gK3F1ZXN0LnJld2FyZEhQO1xuICAgICAgICAgICAgICAgIGlmIChxdWVzdC5yZXdhcmRNUCA+IDApIHN0YXRzLm1wID0gK3F1ZXN0LnJld2FyZE1QO1xuICAgICAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KHN0YXRzKSkge1xuICAgICAgICAgICAgICAgICAgICByZXdhcmRzLnN0YXRzID0gc3RhdHM7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8gaXRlbXNcbiAgICAgICAgICAgICAgICBsZXQgaXRlbXMgPSBbXTtcbiAgICAgICAgICAgICAgICAocXVlc3QucmV3YXJkSXRlbXMgfHwgW10pLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCByZXdhcmRJdGVtOiBJVEVNX0lOU1RBTkNFID0geyBrZXk6IGl0ZW0ua2V5IH07XG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLnN0YWNrID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV3YXJkSXRlbS5zdGFjayA9ICtpdGVtLnN0YWNrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGl0ZW1zLnB1c2gocmV3YXJkSXRlbSk7XG4gICAgICAgICAgICAgICAgICAgIHJld2FyZHMuaXRlbXMgPSBpdGVtcztcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShyZXdhcmRzKSkge1xuICAgICAgICAgICAgICAgICAgICBxdWVzdFNjaGVtYS5yZXdhcmQgPSByZXdhcmRzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuXHRcdFx0bGV0IHF1ZXN0TW9kZWwgPSBuZXcgdGhpcy5Nb2RlbChxdWVzdFNjaGVtYSk7XG5cdFx0XHRtb2RlbHMucHVzaChxdWVzdE1vZGVsKTtcblx0XHR9KTtcblxuXHRcdHJldHVybiB0aGlzLk1vZGVsLnJlbW92ZSh7fSlcblx0XHRcdC50aGVuKGQgPT4gdGhpcy5Nb2RlbC5jcmVhdGUobW9kZWxzKSk7XG5cdH1cblxuXHRwdWJsaWMgZ2V0UXVlc3RJbmZvKGtleTogc3RyaW5nKTogUVVFU1RfTU9ERUx8dW5kZWZpbmVkIHtcblx0XHRyZXR1cm4gdGhpcy5xdWVzdHNJbmZvLmdldChrZXkpO1xuXHR9XG5cbiAgICBwdWJsaWMgZ2V0UXVlc3RzKCk6IFByb21pc2U8TWFwPHN0cmluZywgUVVFU1RfTU9ERUw+PiB7XG5cdFx0cmV0dXJuIHRoaXMuTW9kZWwuZmluZCh7fSkubGVhbigpXG5cdFx0XHQudGhlbigoZG9jczogUVVFU1RfTU9ERUxbXSkgPT4ge1xuXHRcdFx0XHRkb2NzLmZvckVhY2goZG9jID0+IHtcblx0XHRcdFx0XHR0aGlzLnF1ZXN0c0luZm8uc2V0KGRvYy5rZXksIGRvYyk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRjb25zb2xlLmxvZyhcImdvdCBxdWVzdHNcIik7XG5cdFx0XHRcdHJldHVybiB0aGlzLnF1ZXN0c0luZm87XG5cdFx0XHR9KTtcblx0fVxufTsiXX0=
