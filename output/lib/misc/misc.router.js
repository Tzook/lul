'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const socketio_router_base_1 = require("../socketio/socketio.router.base");
let dropsConfig = require('../../../server/lib/drops/drops.config.json');
let itemsConfig = require('../../../server/lib/items/items.config.json');
let config = require('../../../server/lib/misc/misc.config.json');
class MiscRouter extends socketio_router_base_1.default {
    init(files, app) {
        super.init(files, app);
        this.itemsRouter = files.routers.items;
    }
    [config.SERVER_GETS.ITEM_PICK.name](data, socket) {
        this.emitter.emit(dropsConfig.SERVER_INNER.ITEM_PICK.name, data, socket, (item) => {
            let itemInfo = this.itemsRouter.getItemInfo(item.key);
            if (!this.middleware.isMisc(itemInfo)) {
                return;
            }
            let slots = this.middleware.getStackSlots(socket, item, itemInfo);
            console.log("picking up item for slots", item, slots);
            if (slots.length === 0) {
                this.sendError(data, socket, itemsConfig.LOGS.INVENTORY_FULL.MSG, true, true);
            }
            else {
                this.controller.pickMiscItem(socket, slots, item, itemInfo);
                return true;
            }
        });
    }
    [config.SERVER_INNER.ITEM_ADD.name](data, socket) {
        let { slots, item } = data;
        let itemInfo = this.itemsRouter.getItemInfo(item.key);
        if (this.middleware.isMisc(itemInfo)) {
            this.controller.pickMiscItem(socket, slots, item, itemInfo);
        }
    }
    [config.SERVER_INNER.ITEM_REMOVE.name](data, socket) {
        let { stack, key } = data.item;
        let itemInfo = this.itemsRouter.getItemInfo(key);
        if (this.middleware.isMisc(itemInfo)) {
            for (let slot = 0; slot < socket.character.items.length; slot++) {
                let item = socket.character.items[slot];
                if (item.key === key) {
                    if (item.stack <= stack) {
                        stack -= item.stack;
                        this.itemsRouter.deleteItem(socket, slot);
                    }
                    else {
                        item.stack -= stack;
                        stack = 0;
                        socket.emit(config.CLIENT_GETS.STACK_CHANGE.name, { slot, amount: item.stack });
                    }
                    if (stack === 0) {
                        break;
                    }
                }
            }
        }
    }
    [config.SERVER_GETS.MISC_DROP.name](data, socket) {
    }
}
exports.default = MiscRouter;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NlcnZlci9saWIvbWlzYy9taXNjLnJvdXRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7O0FBQ2IsMkVBQWtFO0FBS2xFLElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO0FBQ3pFLElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO0FBQ3pFLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDO0FBRWxFLGdCQUFnQyxTQUFRLDhCQUFrQjtJQUt6RCxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUc7UUFDZCxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztRQUN2QixJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO0lBQ3hDLENBQUM7SUFFRCxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxNQUFrQjtRQUMzRCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDLElBQW1CO1lBQ25GLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN0RCxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDcEMsTUFBTSxDQUFDO1lBQ1gsQ0FBQztZQUNELElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFFbEUsT0FBTyxDQUFDLEdBQUcsQ0FB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QUVELENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLE1BQWtCO0lBc0I1RCxDQUFDO0NBQ0Q7QUFsRkQsNkJBa0ZDO0FBQUEsQ0FBQyIsImZpbGUiOiJsaWIvbWlzYy9taXNjLnJvdXRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcbmltcG9ydCBTb2NrZXRpb1JvdXRlckJhc2UgZnJvbSAnLi4vc29ja2V0aW8vc29ja2V0aW8ucm91dGVyLmJhc2UnO1xuaW1wb3J0IEl0ZW1zUm91dGVyIGZyb20gJy4uL2l0ZW1zL2l0ZW1zLnJvdXRlcic7XG5pbXBvcnQgTWlzY01pZGRsZXdhcmUgZnJvbSBcIi4vbWlzYy5taWRkbGV3YXJlXCI7XG5pbXBvcnQgTWlzY0NvbnRyb2xsZXIgZnJvbSBcIi4vbWlzYy5jb250cm9sbGVyXCI7XG5cbmxldCBkcm9wc0NvbmZpZyA9IHJlcXVpcmUoJy4uLy4uLy4uL3NlcnZlci9saWIvZHJvcHMvZHJvcHMuY29uZmlnLmpzb24nKTtcbmxldCBpdGVtc0NvbmZpZyA9IHJlcXVpcmUoJy4uLy4uLy4uL3NlcnZlci9saWIvaXRlbXMvaXRlbXMuY29uZmlnLmpzb24nKTtcbmxldCBjb25maWcgPSByZXF1aXJlKCcuLi8uLi8uLi9zZXJ2ZXIvbGliL21pc2MvbWlzYy5jb25maWcuanNvbicpO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNaXNjUm91dGVyIGV4dGVuZHMgU29ja2V0aW9Sb3V0ZXJCYXNlIHtcblx0cHJvdGVjdGVkIGl0ZW1zUm91dGVyOiBJdGVtc1JvdXRlcjtcbiAgICBwcm90ZWN0ZWQgbWlkZGxld2FyZTogTWlzY01pZGRsZXdhcmU7XG4gICAgcHJvdGVjdGVkIGNvbnRyb2xsZXI6IE1pc2NDb250cm9sbGVyO1xuXHRcblx0aW5pdChmaWxlcywgYXBwKSB7XG5cdFx0c3VwZXIuaW5pdChmaWxlcywgYXBwKTtcblx0XHR0aGlzLml0ZW1zUm91dGVyID0gZmlsZXMucm91dGVycy5pdGVtcztcblx0fVxuXG5cdFtjb25maWcuU0VSVkVSX0dFVFMuSVRFTV9QSUNLLm5hbWVdKGRhdGEsIHNvY2tldDogR2FtZVNvY2tldCkge1xuXHRcdHRoaXMuZW1pdHRlci5lbWl0KGRyb3BzQ29uZmlnLlNFUlZFUl9JTk5FUi5JVEVNX1BJQ0submFtZSwgZGF0YSwgc29ja2V0LCAoaXRlbTogSVRFTV9JTlNUQU5DRSk6IGFueSA9PiB7XG4gICAgICAgICAgICBsZXQgaXRlbUluZm8gPSB0aGlzLml0ZW1zUm91dGVyLmdldEl0ZW1JbmZvKGl0ZW0ua2V5KTtcbiAgICAgICAgICAgIGlmICghdGhpcy5taWRkbGV3YXJlLmlzTWlzYyhpdGVtSW5mbykpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsZXQgc2xvdHMgPSB0aGlzLm1pZGRsZXdhcmUuZ2V0U3RhY2tTbG90cyhzb2NrZXQsIGl0ZW0sIGl0ZW1JbmZvKTtcblxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJwaWNraW5nIHVwIGl0ZW0gZm9yIHNsb3RzXCIsIGl0ZW0sIHNsb3RzKTtcbiAgICAgICAgICAgIGlmIChzbG90cy5sZW5ndGggPT09IDApIHsgXG4gICAgICAgICAgICAgICAgdGhpcy5zZW5kRXJyb3IoZGF0YSwgc29ja2V0LCBpdGVtc0NvbmZpZy5MT0dTLklOVkVOVE9SWV9GVUxMLk1TRywgdHJ1ZSwgdHJ1ZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5waWNrTWlzY0l0ZW0oc29ja2V0LCBzbG90cywgaXRlbSwgaXRlbUluZm8pO1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVx0XG5cdFx0fSk7XG5cdH1cblxuXHRbY29uZmlnLlNFUlZFUl9JTk5FUi5JVEVNX0FERC5uYW1lXShkYXRhOiB7c2xvdHM6IG51bWJlcltdLCBpdGVtOiBJVEVNX0lOU1RBTkNFfSwgc29ja2V0OiBHYW1lU29ja2V0KSB7XG5cdFx0bGV0IHtzbG90cywgaXRlbX0gPSBkYXRhO1xuXHRcdGxldCBpdGVtSW5mbyA9IHRoaXMuaXRlbXNSb3V0ZXIuZ2V0SXRlbUluZm8oaXRlbS5rZXkpO1xuICAgICAgICBpZiAodGhpcy5taWRkbGV3YXJlLmlzTWlzYyhpdGVtSW5mbykpIHtcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5waWNrTWlzY0l0ZW0oc29ja2V0LCBzbG90cywgaXRlbSwgaXRlbUluZm8pO1xuICAgICAgICB9XG5cdH1cblxuXHRbY29uZmlnLlNFUlZFUl9JTk5FUi5JVEVNX1JFTU9WRS5uYW1lXShkYXRhOiB7aXRlbTogSVRFTV9JTlNUQU5DRX0sIHNvY2tldDogR2FtZVNvY2tldCkge1xuXHRcdGxldCB7c3RhY2ssIGtleX0gPSBkYXRhLml0ZW07XG5cdFx0bGV0IGl0ZW1JbmZvID0gdGhpcy5pdGVtc1JvdXRlci5nZXRJdGVtSW5mbyhrZXkpO1xuXHRcdGlmICh0aGlzLm1pZGRsZXdhcmUuaXNNaXNjKGl0ZW1JbmZvKSkge1xuXHRcdFx0Zm9yIChsZXQgc2xvdCA9IDA7IHNsb3QgPCBzb2NrZXQuY2hhcmFjdGVyLml0ZW1zLmxlbmd0aDsgc2xvdCsrKSB7XG5cdFx0XHRcdGxldCBpdGVtID0gc29ja2V0LmNoYXJhY3Rlci5pdGVtc1tzbG90XTtcblx0XHRcdFx0aWYgKGl0ZW0ua2V5ID09PSBrZXkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uc3RhY2sgPD0gc3RhY2spIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YWNrIC09IGl0ZW0uc3RhY2s7XG5cdFx0XHRcdFx0ICAgIHRoaXMuaXRlbXNSb3V0ZXIuZGVsZXRlSXRlbShzb2NrZXQsIHNsb3QpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5zdGFjayAtPSBzdGFjaztcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YWNrID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNvY2tldC5lbWl0KGNvbmZpZy5DTElFTlRfR0VUUy5TVEFDS19DSEFOR0UubmFtZSwgeyBzbG90LCBhbW91bnQ6IGl0ZW0uc3RhY2sgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblx0XHRcdFx0XHRpZiAoc3RhY2sgPT09IDApIHtcblx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdFtjb25maWcuU0VSVkVSX0dFVFMuTUlTQ19EUk9QLm5hbWVdKGRhdGEsIHNvY2tldDogR2FtZVNvY2tldCkge1xuICAgICAgICAvLyBsZXQge3Nsb3QsIHN0YWNrfSA9IGRhdGE7XG4gICAgICAgIC8vIGlmICghKHN0YWNrID4gMCkpIHtcblx0XHQvLyBcdHRoaXMuc2VuZEVycm9yKGRhdGEsIHNvY2tldCwgXCJNdXN0IG1lbnRpb24gd2hhdCBzdGFjayBhbW91bnQgdG8gdGhyb3dcIik7XG4gICAgICAgIC8vIH0gZWxzZSBpZiAoIXRoaXMubWlkZGxld2FyZS5oYXNJdGVtKHNvY2tldCwgc2xvdCkpIHtcblx0XHQvLyBcdHRoaXMuc2VuZEVycm9yKGRhdGEsIHNvY2tldCwgXCJUcnlpbmcgdG8gZHJvcCBhbiBpdGVtIGJ1dCBub3RoaW5nJ3MgdGhlcmUhXCIpO1xuXHRcdC8vIH0gZWxzZSB7XG5cdFx0Ly8gXHRsZXQgaXRlbSA9IHNvY2tldC5jaGFyYWN0ZXIuaXRlbXNbc2xvdF07XG4gICAgICAgIC8vICAgICBsZXQgaXRlbVRvRHJvcCA9IE9iamVjdC5hc3NpZ24oe30sIGl0ZW0pO1xuICAgICAgICAvLyAgICAgaWYgKHN0YWNrID49IGl0ZW0uc3RhY2spIHtcbiAgICAgICAgLy8gICAgICAgICBzb2NrZXQuY2hhcmFjdGVyLml0ZW1zLnNldChzbG90LCB7fSk7XG4gICAgICAgIC8vICAgICAgICAgc29ja2V0LmVtaXQodGhpcy5DTElFTlRfR0VUUy5JVEVNX0RFTEVURS5uYW1lLCB7IHNsb3QgfSk7XG4gICAgICAgIC8vICAgICAgICAgdGhpcy5taXNjVmFsdWVDaGFuZ2VkKHNvY2tldCwgaXRlbS5rZXksIC1pdGVtLnN0YWNrKTtcbiAgICAgICAgLy8gICAgIH0gZWxzZSB7XG4gICAgICAgIC8vICAgICAgICAgaXRlbS5zdGFjayAtPSBzdGFjaztcbiAgICAgICAgLy8gICAgICAgICBpdGVtVG9Ecm9wLnN0YWNrID0gc3RhY2s7XG4gICAgICAgIC8vICAgICAgICAgc29ja2V0LmVtaXQodGhpcy5DTElFTlRfR0VUUy5TVEFDS19DSEFOR0UubmFtZSwgeyBzbG90LCBhbW91bnQ6IGl0ZW0uc3RhY2sgfSk7XG4gICAgICAgIC8vICAgICAgICAgdGhpcy5taXNjVmFsdWVDaGFuZ2VkKHNvY2tldCwgaXRlbS5rZXksIC1zdGFjayk7XG4gICAgICAgIC8vICAgICB9XG4gICAgICAgIC8vICAgICBjb25zb2xlLmxvZyhcImRyb3BwaW5nIG1pc2MgaXRlbVwiLCBpdGVtVG9Ecm9wKTtcbiAgICAgICAgLy8gICAgIHRoaXMuZW1pdHRlci5lbWl0KGRyb3BzQ29uZmlnLlNFUlZFUl9JTk5FUi5JVEVNU19EUk9QLm5hbWUsIHt9LCBzb2NrZXQsIFtpdGVtXSk7XG5cdFx0Ly8gfVxuXHR9XG59O1xuIl19
