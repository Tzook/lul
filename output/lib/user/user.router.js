'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const master_router_1 = require("../master/master.router");
let passport = require('passport'), LocalStrategy = require('passport-local').Strategy;
const sessionTime = 1000 * 60 * 60 * 24 * 30;
class UserRouter extends master_router_1.default {
    init(files, app) {
        this.usePassport(app, app.session, app.mongoStore, files.controller, files.middleware);
        super.init(files, app);
    }
    initRoutes(app) {
        app.get(this.ROUTES.USER_SESSION, this.middleware.isLoggedIn.bind(this.middleware), this.controller.sendUser.bind(this.controller));
        app.get(this.ROUTES.USER_LOGOUT, this.middleware.isLoggedIn.bind(this.middleware), this.controller.performLogout.bind(this.controller), this.controller.sendLogout.bind(this.controller));
        app.post(this.ROUTES.USER_LOGIN, this.middleware.isLoggedOut.bind(this.middleware), this.middleware.hasLoginParams.bind(this.middleware), this.middleware.passportLocalAuthenticate.bind(this.middleware), this.controller.performLogin.bind(this.controller), this.controller.sendUser.bind(this.controller));
        app.post(this.ROUTES.USER_REGISTER, this.middleware.isLoggedOut.bind(this.middleware), this.middleware.hasRegisterParams.bind(this.middleware), this.middleware.isUsernameUnique.bind(this.middleware), this.controller.handleNewUser.bind(this.controller), this.controller.performLogin.bind(this.controller), this.controller.sendUser.bind(this.controller));
        app.post(this.ROUTES.USER_DELETE, this.middleware.isLoggedIn.bind(this.middleware), this.controller.deleteUser.bind(this.controller), this.controller.performLogout.bind(this.controller), this.controller.sendDeleted.bind(this.controller));
    }
    usePassport(app, session, mongoStore, controller, middleware) {
        app.dependencies.push((session({
            name: 'unicorn',
            secret: 'UnicornsAreAmazingB0ss',
            store: mongoStore,
            cookie: { maxAge: sessionTime },
            saveUninitialized: true,
            resave: true
        })));
        app.use(passport.initialize());
        app.use(passport.authenticate('session', {}, controller.deserializeError.bind(controller)));
        passport.use(new LocalStrategy(middleware.authenticateUser.bind(middleware)));
        passport.serializeUser(controller.serializeUser.bind(controller));
        passport.deserializeUser(controller.deserializeUser.bind(controller));
    }
}
exports.default = UserRouter;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NlcnZlci9saWIvdXNlci91c2VyLnJvdXRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7O0FBQ2IsMkRBQW1EO0FBR25ELElBQUksUUFBUSxHQUFVLE9BQU8sQ0FBQyxVQUFVLENBQUMsRUFDckMsYUFBYSxHQUFLLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLFFBQVEsQ0FBQztBQUV6RCxNQUFNLFdBQVcsR0FBRyxJQUFJLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDO0FBRTdDLGdCQUFnQyxTQUFRLHVCQUFZO0lBSW5ELElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRztRQUNkLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN2RixLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztJQUN4QixDQUFDO0lBRVMsVUFBVSxDQUFDLEdBQUc7UUFDdkIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksRUFDL0IsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFDaEQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBRWpELEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQzlCLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQ2hELElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMs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QUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4RSxRQUFRLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7UUFDbEUsUUFBUSxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQzdFLENBQUM7Q0FDRDtBQXhERCw2QkF3REM7QUFBQSxDQUFDIiwiZmlsZSI6ImxpYi91c2VyL3VzZXIucm91dGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuaW1wb3J0IE1hc3RlclJvdXRlciBmcm9tICcuLi9tYXN0ZXIvbWFzdGVyLnJvdXRlcic7XG5pbXBvcnQgVXNlckNvbnRyb2xsZXIgZnJvbSBcIi4vdXNlci5jb250cm9sbGVyXCI7XG5pbXBvcnQgVXNlck1pZGRsZXdhcmUgZnJvbSBcIi4vdXNlci5taWRkbGV3YXJlXCI7XG5sZXQgcGFzc3BvcnQgICAgICAgID0gcmVxdWlyZSgncGFzc3BvcnQnKSxcbiAgICBMb2NhbFN0cmF0ZWd5ICAgPSByZXF1aXJlKCdwYXNzcG9ydC1sb2NhbCcpLlN0cmF0ZWd5O1xuXG5jb25zdCBzZXNzaW9uVGltZSA9IDEwMDAgKiA2MCAqIDYwICogMjQgKiAzMDsgLy8gMzAgZGF5c1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBVc2VyUm91dGVyIGV4dGVuZHMgTWFzdGVyUm91dGVyIHtcblx0cHJvdGVjdGVkIGNvbnRyb2xsZXI6IFVzZXJDb250cm9sbGVyO1xuXHRwcm90ZWN0ZWQgbWlkZGxld2FyZTogVXNlck1pZGRsZXdhcmU7XG5cblx0aW5pdChmaWxlcywgYXBwKSB7XG5cdFx0dGhpcy51c2VQYXNzcG9ydChhcHAsIGFwcC5zZXNzaW9uLCBhcHAubW9uZ29TdG9yZSwgZmlsZXMuY29udHJvbGxlciwgZmlsZXMubWlkZGxld2FyZSk7XG5cdFx0c3VwZXIuaW5pdChmaWxlcywgYXBwKTtcblx0fVxuXG5cdHByb3RlY3RlZCBpbml0Um91dGVzKGFwcCkge1xuXHRcdGFwcC5nZXQodGhpcy5ST1VURVMuVVNFUl9TRVNTSU9OLFxuXHRcdFx0dGhpcy5taWRkbGV3YXJlLmlzTG9nZ2VkSW4uYmluZCh0aGlzLm1pZGRsZXdhcmUpLFxuXHRcdFx0dGhpcy5jb250cm9sbGVyLnNlbmRVc2VyLmJpbmQodGhpcy5jb250cm9sbGVyKSk7XG5cblx0XHRhcHAuZ2V0KHRoaXMuUk9VVEVTLlVTRVJfTE9HT1VULFxuXHRcdFx0dGhpcy5taWRkbGV3YXJlLmlzTG9nZ2VkSW4uYmluZCh0aGlzLm1pZGRsZXdhcmUpLFxuXHRcdFx0dGhpcy5jb250cm9sbGVyLnBlcmZvcm1Mb2dvdXQuYmluZCh0aGlzLmNvbnRyb2xsZXIpLFxuXHRcdFx0dGhpcy5jb250cm9sbGVyLnNlbmRMb2dvdXQuYmluZCh0aGlzLmNvbnRyb2xsZXIpKTtcblxuXHRcdGFwcC5wb3N0KHRoaXMuUk9VVEVTLlVTRVJfTE9HSU4sXG5cdFx0XHR0aGlzLm1pZGRsZXdhcmUuaXNMb2dnZWRPdXQuYmluZCh0aGlzLm1pZGRsZXdhcmUpLFxuXHRcdFx0dGhpcy5taWRkbGV3YXJlLmhhc0xvZ2luUGFyYW1zLmJpbmQodGhpcy5taWRkbGV3YXJlKSxcblx0XHRcdHRoaXMubWlkZGxld2FyZS5wYXNzcG9ydExvY2FsQXV0aGVudGljYXRlLmJpbmQodGhpcy5taWRkbGV3YXJlKSxcblx0XHRcdHRoaXMuY29udHJvbGxlci5wZXJmb3JtTG9naW4uYmluZCh0aGlzLmNvbnRyb2xsZXIpLFxuXHRcdFx0dGhpcy5jb250cm9sbGVyLnNlbmRVc2VyLmJpbmQodGhpcy5jb250cm9sbGVyKSk7XG5cblx0XHRhcHAucG9zdCh0aGlzLlJPVVRFUy5VU0VSX1JFR0lTVEVSLFxuXHRcdFx0dGhpcy5taWRkbGV3YXJlLmlzTG9nZ2VkT3V0LmJpbmQodGhpcy5taWRkbGV3YXJlKSxcblx0XHRcdHRoaXMubWlkZGxld2FyZS5oYXNSZWdpc3RlclBhcmFtcy5iaW5kKHRoaXMubWlkZGxld2FyZSksXG5cdFx0XHR0aGlzLm1pZGRsZXdhcmUuaXNVc2VybmFtZVVuaXF1ZS5iaW5kKHRoaXMubWlkZGxld2FyZSksXG5cdFx0XHR0aGlzLmNvbnRyb2xsZXIuaGFuZGxlTmV3VXNlci5iaW5kKHRoaXMuY29udHJvbGxlciksXG5cdFx0XHR0aGlzLmNvbnRyb2xsZXIucGVyZm9ybUxvZ2luLmJpbmQodGhpcy5jb250cm9sbGVyKSxcblx0XHRcdHRoaXMuY29udHJvbGxlci5zZW5kVXNlci5iaW5kKHRoaXMuY29udHJvbGxlcikpO1xuXG5cdFx0YXBwLnBvc3QodGhpcy5ST1VURVMuVVNFUl9ERUxFVEUsXG5cdFx0XHR0aGlzLm1pZGRsZXdhcmUuaXNMb2dnZWRJbi5iaW5kKHRoaXMubWlkZGxld2FyZSksXG5cdFx0XHR0aGlzLmNvbnRyb2xsZXIuZGVsZXRlVXNlci5iaW5kKHRoaXMuY29udHJvbGxlciksXG5cdFx0XHR0aGlzLmNvbnRyb2xsZXIucGVyZm9ybUxvZ291dC5iaW5kKHRoaXMuY29udHJvbGxlciksXG5cdFx0XHR0aGlzLmNvbnRyb2xsZXIuc2VuZERlbGV0ZWQuYmluZCh0aGlzLmNvbnRyb2xsZXIpKTtcblx0fVxuXG5cdHVzZVBhc3Nwb3J0KGFwcCwgc2Vzc2lvbiwgbW9uZ29TdG9yZSwgY29udHJvbGxlciwgbWlkZGxld2FyZSkge1xuXHRcdC8vIE5PVEU6IGluIHBhc3Nwb3J0J3MgbWlkZGxld2FyZSBsaWJyYXJ5IHVuZGVyIGZpbGUgYXV0aGVudGljYXRlLmpzLCBpIGNoYW5nZWQgdGhlIGNhbGxiYWNrIGNhbGxlZCBvbiBlcnJvciB0byBzZW5kIHRoZSByZXMgdG9vXG5cdFx0YXBwLmRlcGVuZGVuY2llcy5wdXNoKChzZXNzaW9uKHtcblx0XHRcdFx0bmFtZTogJ3VuaWNvcm4nLFxuXHRcdFx0XHRzZWNyZXQ6ICdVbmljb3Juc0FyZUFtYXppbmdCMHNzJyxcblx0XHRcdFx0c3RvcmU6IG1vbmdvU3RvcmUsXG5cdFx0XHRcdGNvb2tpZTogeyBtYXhBZ2U6IHNlc3Npb25UaW1lIH0sXG5cdFx0XHRcdHNhdmVVbmluaXRpYWxpemVkOiB0cnVlLFxuXHRcdFx0XHRyZXNhdmU6IHRydWUgfSkpKTtcblx0XHRhcHAudXNlKHBhc3Nwb3J0LmluaXRpYWxpemUoKSk7XG5cdFx0YXBwLnVzZShwYXNzcG9ydC5hdXRoZW50aWNhdGUoJ3Nlc3Npb24nLCB7fSwgY29udHJvbGxlci5kZXNlcmlhbGl6ZUVycm9yLmJpbmQoY29udHJvbGxlcikpKTtcblx0XHRwYXNzcG9ydC51c2UobmV3IExvY2FsU3RyYXRlZ3kobWlkZGxld2FyZS5hdXRoZW50aWNhdGVVc2VyLmJpbmQobWlkZGxld2FyZSkpKTtcbiAgICAgICAgcGFzc3BvcnQuc2VyaWFsaXplVXNlcihjb250cm9sbGVyLnNlcmlhbGl6ZVVzZXIuYmluZChjb250cm9sbGVyKSk7XG4gICAgICAgIHBhc3Nwb3J0LmRlc2VyaWFsaXplVXNlcihjb250cm9sbGVyLmRlc2VyaWFsaXplVXNlci5iaW5kKGNvbnRyb2xsZXIpKTtcblx0fVxufTsiXX0=
