'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const socketio_router_base_1 = require("../socketio/socketio.router.base");
const _ = require("underscore");
let config = require('../../../server/lib/drops/drops.config.json');
let SERVER_GETS = config.SERVER_GETS;
class DropsRouter extends socketio_router_base_1.default {
    constructor() {
        super(...arguments);
        this.dropsMap = new Map();
    }
    init(files, app) {
        this.itemsRouter = files.routers.items;
        this.partyRouter = files.routers.party;
        this.services = files.services;
        super.init(files, app);
    }
    getRoomMap(socket) {
        let map = this.dropsMap.get(socket.character.room);
        if (!map) {
            map = new Map();
            this.dropsMap.set(socket.character.room, map);
        }
        return map;
    }
    [SERVER_GETS.ENTERED_ROOM.name](data, socket) {
        this.getRoomMap(socket).forEach(itemData => {
            socket.emit(this.CLIENT_GETS.ITEMS_DROP.name, [itemData]);
        });
    }
    [config.SERVER_INNER.ITEM_PICK.name](data, socket, pickItemFn) {
        let itemId = data.item_id;
        let map = this.getRoomMap(socket);
        if (!map.has(itemId)) {
            if (this.lastHandledItem !== itemId) {
                this.sendError(data, socket, "Item does not exist");
            }
            return;
        }
        let itemDrop = map.get(itemId);
        let owner = itemDrop.owner;
        if (owner && (owner !== socket.character.name && !this.partyRouter.arePartyMembers(owner, socket.character.name))) {
            return this.sendError(data, socket, `Item owner is ${owner} and you are ${socket.character.name}.`);
        }
        let picked = pickItemFn(itemDrop.item);
        if (picked) {
            console.log('picking item', data.item_id);
            map.delete(itemId);
            this.lastHandledItem = itemId;
            this.io.to(socket.character.room).emit(this.CLIENT_GETS.ITEM_PICK.name, {
                id: socket.character._id,
                item_id: data.item_id,
            });
        }
    }
    [config.SERVER_INNER.GENERATE_DROPS.name](data, socket, drops) {
        let items = [];
        drops.forEach(drop => {
            let itemInfo = this.itemsRouter.getItemInfo(drop.key);
            if (itemInfo) {
                let isDropped = this.controller.isDropped(itemInfo.chance);
                if (isDropped) {
                    let itemInstance = this.itemsRouter.getItemInstance(drop.key);
                    if (itemInfo.cap > 1) {
                        itemInstance.stack = this.services.getRandomStack(drop.minStack, drop.maxStack);
                    }
                    items.push(itemInstance);
                    console.log("Dropping item from drop!", drop, itemInstance);
                }
            }
            else {
                this.sendError({ key: drop }, socket, "No item info! cannot drop item.");
            }
        });
        if (items.length > 0) {
            this.emitter.emit(config.SERVER_INNER.ITEMS_DROP.name, data, socket, items);
        }
    }
    [config.SERVER_INNER.ITEMS_DROP.name](data, socket, items) {
        let room = socket.character.room;
        let itemsData = [];
        let map = this.getRoomMap(socket);
        items = JSON.parse(JSON.stringify(items));
        items.forEach(item => {
            let itemId = _.uniqueId("item-");
            let itemData = {
                x: data.x || socket.character.position.x,
                y: data.y || socket.character.position.y,
                item_id: itemId,
                item
            };
            map.set(itemId, itemData);
            itemsData[itemsData.length] = itemData;
            setTimeout(() => {
                if (map.has(itemId)) {
                    map.delete(itemId);
                    console.log('removing item', itemId);
                    this.io.to(room).emit(this.CLIENT_GETS.ITEM_DISAPPEAR.name, {
                        item_id: itemId
                    });
                }
            }, config.ITEM_DROP_LIFE_TIME);
            if (data.owner) {
                itemData.owner = data.owner;
                setTimeout(() => {
                    let item = map.get(itemId);
                    if (item) {
                        delete item.owner;
                        console.log('removing owner from item', itemId);
                        this.io.to(room).emit(this.CLIENT_GETS.ITEM_OWNER_GONE.name, {
                            item_id: itemId
                        });
                    }
                }, config.ITEM_DROP_OWN_TIME);
            }
        });
        if (itemsData.length > 0) {
            this.io.to(room).emit(this.CLIENT_GETS.ITEMS_DROP.name, itemsData);
        }
    }
    [SERVER_GETS.ITEMS_LOCATIONS.name](data, socket) {
        let items = data.items;
        if (!_.isArray(items)) {
            return this.sendError(data, socket, "Must provide an array of items to update locations");
        }
        let updatedItems = [];
        let map = this.getRoomMap(socket);
        items.forEach(item => {
            let itemData;
            if (!_.isObject(item)) {
                this.sendError(data, socket, "Must provide an object to update locations");
            }
            else if (!(itemData = map.get(item.item_id))) {
                this.sendError(data, socket, `Item with given item_id ${item.item_id} was not found`);
            }
            else if (!_.isFinite(item.x) || !_.isFinite(item.y)) {
                this.sendError(data, socket, `Item with item_id ${item.item_id} received invalid x and y`);
            }
            else {
                itemData.x = item.x;
                itemData.y = item.y;
                updatedItems.push(item);
            }
        });
        if (updatedItems.length > 0) {
            socket.broadcast.to(socket.character.room).emit(this.CLIENT_GETS.ITEMS_LOCATIONS.name, updatedItems);
        }
    }
}
exports.default = DropsRouter;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NlcnZlci9saWIvZHJvcHMvZHJvcHMucm91dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7QUFDYiwyRUFBa0U7QUFDbEUsZ0NBQWdDO0FBS2hDLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO0FBQ3BFLElBQUksV0FBVyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUM7QUFFckMsaUJBQWlDLFNBQVEsOEJBQWtCO0lBQTNEOztRQUNZLGFBQVEsR0FBd0MsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQTBKdEUsQ0FBQztJQW5KQSxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUc7UUFDZCxJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7UUFDN0MsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDO1FBQy9CLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3hCLENBQUM7SUFFTyxVQUFVLENBQUMsTUFBa0I7UUFDcEMsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuRCxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDVixHQUFHLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUNoQixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztRQUMvQyxDQUFDO1FBQ0QsTUFBTSxDQUFDLEdBQUcsQ0FBQztJQUNaLENBQUM7SUFFRCxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFD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Q0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7Z0JBQ3BCLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDekIsQ0FBQztRQUNGLENBQUMsQ0FBQyxDQUFDO1FBQ0gsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdCLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztRQUN0RyxDQUFDO0lBQ0YsQ0FBQztDQUNEO0FBM0pELDhCQTJKQztBQUFBLENBQUMiLCJmaWxlIjoibGliL2Ryb3BzL2Ryb3BzLnJvdXRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcbmltcG9ydCBTb2NrZXRpb1JvdXRlckJhc2UgZnJvbSAnLi4vc29ja2V0aW8vc29ja2V0aW8ucm91dGVyLmJhc2UnO1xuaW1wb3J0ICogYXMgXyBmcm9tICd1bmRlcnNjb3JlJztcbmltcG9ydCBEcm9wc0NvbnRyb2xsZXIgZnJvbSBcIi4vZHJvcHMuY29udHJvbGxlclwiO1xuaW1wb3J0IEl0ZW1zUm91dGVyIGZyb20gJy4uL2l0ZW1zL2l0ZW1zLnJvdXRlcic7XG5pbXBvcnQgRHJvcHNTZXJ2aWNlcyBmcm9tICcuL2Ryb3BzLnNlcnZpY2VzJztcbmltcG9ydCBQYXJ0eVJvdXRlciBmcm9tICcuLi9wYXJ0eS9wYXJ0eS5yb3V0ZXInO1xubGV0IGNvbmZpZyA9IHJlcXVpcmUoJy4uLy4uLy4uL3NlcnZlci9saWIvZHJvcHMvZHJvcHMuY29uZmlnLmpzb24nKTtcbmxldCBTRVJWRVJfR0VUUyA9IGNvbmZpZy5TRVJWRVJfR0VUUztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRHJvcHNSb3V0ZXIgZXh0ZW5kcyBTb2NrZXRpb1JvdXRlckJhc2Uge1xuICAgIHByaXZhdGUgZHJvcHNNYXA6IE1hcDxzdHJpbmcsIE1hcDxzdHJpbmcsIElURU1fRFJPUD4+ID0gbmV3IE1hcCgpO1xuXHRwcml2YXRlIGxhc3RIYW5kbGVkSXRlbTogc3RyaW5nO1xuICAgIHByb3RlY3RlZCBjb250cm9sbGVyOiBEcm9wc0NvbnRyb2xsZXI7XG4gICAgcHJvdGVjdGVkIHNlcnZpY2VzOiBEcm9wc1NlcnZpY2VzO1xuICAgIHByb3RlY3RlZCBpdGVtc1JvdXRlcjogSXRlbXNSb3V0ZXI7XG4gICAgcHJvdGVjdGVkIHBhcnR5Um91dGVyOiBQYXJ0eVJvdXRlcjtcblx0XG5cdGluaXQoZmlsZXMsIGFwcCkge1xuXHRcdHRoaXMuaXRlbXNSb3V0ZXIgPSBmaWxlcy5yb3V0ZXJzLml0ZW1zO1xuICAgICAgICB0aGlzLnBhcnR5Um91dGVyID0gZmlsZXMucm91dGVycy5wYXJ0eTtcblx0XHR0aGlzLnNlcnZpY2VzID0gZmlsZXMuc2VydmljZXM7XG5cdFx0c3VwZXIuaW5pdChmaWxlcywgYXBwKTtcblx0fVxuXG5cdHByaXZhdGUgZ2V0Um9vbU1hcChzb2NrZXQ6IEdhbWVTb2NrZXQpIHtcblx0XHRsZXQgbWFwID0gdGhpcy5kcm9wc01hcC5nZXQoc29ja2V0LmNoYXJhY3Rlci5yb29tKTtcblx0XHRpZiAoIW1hcCkge1xuXHRcdFx0bWFwID0gbmV3IE1hcCgpO1xuXHRcdFx0dGhpcy5kcm9wc01hcC5zZXQoc29ja2V0LmNoYXJhY3Rlci5yb29tLCBtYXApO1xuXHRcdH1cblx0XHRyZXR1cm4gbWFwO1xuXHR9XG5cblx0W1NFUlZFUl9HRVRTLkVOVEVSRURfUk9PTS5uYW1lXShkYXRhLCBzb2NrZXQ6IEdhbWVTb2NrZXQpIHtcblx0XHR0aGlzLmdldFJvb21NYXAoc29ja2V0KS5mb3JFYWNoKGl0ZW1EYXRhID0+IHtcblx0XHRcdHNvY2tldC5lbWl0KHRoaXMuQ0xJRU5UX0dFVFMuSVRFTVNfRFJPUC5uYW1lLCBbaXRlbURhdGFdKTtcblx0XHR9KTtcblx0fVxuXG4gICAgW2NvbmZpZy5TRVJWRVJfSU5ORVIuSVRFTV9QSUNLLm5hbWVdKGRhdGEsIHNvY2tldDogR2FtZVNvY2tldCwgcGlja0l0ZW1GbjogKGl0ZW06IElURU1fSU5TVEFOQ0UpID0+IHt9KSB7XG5cdFx0bGV0IGl0ZW1JZDogc3RyaW5nID0gZGF0YS5pdGVtX2lkO1xuXHRcdGxldCBtYXAgPSB0aGlzLmdldFJvb21NYXAoc29ja2V0KTtcblx0XHRpZiAoIW1hcC5oYXMoaXRlbUlkKSkge1xuXHRcdFx0aWYgKHRoaXMubGFzdEhhbmRsZWRJdGVtICE9PSBpdGVtSWQpIHtcblx0XHRcdFx0Ly8gdGhlIHBpY2t1cCBldmVudCBoYXBwZW5zIG11bHRpcGxlIHRpbWVzIHNvIGlmIHdlIGFyZSBzdGlsbCBpbiB0aGUgc2FtZSBoYW5kbGluZyBwcm9jZXNzLCBkb24ndCBjb3VudCBpdCBhcyBhbiBlcnJvclxuXHRcdFx0XHR0aGlzLnNlbmRFcnJvcihkYXRhLCBzb2NrZXQsIFwiSXRlbSBkb2VzIG5vdCBleGlzdFwiKTtcblx0XHRcdH1cbiAgICAgICAgICAgIHJldHVybjtcblx0XHR9XG4gICAgICAgIGxldCBpdGVtRHJvcCA9IG1hcC5nZXQoaXRlbUlkKTtcbiAgICAgICAgbGV0IG93bmVyID0gaXRlbURyb3Aub3duZXI7XG4gICAgICAgIGlmIChvd25lciAmJiAob3duZXIgIT09IHNvY2tldC5jaGFyYWN0ZXIubmFtZSAmJiAhdGhpcy5wYXJ0eVJvdXRlci5hcmVQYXJ0eU1lbWJlcnMob3duZXIsIHNvY2tldC5jaGFyYWN0ZXIubmFtZSkpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZW5kRXJyb3IoZGF0YSwgc29ja2V0LCBgSXRlbSBvd25lciBpcyAke293bmVyfSBhbmQgeW91IGFyZSAke3NvY2tldC5jaGFyYWN0ZXIubmFtZX0uYCk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHBpY2tlZCA9IHBpY2tJdGVtRm4oaXRlbURyb3AuaXRlbSk7XG4gICAgICAgIGlmIChwaWNrZWQpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdwaWNraW5nIGl0ZW0nLCBkYXRhLml0ZW1faWQpO1xuICAgICAgICAgICAgbWFwLmRlbGV0ZShpdGVtSWQpO1xuICAgICAgICAgICAgdGhpcy5sYXN0SGFuZGxlZEl0ZW0gPSBpdGVtSWQ7XG4gICAgICAgICAgICB0aGlzLmlvLnRvKHNvY2tldC5jaGFyYWN0ZXIucm9vbSkuZW1pdCh0aGlzLkNMSUVOVF9HRVRTLklURU1fUElDSy5uYW1lLCB7XG4gICAgICAgICAgICAgICAgaWQ6IHNvY2tldC5jaGFyYWN0ZXIuX2lkLFxuICAgICAgICAgICAgICAgIGl0ZW1faWQ6IGRhdGEuaXRlbV9pZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cdH1cblxuICAgIFtjb25maWcuU0VSVkVSX0lOTkVSLkdFTkVSQVRFX0RST1BTLm5hbWVdKGRhdGEsIHNvY2tldDogR2FtZVNvY2tldCwgZHJvcHM6IERST1BfTU9ERUxbXSkge1xuICAgICAgICBsZXQgaXRlbXMgPSBbXTtcbiAgICAgICAgZHJvcHMuZm9yRWFjaChkcm9wID0+IHtcblx0XHRcdGxldCBpdGVtSW5mbyA9IHRoaXMuaXRlbXNSb3V0ZXIuZ2V0SXRlbUluZm8oZHJvcC5rZXkpO1xuXHRcdFx0aWYgKGl0ZW1JbmZvKSB7XG5cdFx0XHRcdGxldCBpc0Ryb3BwZWQgPSB0aGlzLmNvbnRyb2xsZXIuaXNEcm9wcGVkKGl0ZW1JbmZvLmNoYW5jZSk7XG5cdFx0XHRcdGlmIChpc0Ryb3BwZWQpIHtcblx0XHRcdFx0XHRsZXQgaXRlbUluc3RhbmNlID0gdGhpcy5pdGVtc1JvdXRlci5nZXRJdGVtSW5zdGFuY2UoZHJvcC5rZXkpO1xuXHRcdFx0XHRcdGlmIChpdGVtSW5mby5jYXAgPiAxKSB7XG5cdFx0XHRcdFx0XHRpdGVtSW5zdGFuY2Uuc3RhY2sgPSB0aGlzLnNlcnZpY2VzLmdldFJhbmRvbVN0YWNrKGRyb3AubWluU3RhY2ssIGRyb3AubWF4U3RhY2spO1xuXHRcdFx0XHRcdH1cbiAgICAgICAgICAgICAgICAgICAgaXRlbXMucHVzaChpdGVtSW5zdGFuY2UpO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkRyb3BwaW5nIGl0ZW0gZnJvbSBkcm9wIVwiLCBkcm9wLCBpdGVtSW5zdGFuY2UpO1xuICAgICAgICAgICAgICAgIH1cblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHRoaXMuc2VuZEVycm9yKHtrZXk6IGRyb3B9LCBzb2NrZXQsIFwiTm8gaXRlbSBpbmZvISBjYW5ub3QgZHJvcCBpdGVtLlwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKGl0ZW1zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHRoaXMuZW1pdHRlci5lbWl0KGNvbmZpZy5TRVJWRVJfSU5ORVIuSVRFTVNfRFJPUC5uYW1lLCBkYXRhLCBzb2NrZXQsIGl0ZW1zKTtcbiAgICAgICAgfVxuXHR9XG5cbiAgICBbY29uZmlnLlNFUlZFUl9JTk5FUi5JVEVNU19EUk9QLm5hbWVdKGRhdGEsIHNvY2tldDogR2FtZVNvY2tldCwgaXRlbXM6IElURU1fSU5TVEFOQ0VbXSkge1xuXHRcdGxldCByb29tID0gc29ja2V0LmNoYXJhY3Rlci5yb29tO1xuXHRcdGxldCBpdGVtc0RhdGEgPSBbXTtcblx0XHRsZXQgbWFwID0gdGhpcy5nZXRSb29tTWFwKHNvY2tldCk7XG5cdFx0Ly8gY29udmVydCB0aGUgaXRlbXMgdG8gcGxhaW4gb2JqZWN0c1xuXHRcdGl0ZW1zID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShpdGVtcykpO1xuXHRcdFxuXHRcdGl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG5cdFx0XHRsZXQgaXRlbUlkID0gXy51bmlxdWVJZChcIml0ZW0tXCIpO1xuXHRcdFx0bGV0IGl0ZW1EYXRhOiBJVEVNX0RST1AgPSB7XG5cdFx0XHRcdHg6IGRhdGEueCB8fCBzb2NrZXQuY2hhcmFjdGVyLnBvc2l0aW9uLngsXG5cdFx0XHRcdHk6IGRhdGEueSB8fCBzb2NrZXQuY2hhcmFjdGVyLnBvc2l0aW9uLnksXG5cdFx0XHRcdGl0ZW1faWQ6IGl0ZW1JZCxcblx0XHRcdFx0aXRlbVxuXHRcdFx0fTtcblx0XHRcdG1hcC5zZXQoaXRlbUlkLCBpdGVtRGF0YSk7XG5cdFx0XHRpdGVtc0RhdGFbaXRlbXNEYXRhLmxlbmd0aF0gPSBpdGVtRGF0YTtcblxuXHRcdFx0c2V0VGltZW91dCgoKSA9PiB7XG5cdFx0XHRcdGlmIChtYXAuaGFzKGl0ZW1JZCkpIHtcblx0XHRcdFx0XHRtYXAuZGVsZXRlKGl0ZW1JZCk7XG5cdFx0XHRcdFx0Y29uc29sZS5sb2coJ3JlbW92aW5nIGl0ZW0nLCBpdGVtSWQpO1xuXHRcdFx0XHRcdHRoaXMuaW8udG8ocm9vbSkuZW1pdCh0aGlzLkNMSUVOVF9HRVRTLklURU1fRElTQVBQRUFSLm5hbWUsIHtcblx0XHRcdFx0XHRcdGl0ZW1faWQ6IGl0ZW1JZFxuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9XG5cdFx0XHR9LCBjb25maWcuSVRFTV9EUk9QX0xJRkVfVElNRSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChkYXRhLm93bmVyKSB7XG4gICAgICAgICAgICAgICAgaXRlbURhdGEub3duZXIgPSBkYXRhLm93bmVyO1xuXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBpdGVtID0gbWFwLmdldChpdGVtSWQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGl0ZW0ub3duZXI7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygncmVtb3Zpbmcgb3duZXIgZnJvbSBpdGVtJywgaXRlbUlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW8udG8ocm9vbSkuZW1pdCh0aGlzLkNMSUVOVF9HRVRTLklURU1fT1dORVJfR09ORS5uYW1lLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbV9pZDogaXRlbUlkXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sIGNvbmZpZy5JVEVNX0RST1BfT1dOX1RJTUUpO1xuICAgICAgICAgICAgfVxuXHRcdH0pO1xuXG5cdFx0aWYgKGl0ZW1zRGF0YS5sZW5ndGggPiAwKSB7XG5cdFx0ICAgIHRoaXMuaW8udG8ocm9vbSkuZW1pdCh0aGlzLkNMSUVOVF9HRVRTLklURU1TX0RST1AubmFtZSwgaXRlbXNEYXRhKTtcbiAgICAgICAgfSBcblx0fVxuXG5cdFtTRVJWRVJfR0VUUy5JVEVNU19MT0NBVElPTlMubmFtZV0oZGF0YSwgc29ja2V0OiBHYW1lU29ja2V0KSB7XG5cdFx0bGV0IGl0ZW1zID0gZGF0YS5pdGVtcztcblx0XHRpZiAoIV8uaXNBcnJheShpdGVtcykpIHtcblx0XHRcdHJldHVybiB0aGlzLnNlbmRFcnJvcihkYXRhLCBzb2NrZXQsIFwiTXVzdCBwcm92aWRlIGFuIGFycmF5IG9mIGl0ZW1zIHRvIHVwZGF0ZSBsb2NhdGlvbnNcIik7XG5cdFx0fVxuXHRcdGxldCB1cGRhdGVkSXRlbXMgPSBbXTtcblx0XHRsZXQgbWFwID0gdGhpcy5nZXRSb29tTWFwKHNvY2tldCk7XG5cdFx0aXRlbXMuZm9yRWFjaChpdGVtID0+IHtcblx0XHRcdGxldCBpdGVtRGF0YTtcblx0XHRcdGlmICghXy5pc09iamVjdChpdGVtKSkge1xuXHRcdFx0XHR0aGlzLnNlbmRFcnJvcihkYXRhLCBzb2NrZXQsIFwiTXVzdCBwcm92aWRlIGFuIG9iamVjdCB0byB1cGRhdGUgbG9jYXRpb25zXCIpO1xuXHRcdFx0fSBlbHNlIGlmICghKGl0ZW1EYXRhID0gbWFwLmdldChpdGVtLml0ZW1faWQpKSkge1xuXHRcdFx0XHR0aGlzLnNlbmRFcnJvcihkYXRhLCBzb2NrZXQsIGBJdGVtIHdpdGggZ2l2ZW4gaXRlbV9pZCAke2l0ZW0uaXRlbV9pZH0gd2FzIG5vdCBmb3VuZGApO1xuXHRcdFx0fSBlbHNlIGlmICghXy5pc0Zpbml0ZShpdGVtLngpIHx8ICFfLmlzRmluaXRlKGl0ZW0ueSkpIHtcblx0XHRcdFx0dGhpcy5zZW5kRXJyb3IoZGF0YSwgc29ja2V0LCBgSXRlbSB3aXRoIGl0ZW1faWQgJHtpdGVtLml0ZW1faWR9IHJlY2VpdmVkIGludmFsaWQgeCBhbmQgeWApO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0aXRlbURhdGEueCA9IGl0ZW0ueDtcblx0XHRcdFx0aXRlbURhdGEueSA9IGl0ZW0ueTtcblx0XHRcdFx0dXBkYXRlZEl0ZW1zLnB1c2goaXRlbSk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdFx0aWYgKHVwZGF0ZWRJdGVtcy5sZW5ndGggPiAwKSB7XG5cdFx0XHRzb2NrZXQuYnJvYWRjYXN0LnRvKHNvY2tldC5jaGFyYWN0ZXIucm9vbSkuZW1pdCh0aGlzLkNMSUVOVF9HRVRTLklURU1TX0xPQ0FUSU9OUy5uYW1lLCB1cGRhdGVkSXRlbXMpO1xuXHRcdH1cblx0fVxufTtcbiJdfQ==
