'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const master_controller_1 = require("../master/master.controller");
const _ = require("underscore");
const stats_services_1 = require("../stats/stats.services");
let config = require('../../../server/lib/mobs/mobs.config.json');
let statsConfig = require('../../../server/lib/stats/stats.config.json');
class MobsController extends master_controller_1.default {
    constructor() {
        super(...arguments);
        this.roomsMobs = new Map();
        this.mobById = new Map();
    }
    hasRoom(room) {
        return this.roomsMobs.has(room);
    }
    hasMob(mobId, socket) {
        return this.mobById.has(this.services.getMobRoomId(socket.character.room, mobId));
    }
    startSpawningMobs(roomInfo) {
        let roomMobs = {
            spawns: []
        };
        roomInfo.spawns.forEach(spawnInfo => {
            let spawn = Object.assign({}, spawnInfo);
            let mobsInSpawn = new Map();
            this.spawnMobs(spawn, mobsInSpawn, roomInfo.name);
            spawn.mobs = mobsInSpawn;
            roomMobs.spawns.push(spawn);
        });
        this.roomsMobs.set(roomInfo.name, roomMobs);
    }
    spawnMobs(spawnInfo, mobsInSpawn, room) {
        let mobsToSpawn = spawnInfo.cap - mobsInSpawn.size;
        console.log("spawning mob");
        if (mobsToSpawn > 0) {
            let mob = this.spawnMob(spawnInfo, room);
            mob.spawn = spawnInfo;
            mobsInSpawn.set(mob.id, mob);
            if (mobsToSpawn > 1) {
                this.setRespawnTimer(mob, room);
            }
        }
    }
    spawnMob(spawnInfo, room) {
        let mob = this.services.getMobInfo(spawnInfo.mobId);
        mob.id = _.uniqueId("mob-");
        mob.x = spawnInfo.x;
        mob.y = spawnInfo.y;
        mob.dmgers = new Map();
        mob.threat = {
            top: "",
            map: new Map()
        };
        mob.dmged = 0;
        this.mobById.set(this.services.getMobRoomId(room, mob.id), mob);
        this.notifyAboutMob(mob, this.io.to(room));
        return mob;
    }
    notifyAboutMob(mob, to) {
        to.emit(config.CLIENT_GETS.MOB_SPAWN.name, {
            mob_id: mob.id,
            x: mob.x,
            y: mob.y,
            key: mob.mobId,
            hp: mob.hp,
        });
    }
    notifyAboutMobs(socket) {
        this.roomsMobs.get(socket.character.room).spawns.forEach(spawn => {
            spawn.mobs.forEach(mob => {
                this.notifyAboutMob(mob, socket);
            });
        });
    }
    moveMob(mobId, x, y, socket) {
        let mob = this.mobById.get(this.services.getMobRoomId(socket.character.room, mobId));
        mob.x = x;
        mob.y = y;
        socket.broadcast.to(socket.character.room).emit(config.CLIENT_GETS.MOB_MOVE.name, {
            mob_id: mobId,
            x,
            y,
        });
    }
    calculateDamage(socket, load) {
        let mainStat = stats_services_1.default.getMainStat(socket);
        let baseDmg = socket.character.stats[mainStat] + socket.bonusStats[mainStat];
        let bonusDmg = load * baseDmg / 100;
        let maxDmg = baseDmg + bonusDmg;
        let minDmg = maxDmg / 2;
        let dmg = this.services.getDamageRange(minDmg, maxDmg);
        return dmg;
    }
    hurtMob(mobId, dmg, socket) {
        let mob = this.mobById.get(this.services.getMobRoomId(socket.character.room, mobId));
        let actualDmg = this.services.getDamageToHurt(mob.hp, dmg);
        mob.hp -= actualDmg;
        let charDmgSoFar = mob.dmgers.get(socket.character.name) || 0;
        mob.dmgers.set(socket.character.name, charDmgSoFar + actualDmg);
        mob.dmged += actualDmg;
        this.addThreat(mob, actualDmg, socket);
        return mob;
    }
    addThreat(mob, threat, socket) {
        if (socket.character.stats.primaryAbility === statsConfig.ABILITY_MELEE) {
            threat *= config.MEELE_THREAT;
        }
        threat += mob.threat.map.get(socket.character.name) || 0;
        mob.threat.map.set(socket.character.name, threat);
        if (!mob.threat.top || (mob.threat.top !== socket.character.name && threat > mob.threat.map.get(mob.threat.top))) {
            if (mob.threat.top) {
                socket.map.get(mob.threat.top).threats.delete(mob);
            }
            socket.threats.add(mob);
            mob.threat.top = socket.character.name;
            this.aggroChanged(mob, socket.character.room, socket.character._id);
        }
    }
    aggroChanged(mob, room, id) {
        console.log("Changing aggro", mob.id);
        this.io.to(room).emit(config.CLIENT_GETS.AGGRO.name, {
            id,
            mob_id: mob.id,
        });
    }
    removeThreat(mob, socket) {
        let maxSocket;
        let maxThreat = 0;
        mob.threat.map.delete(socket.character.name);
        for (let [char, threat] of mob.threat.map) {
            let charSocket = socket.map.get(char);
            if (charSocket && charSocket.character.room === socket.character.room && threat > maxThreat) {
                [maxSocket, maxThreat] = [charSocket, threat];
            }
        }
        mob.threat.top = maxSocket ? maxSocket.character.room : undefined;
        this.aggroChanged(mob, socket.character.room, maxSocket ? maxSocket.character._id : undefined);
    }
    getHurtCharDmg(mobId, socket) {
        let mob = this.mobById.get(this.services.getMobRoomId(socket.character.room, mobId));
        let dmg = this.services.getDamageRange(mob.minDmg, mob.maxDmg);
        return dmg;
    }
    despawnMob(mob, socket) {
        console.log("despawning mob", mob.id);
        this.io.to(socket.character.room).emit(config.CLIENT_GETS.MOB_DIE.name, {
            mob_id: mob.id,
        });
        if (mob.threat.top) {
            socket.map.get(mob.threat.top).threats.delete(mob);
        }
        mob.spawn.mobs.delete(mob.id);
        this.mobById.delete(this.services.getMobRoomId(socket.character.room, mob.id));
        if (mob.spawn.cap == mob.spawn.mobs.size + 1) {
            this.setRespawnTimer(mob, socket.character.room);
        }
    }
    setRespawnTimer(mob, room) {
        console.log("setting interval to respawn", mob.id);
        setTimeout(() => {
            this.spawnMobs(mob.spawn, mob.spawn.mobs, room);
        }, mob.spawn.interval * 1000);
    }
    generateMobs(req, res, next) {
        this.services.generateMobs(req.body.mobs)
            .then(d => {
            this.sendData(res, this.LOGS.GENERATE_MOB, d);
        })
            .catch(e => {
            this.sendError(res, this.LOGS.MASTER_INTERNAL_ERROR, { e, fn: "generateMobs", file: "mobs.controller.js" });
        });
    }
    warmMobsInfo() {
        this.services.getMobs()
            .catch(e => {
            console.error("Had an error getting mobs from the db!");
            throw e;
        });
    }
}
exports.default = MobsController;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NlcnZlci9saWIvbW9icy9tb2JzLmNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOztBQUNiLG1FQUEyRDtBQUUzRCxnQ0FBZ0M7QUFDaEMsNERBQW9EO0FBQ3BELElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDO0FBQ2xFLElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO0FBRXpFLG9CQUFvQyxTQUFRLDJCQUFnQjtJQUE1RDs7UUFFUyxjQUFTLEdBQTJCLElBQUksR0FBRyxFQUFFLENBQUM7UUFDOUMsWUFBTyxHQUE4QixJQUFJLEdBQUcsRUFBRSxDQUFDO0lBeU14RCxDQUFDO0lBck1PLE9BQU8sQ0FBQyxJQUFZO1FBQzFCLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRU0sTUFBTSxDQUFDLEtBQWEsRUFBRSxNQUFrQjtRQUM5QyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUNuRixDQUFDO0lBRU0saUJBQWlCLENBQUMsUUFBb0I7UUFDNUMsSUFBSSxRQUFRLEdBQWM7WUFDekIsTUFBTSxFQUFFLEVBQUU7U0FDVixDQUFDO1FBQ0YsUUFBUSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUztZQUNoQyxJQUFJLEtBQUssR0FBbUIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFFekQsSUFBSSxXQUFXLEdBQThCLElBQUksR0FBRyxFQUFFLENBQUM7WUFDdkQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFLFFBQVEsQ0FBQyxJQUFJ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QUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFO1lBQ3BELEVBQUU7WUFDTyxNQUFNLEVBQUUsR0FBRyxDQUFDLEVBQUU7U0FDdkIsQ0FBQyxDQUFDO0lBQ0QsQ0FBQztJQUVNLFlBQVksQ0FBQyxHQUFpQixFQUFFLE1BQWtCO1FBQ3JELElBQUksU0FBcUIsQ0FBQztRQUMxQixJQUFJLFNBQVMsR0FBRyxDQUFDLENBQUM7UUFDbEIsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0MsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDeEMsSUFBSSxVQUFVLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdEMsRUFBRSxDQUFDLENBQUMsVUFBVSxJQUFJLFVBQVUsQ0FBQyxTQUFTLENBQUMsSUFBSSxLQUFLLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxJQUFJLE1BQU0sR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUMxRixDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUNsRCxDQUFDO1FBQ0wsQ0FBQztRQUNELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxHQUFHLFNBQVMsR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksR0FBRyxTQUFTLENBQUM7UUFDbEUsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsU0FBUyxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsR0FBRyxHQUFHLFNBQVMsQ0FBQyxD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RyxDQUFDLENBQUMsQ0FBQztJQUNGLENBQUM7SUFFRyxZQUFZO1FBQ2xCLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFO2FBQ3JCLEtBQUssQ0FBQyxDQUFDO1lBQ1AsT0FBTyxDQUFDLEtBQUssQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDO1lBQ3hELE1BQU0sQ0FBQyxDQUFDO1FBQ1QsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Q7QUE1TUQsaUNBNE1DO0FBQUEsQ0FBQyIsImZpbGUiOiJsaWIvbW9icy9tb2JzLmNvbnRyb2xsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5pbXBvcnQgTWFzdGVyQ29udHJvbGxlciBmcm9tICcuLi9tYXN0ZXIvbWFzdGVyLmNvbnRyb2xsZXInO1xuaW1wb3J0IE1vYnNTZXJ2aWNlcyBmcm9tICcuL21vYnMuc2VydmljZXMnO1xuaW1wb3J0ICogYXMgXyBmcm9tICd1bmRlcnNjb3JlJztcbmltcG9ydCBTdGF0c1NlcnZpY2VzIGZyb20gJy4uL3N0YXRzL3N0YXRzLnNlcnZpY2VzJztcbmxldCBjb25maWcgPSByZXF1aXJlKCcuLi8uLi8uLi9zZXJ2ZXIvbGliL21vYnMvbW9icy5jb25maWcuanNvbicpO1xubGV0IHN0YXRzQ29uZmlnID0gcmVxdWlyZSgnLi4vLi4vLi4vc2VydmVyL2xpYi9zdGF0cy9zdGF0cy5jb25maWcuanNvbicpO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNb2JzQ29udHJvbGxlciBleHRlbmRzIE1hc3RlckNvbnRyb2xsZXIge1xuXHRwcm90ZWN0ZWQgc2VydmljZXM6IE1vYnNTZXJ2aWNlcztcblx0cHJpdmF0ZSByb29tc01vYnM6IE1hcDxzdHJpbmcsIFJPT01fTU9CUz4gPSBuZXcgTWFwKCk7XG5cdHByaXZhdGUgbW9iQnlJZDogTWFwPHN0cmluZywgTU9CX0lOU1RBTkNFPiA9IG5ldyBNYXAoKTtcblxuXHQvLyBTb2NrZXQgZnVuY3Rpb25zXG5cdC8vID09PT09PT09PT09PT09PT09XG5cdHB1YmxpYyBoYXNSb29tKHJvb206IHN0cmluZykge1xuXHRcdHJldHVybiB0aGlzLnJvb21zTW9icy5oYXMocm9vbSk7XG5cdH1cblxuXHRwdWJsaWMgaGFzTW9iKG1vYklkOiBzdHJpbmcsIHNvY2tldDogR2FtZVNvY2tldCk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiB0aGlzLm1vYkJ5SWQuaGFzKHRoaXMuc2VydmljZXMuZ2V0TW9iUm9vbUlkKHNvY2tldC5jaGFyYWN0ZXIucm9vbSwgbW9iSWQpKTtcblx0fVxuXG5cdHB1YmxpYyBzdGFydFNwYXduaW5nTW9icyhyb29tSW5mbzogUk9PTV9NT0RFTCkge1xuXHRcdGxldCByb29tTW9iczogUk9PTV9NT0JTID0ge1xuXHRcdFx0c3Bhd25zOiBbXVxuXHRcdH07XG5cdFx0cm9vbUluZm8uc3Bhd25zLmZvckVhY2goc3Bhd25JbmZvID0+IHtcblx0XHRcdGxldCBzcGF3bjogU1BBV05fSU5TVEFOQ0UgPSBPYmplY3QuYXNzaWduKHt9LCBzcGF3bkluZm8pO1xuXHRcdFx0XG5cdFx0XHRsZXQgbW9ic0luU3Bhd246IE1hcDxzdHJpbmcsIE1PQl9JTlNUQU5DRT4gPSBuZXcgTWFwKCk7XG5cdFx0XHR0aGlzLnNwYXduTW9icyhzcGF3biwgbW9ic0luU3Bhd24sIHJvb21JbmZvLm5hbWUpO1xuXHRcdFx0c3Bhd24ubW9icyA9IG1vYnNJblNwYXduO1xuXHRcdFx0cm9vbU1vYnMuc3Bhd25zLnB1c2goc3Bhd24pO1xuXHRcdH0pO1xuXHRcdHRoaXMucm9vbXNNb2JzLnNldChyb29tSW5mby5uYW1lLCByb29tTW9icyk7XG5cdH1cblxuXHRwcm90ZWN0ZWQgc3Bhd25Nb2JzKHNwYXduSW5mbzogU1BBV05fSU5TVEFOQ0UsIG1vYnNJblNwYXduOiBNYXA8c3RyaW5nLCBNT0JfSU5TVEFOQ0U+LCByb29tOiBzdHJpbmcpIHtcblx0XHRsZXQgbW9ic1RvU3Bhd24gPSBzcGF3bkluZm8uY2FwIC0gbW9ic0luU3Bhd24uc2l6ZTtcblx0XHRjb25zb2xlLmxvZyhcInNwYXduaW5nIG1vYlwiKTtcblx0XHRpZiAobW9ic1RvU3Bhd24gPiAwKSB7XG5cdFx0XHRsZXQgbW9iID0gdGhpcy5zcGF3bk1vYihzcGF3bkluZm8sIHJvb20pO1xuXHRcdFx0bW9iLnNwYXduID0gc3Bhd25JbmZvOyAvLyB1c2VmdWwgZm9yIHdoZW4gd2UgZGVsZXRlIHRoZSBtb2Jcblx0XHRcdG1vYnNJblNwYXduLnNldChtb2IuaWQsIG1vYik7XG5cblx0XHRcdGlmIChtb2JzVG9TcGF3biA+IDEpIHtcblx0XHRcdFx0Ly8gd2Ugc3RpbGwgaGF2ZSBhIG1vYiB0byBzcGF3biAtIHNldCBhbiBpbnRlcnZhbFxuXHRcdFx0XHR0aGlzLnNldFJlc3Bhd25UaW1lcihtb2IsIHJvb20pO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdHByb3RlY3RlZCBzcGF3bk1vYihzcGF3bkluZm86IFNQQVdOX0lOU1RBTkNFLCByb29tOiBzdHJpbmcpOiBNT0JfSU5TVEFOQ0Uge1xuXHRcdGxldCBtb2I6IE1PQl9JTlNUQU5DRSA9IHRoaXMuc2VydmljZXMuZ2V0TW9iSW5mbyhzcGF3bkluZm8ubW9iSWQpO1xuXHRcdG1vYi5pZCA9IF8udW5pcXVlSWQoXCJtb2ItXCIpO1xuXHRcdG1vYi54ID0gc3Bhd25JbmZvLng7XG5cdFx0bW9iLnkgPSBzcGF3bkluZm8ueTtcbiAgICAgICAgbW9iLmRtZ2VycyA9IG5ldyBNYXAoKTtcbiAgICAgICAgbW9iLnRocmVhdCA9IHtcbiAgICAgICAgICAgIHRvcDogXCJcIixcbiAgICAgICAgICAgIG1hcDogbmV3IE1hcCgpXG4gICAgICAgIH07XG4gICAgICAgIG1vYi5kbWdlZCA9IDA7XG5cblx0XHR0aGlzLm1vYkJ5SWQuc2V0KHRoaXMuc2VydmljZXMuZ2V0TW9iUm9vbUlkKHJvb20sIG1vYi5pZCksIG1vYik7XG5cdFx0dGhpcy5ub3RpZnlBYm91dE1vYihtb2IsIHRoaXMuaW8udG8ocm9vbSkpO1xuXHRcdHJldHVybiBtb2I7XG5cdH1cblxuXHRwcm90ZWN0ZWQgbm90aWZ5QWJvdXRNb2IobW9iOiBNT0JfSU5TVEFOQ0UsIHRvOiBTb2NrZXRJTy5OYW1lc3BhY2V8U29ja2V0SU8uU29ja2V0KSB7XG5cdFx0dG8uZW1pdChjb25maWcuQ0xJRU5UX0dFVFMuTU9CX1NQQVdOLm5hbWUsIHtcblx0XHRcdG1vYl9pZDogbW9iLmlkLFxuXHRcdFx0eDogbW9iLngsXG5cdFx0XHR5OiBtb2IueSxcblx0XHRcdGtleTogbW9iLm1vYklkLFxuXHRcdFx0aHA6IG1vYi5ocCxcblx0XHR9KTtcblx0fVxuXG5cdHB1YmxpYyBub3RpZnlBYm91dE1vYnMoc29ja2V0OiBHYW1lU29ja2V0KSB7XG5cdFx0dGhpcy5yb29tc01vYnMuZ2V0KHNvY2tldC5jaGFyYWN0ZXIucm9vbSkuc3Bhd25zLmZvckVhY2goc3Bhd24gPT4ge1xuXHRcdFx0c3Bhd24ubW9icy5mb3JFYWNoKG1vYiA9PiB7XG5cdFx0XHRcdHRoaXMubm90aWZ5QWJvdXRNb2IobW9iLCBzb2NrZXQpO1xuXHRcdFx0fSk7XG5cdFx0fSk7XG5cdH1cblxuXHRwdWJsaWMgbW92ZU1vYihtb2JJZDogc3RyaW5nLCB4OiBudW1iZXIsIHk6IG51bWJlciwgc29ja2V0OiBHYW1lU29ja2V0KSB7XG5cdFx0bGV0IG1vYiA9IHRoaXMubW9iQnlJZC5nZXQodGhpcy5zZXJ2aWNlcy5nZXRNb2JSb29tSWQoc29ja2V0LmNoYXJhY3Rlci5yb29tLCBtb2JJZCkpO1xuXHRcdG1vYi54ID0geDtcblx0XHRtb2IueSA9IHk7XG5cdFx0c29ja2V0LmJyb2FkY2FzdC50byhzb2NrZXQuY2hhcmFjdGVyLnJvb20pLmVtaXQoY29uZmlnLkNMSUVOVF9HRVRTLk1PQl9NT1ZFLm5hbWUsIHtcblx0XHRcdG1vYl9pZDogbW9iSWQsIFxuXHRcdFx0eCxcblx0XHRcdHksXG5cdFx0fSk7XG5cdH1cblxuXHRwdWJsaWMgY2FsY3VsYXRlRGFtYWdlKHNvY2tldDogR2FtZVNvY2tldCwgbG9hZDogbnVtYmVyKTogbnVtYmVyIHtcblx0XHRsZXQgbWFpblN0YXQgPSBTdGF0c1NlcnZpY2VzLmdldE1haW5TdGF0KHNvY2tldCk7XG5cdFx0bGV0IGJhc2VEbWcgPSBzb2NrZXQuY2hhcmFjdGVyLnN0YXRzW21haW5TdGF0XSArIHNvY2tldC5ib251c1N0YXRzW21haW5TdGF0XTsgXG5cdFx0bGV0IGJvbnVzRG1nID0gbG9hZCAqIGJhc2VEbWcgLyAxMDA7XG5cdFx0bGV0IG1heERtZyA9IGJhc2VEbWcgKyBib251c0RtZztcblx0XHRsZXQgbWluRG1nID0gbWF4RG1nIC8gMjtcblx0XHRsZXQgZG1nID0gdGhpcy5zZXJ2aWNlcy5nZXREYW1hZ2VSYW5nZShtaW5EbWcsIG1heERtZyk7XG5cdFx0cmV0dXJuIGRtZztcblx0fVxuXG5cdHB1YmxpYyBodXJ0TW9iKG1vYklkOiBzdHJpbmcsIGRtZzogbnVtYmVyLCBzb2NrZXQ6IEdhbWVTb2NrZXQpOiBNT0JfSU5TVEFOQ0Uge1xuXHRcdGxldCBtb2IgPSB0aGlzLm1vYkJ5SWQuZ2V0KHRoaXMuc2VydmljZXMuZ2V0TW9iUm9vbUlkKHNvY2tldC5jaGFyYWN0ZXIucm9vbSwgbW9iSWQpKTtcbiAgICAgICAgbGV0IGFjdHVhbERtZyA9IHRoaXMuc2VydmljZXMuZ2V0RGFtYWdlVG9IdXJ0KG1vYi5ocCwgZG1nKTtcblx0XHRtb2IuaHAgLT0gYWN0dWFsRG1nO1xuICAgICAgICBcbiAgICAgICAgbGV0IGNoYXJEbWdTb0ZhciA9IG1vYi5kbWdlcnMuZ2V0KHNvY2tldC5jaGFyYWN0ZXIubmFtZSkgfHwgMDtcbiAgICAgICAgbW9iLmRtZ2Vycy5zZXQoc29ja2V0LmNoYXJhY3Rlci5uYW1lLCBjaGFyRG1nU29GYXIgKyBhY3R1YWxEbWcpO1xuICAgICAgICBtb2IuZG1nZWQgKz0gYWN0dWFsRG1nO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5hZGRUaHJlYXQobW9iLCBhY3R1YWxEbWcsIHNvY2tldCk7XG5cdFx0XG4gICAgICAgIHJldHVybiBtb2I7XG5cdH1cblxuICAgIHByaXZhdGUgYWRkVGhyZWF0KG1vYjogTU9CX0lOU1RBTkNFLCB0aHJlYXQ6IG51bWJlciwgc29ja2V0OiBHYW1lU29ja2V0KSB7XG4gICAgICAgIGlmIChzb2NrZXQuY2hhcmFjdGVyLnN0YXRzLnByaW1hcnlBYmlsaXR5ID09PSBzdGF0c0NvbmZpZy5BQklMSVRZX01FTEVFKSB7XG4gICAgICAgICAgICB0aHJlYXQgKj0gY29uZmlnLk1FRUxFX1RIUkVBVDtcbiAgICAgICAgfVxuICAgICAgICB0aHJlYXQgKz0gbW9iLnRocmVhdC5tYXAuZ2V0KHNvY2tldC5jaGFyYWN0ZXIubmFtZSkgfHwgMDtcbiAgICAgICAgbW9iLnRocmVhdC5tYXAuc2V0KHNvY2tldC5jaGFyYWN0ZXIubmFtZSwgdGhyZWF0KTtcblxuICAgICAgICBpZiAoIW1vYi50aHJlYXQudG9wIHx8IChtb2IudGhyZWF0LnRvcCAhPT0gc29ja2V0LmNoYXJhY3Rlci5uYW1lICYmIHRocmVhdCA+IG1vYi50aHJlYXQubWFwLmdldChtb2IudGhyZWF0LnRvcCkpKSB7XG4gICAgICAgICAgICBpZiAobW9iLnRocmVhdC50b3ApIHtcbiAgICAgICAgICAgICAgICBzb2NrZXQubWFwLmdldChtb2IudGhyZWF0LnRvcCkudGhyZWF0cy5kZWxldGUobW9iKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNvY2tldC50aHJlYXRzLmFkZChtb2IpO1xuICAgICAgICAgICAgbW9iLnRocmVhdC50b3AgPSBzb2NrZXQuY2hhcmFjdGVyLm5hbWU7XG4gICAgICAgICAgICB0aGlzLmFnZ3JvQ2hhbmdlZChtb2IsIHNvY2tldC5jaGFyYWN0ZXIucm9vbSwgc29ja2V0LmNoYXJhY3Rlci5faWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhZ2dyb0NoYW5nZWQobW9iOiBNT0JfSU5TVEFOQ0UsIHJvb206IHN0cmluZywgaWQpIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJDaGFuZ2luZyBhZ2dyb1wiLCBtb2IuaWQpO1xuXHRcdHRoaXMuaW8udG8ocm9vbSkuZW1pdChjb25maWcuQ0xJRU5UX0dFVFMuQUdHUk8ubmFtZSwge1xuXHRcdFx0aWQsXG4gICAgICAgICAgICBtb2JfaWQ6IG1vYi5pZCxcblx0XHR9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVtb3ZlVGhyZWF0KG1vYjogTU9CX0lOU1RBTkNFLCBzb2NrZXQ6IEdhbWVTb2NrZXQpIHtcbiAgICAgICAgbGV0IG1heFNvY2tldDogR2FtZVNvY2tldDtcbiAgICAgICAgbGV0IG1heFRocmVhdCA9IDA7XG4gICAgICAgIG1vYi50aHJlYXQubWFwLmRlbGV0ZShzb2NrZXQuY2hhcmFjdGVyLm5hbWUpO1xuICAgICAgICBmb3IgKGxldCBbY2hhciwgdGhyZWF0XSBvZiBtb2IudGhyZWF0Lm1hcCkge1xuICAgICAgICAgICAgbGV0IGNoYXJTb2NrZXQgPSBzb2NrZXQubWFwLmdldChjaGFyKTtcbiAgICAgICAgICAgIGlmIChjaGFyU29ja2V0ICYmIGNoYXJTb2NrZXQuY2hhcmFjdGVyLnJvb20gPT09IHNvY2tldC5jaGFyYWN0ZXIucm9vbSAmJiB0aHJlYXQgPiBtYXhUaHJlYXQpIHtcbiAgICAgICAgICAgICAgICBbbWF4U29ja2V0LCBtYXhUaHJlYXRdID0gW2NoYXJTb2NrZXQsIHRocmVhdF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgbW9iLnRocmVhdC50b3AgPSBtYXhTb2NrZXQgPyBtYXhTb2NrZXQuY2hhcmFjdGVyLnJvb20gOiB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuYWdncm9DaGFuZ2VkKG1vYiwgc29ja2V0LmNoYXJhY3Rlci5yb29tLCBtYXhTb2NrZXQgPyBtYXhTb2NrZXQuY2hhcmFjdGVyLl9pZCA6IHVuZGVmaW5lZClcbiAgICB9XG5cblx0cHVibGljIGdldEh1cnRDaGFyRG1nKG1vYklkOiBzdHJpbmcsIHNvY2tldDogR2FtZVNvY2tldCk6IG51bWJlciB7XG5cdFx0bGV0IG1vYiA9IHRoaXMubW9iQnlJZC5nZXQodGhpcy5zZXJ2aWNlcy5nZXRNb2JSb29tSWQoc29ja2V0LmNoYXJhY3Rlci5yb29tLCBtb2JJZCkpO1xuXHRcdGxldCBkbWcgPSB0aGlzLnNlcnZpY2VzLmdldERhbWFnZVJhbmdlKG1vYi5taW5EbWcsIG1vYi5tYXhEbWcpO1xuXHRcdHJldHVybiBkbWc7XG5cdH1cblxuXHRwdWJsaWMgZGVzcGF3bk1vYihtb2I6IE1PQl9JTlNUQU5DRSwgc29ja2V0OiBHYW1lU29ja2V0KSB7XG5cdFx0Y29uc29sZS5sb2coXCJkZXNwYXduaW5nIG1vYlwiLCBtb2IuaWQpO1xuXHRcdHRoaXMuaW8udG8oc29ja2V0LmNoYXJhY3Rlci5yb29tKS5lbWl0KGNvbmZpZy5DTElFTlRfR0VUUy5NT0JfRElFLm5hbWUsIHtcblx0XHRcdG1vYl9pZDogbW9iLmlkLFxuXHRcdH0pO1xuXHRcdC8vIHJlbW92ZSBtb2IgcmVmZXJlbmNlc1xuICAgICAgICBpZiAobW9iLnRocmVhdC50b3ApIHtcbiAgICAgICAgICAgIHNvY2tldC5tYXAuZ2V0KG1vYi50aHJlYXQudG9wKS50aHJlYXRzLmRlbGV0ZShtb2IpO1xuICAgICAgICB9XG5cdFx0bW9iLnNwYXduLm1vYnMuZGVsZXRlKG1vYi5pZCk7XG5cdFx0dGhpcy5tb2JCeUlkLmRlbGV0ZSh0aGlzLnNlcnZpY2VzLmdldE1vYlJvb21JZChzb2NrZXQuY2hhcmFjdGVyLnJvb20sIG1vYi5pZCkpO1xuXG5cdFx0aWYgKG1vYi5zcGF3bi5jYXAgPT0gbW9iLnNwYXduLm1vYnMuc2l6ZSArIDEpIHtcblx0XHRcdC8vIGlmIGl0J3MgdGhlIGZpcnN0IG1vYiB0aGF0IHdlIGtpbGwsIHNldCBhIHRpbWVyIHRvIHJlc3Bhd25cblx0XHRcdHRoaXMuc2V0UmVzcGF3blRpbWVyKG1vYiwgc29ja2V0LmNoYXJhY3Rlci5yb29tKTtcblx0XHR9XG5cdH1cblxuXHRwcm90ZWN0ZWQgc2V0UmVzcGF3blRpbWVyKG1vYjogTU9CX0lOU1RBTkNFLCByb29tOiBzdHJpbmcpIHtcblx0XHRjb25zb2xlLmxvZyhcInNldHRpbmcgaW50ZXJ2YWwgdG8gcmVzcGF3blwiLCBtb2IuaWQpO1xuXHRcdHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0dGhpcy5zcGF3bk1vYnMobW9iLnNwYXduLCBtb2Iuc3Bhd24ubW9icywgcm9vbSk7XG5cdFx0fSwgbW9iLnNwYXduLmludGVydmFsICogMTAwMCk7XG5cdH1cblxuXHQvLyBIVFRQIGZ1bmN0aW9uc1xuXHQvLyA9PT09PT09PT09PT09PT09PVxuXHRwdWJsaWMgZ2VuZXJhdGVNb2JzKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgICAgIHRoaXMuc2VydmljZXMuZ2VuZXJhdGVNb2JzKHJlcS5ib2R5Lm1vYnMpXG5cdFx0XHQudGhlbihkID0+IHtcblx0XHRcdFx0dGhpcy5zZW5kRGF0YShyZXMsIHRoaXMuTE9HUy5HRU5FUkFURV9NT0IsIGQpO1xuXHRcdFx0fSlcblx0XHRcdC5jYXRjaChlID0+IHtcblx0XHRcdFx0dGhpcy5zZW5kRXJyb3IocmVzLCB0aGlzLkxPR1MuTUFTVEVSX0lOVEVSTkFMX0VSUk9SLCB7ZSwgZm46IFwiZ2VuZXJhdGVNb2JzXCIsIGZpbGU6IFwibW9icy5jb250cm9sbGVyLmpzXCJ9KTtcblx0XHRcdH0pO1xuICAgIH1cblxuXHRwdWJsaWMgd2FybU1vYnNJbmZvKCk6IHZvaWQge1xuXHRcdHRoaXMuc2VydmljZXMuZ2V0TW9icygpXG5cdFx0XHQuY2F0Y2goZSA9PiB7XG5cdFx0XHRcdGNvbnNvbGUuZXJyb3IoXCJIYWQgYW4gZXJyb3IgZ2V0dGluZyBtb2JzIGZyb20gdGhlIGRiIVwiKTtcblx0XHRcdFx0dGhyb3cgZTtcblx0XHRcdH0pO1xuXHR9XG59OyJdfQ==
