'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const socketio_router_base_1 = require("../socketio/socketio.router.base");
let config = require('../../../server/lib/mobs/mobs.config.json');
let statsConfig = require('../../../server/lib/stats/stats.config.json');
let dropsConfig = require('../../../server/lib/drops/drops.config.json');
let questsConfig = require('../../../server/lib/quests/quests.config.json');
class MobsRouter extends socketio_router_base_1.default {
    init(files, app) {
        this.roomsRouter = files.routers.rooms;
        this.partyRouter = files.routers.party;
        this.services = files.services;
        super.init(files, app);
    }
    initRoutes(app) {
        app.post(this.ROUTES.GENERATE, this.middleware.validateHasSercetKey.bind(this.middleware), this.controller.generateMobs.bind(this.controller));
    }
    onConnected(socket) {
        socket.threats = new Set();
    }
    [config.SERVER_GETS.ENTERED_ROOM.name](data, socket) {
        if (!this.controller.hasRoom(socket.character.room)) {
            let roomInfo = this.roomsRouter.getRoomInfo(socket.character.room);
            if (roomInfo) {
                this.controller.startSpawningMobs(roomInfo);
            }
            else {
                this.sendError({ charRoom: socket.character.room }, socket, "No room info! cannot spawn any mobs.");
            }
        }
        else {
            this.controller.notifyAboutMobs(socket);
        }
    }
    [config.SERVER_INNER.LEFT_ROOM.name](data, socket) {
        for (let mob of socket.threats) {
            this.controller.removeThreat(mob, socket);
        }
        socket.threats.clear();
    }
    [config.SERVER_GETS.MOB_TAKE_DMG.name](data, socket) {
        if (this.controller.hasMob(data.mob_id, socket)) {
            let load = socket.lastAttackLoad || 0;
            let dmg = this.controller.calculateDamage(socket, load);
            let mob = this.controller.hurtMob(data.mob_id, dmg, socket);
            this.io.to(socket.character.room).emit(this.CLIENT_GETS.MOB_TAKE_DMG.name, {
                id: socket.character._id,
                mob_id: mob.id,
                dmg,
                load,
                hp: mob.hp,
            });
            if (mob.hp === 0) {
                this.controller.despawnMob(mob, socket);
                let max = { dmg: 0, socket: null };
                let parties = new Map();
                for (let [charId, charDmg] of mob.dmgers) {
                    let charSocket = socket.map.get(charId);
                    if (charSocket && charSocket.character.room === socket.character.room && charSocket.alive) {
                        let exp = this.services.getExp(mob, charDmg);
                        let party = this.partyRouter.getCharParty(charSocket);
                        if (party) {
                            let currentPartyExp = (parties.get(party) || { exp: 0 }).exp;
                            parties.set(party, { socket: charSocket, exp: currentPartyExp });
                        }
                        else {
                            this.emitter.emit(statsConfig.SERVER_INNER.GAIN_EXP.name, { exp }, charSocket);
                        }
                        if (charDmg > max.dmg) {
                            max.dmg = charDmg;
                            max.socket = charSocket;
                        }
                    }
                }
                for (let [, { socket, exp }] of parties) {
                    let partySockets = this.partyRouter.getPartyMembersInMap(socket);
                    exp = Math.ceil(exp / partySockets.length);
                    for (let memberSocket of partySockets) {
                        this.emitter.emit(statsConfig.SERVER_INNER.GAIN_EXP.name, { exp }, memberSocket);
                    }
                }
                this.emitter.emit(dropsConfig.SERVER_INNER.GENERATE_DROPS.name, { x: mob.x, y: mob.y, owner: max.socket.character.name }, max.socket, mob.drops);
                this.emitter.emit(questsConfig.SERVER_INNER.HUNT_MOB.name, { id: mob.mobId }, max.socket);
            }
        }
        else {
            this.sendError(data, socket, "Mob doesn't exist!");
        }
    }
    [config.SERVER_GETS.MOB_MOVE.name](data, socket) {
        if (!this.controller.hasMob(data.mob_id, socket)) {
            this.sendError(data, socket, "Mob doesn't exist!");
        }
        else {
            this.controller.moveMob(data.mob_id, data.x, data.y, socket);
        }
    }
    [config.SERVER_GETS.TAKE_DMG.name](data, socket) {
        if (this.controller.hasMob(data.mob_id, socket)) {
            let dmg = this.controller.getHurtCharDmg(data.mob_id, socket);
            this.emitter.emit(statsConfig.SERVER_INNER.TAKE_DMG.name, { dmg }, socket);
        }
        else {
            this.sendError(data, socket, "Mob doesn't exist!");
        }
    }
}
exports.default = MobsRouter;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NlcnZlci9saWIvbW9icy9tb2JzLnJvdXRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7O0FBQ2IsMkVBQWtFO0FBTWxFLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDO0FBQ2xFLElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO0FBQ3pFLElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO0FBQ3pFLElBQUksWUFBWSxHQUFHLE9BQU8sQ0FBQywrQ0FBK0MsQ0FBQyxDQUFDO0FBRTVFLGdCQUFnQyxTQUFRLDhCQUFrQjtJQU96RCxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUc7UUFDZCxJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7UUFDdkMsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDO1FBQ3JDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3hCLENBQUM7SUFFUyxVQUFVLENBQUMsR0FBRztRQUN2QixHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUM1QixJQUFJLENBQUMsVUFBVSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQzFELElBQUksQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRVMsV0FBVyxDQUFDLE1BQWtCO1FBQ2pDLE1BQU0sQ0FBQyxPQUFPLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBRUosQ0FBQyxNQUFNLENB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QztRQUNwRCxDQUFDO0lBQ0YsQ0FBQztDQUNEO0FBbkhELDZCQW1IQztBQUFBLENBQUMiLCJmaWxlIjoibGliL21vYnMvbW9icy5yb3V0ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5pbXBvcnQgU29ja2V0aW9Sb3V0ZXJCYXNlIGZyb20gJy4uL3NvY2tldGlvL3NvY2tldGlvLnJvdXRlci5iYXNlJztcbmltcG9ydCBNb2JzTWlkZGxld2FyZSBmcm9tIFwiLi9tb2JzLm1pZGRsZXdhcmVcIjtcbmltcG9ydCBNb2JzQ29udHJvbGxlciBmcm9tIFwiLi9tb2JzLmNvbnRyb2xsZXJcIjtcbmltcG9ydCBSb29tc1JvdXRlciBmcm9tIFwiLi4vcm9vbXMvcm9vbXMucm91dGVyXCI7XG5pbXBvcnQgTW9ic1NlcnZpY2VzIGZyb20gJy4vbW9icy5zZXJ2aWNlcyc7XG5pbXBvcnQgUGFydHlSb3V0ZXIgZnJvbSAnLi4vcGFydHkvcGFydHkucm91dGVyJztcbmxldCBjb25maWcgPSByZXF1aXJlKCcuLi8uLi8uLi9zZXJ2ZXIvbGliL21vYnMvbW9icy5jb25maWcuanNvbicpO1xubGV0IHN0YXRzQ29uZmlnID0gcmVxdWlyZSgnLi4vLi4vLi4vc2VydmVyL2xpYi9zdGF0cy9zdGF0cy5jb25maWcuanNvbicpO1xubGV0IGRyb3BzQ29uZmlnID0gcmVxdWlyZSgnLi4vLi4vLi4vc2VydmVyL2xpYi9kcm9wcy9kcm9wcy5jb25maWcuanNvbicpO1xubGV0IHF1ZXN0c0NvbmZpZyA9IHJlcXVpcmUoJy4uLy4uLy4uL3NlcnZlci9saWIvcXVlc3RzL3F1ZXN0cy5jb25maWcuanNvbicpO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNb2JzUm91dGVyIGV4dGVuZHMgU29ja2V0aW9Sb3V0ZXJCYXNlIHtcblx0cHJvdGVjdGVkIG1pZGRsZXdhcmU6IE1vYnNNaWRkbGV3YXJlO1xuXHRwcm90ZWN0ZWQgY29udHJvbGxlcjogTW9ic0NvbnRyb2xsZXI7XG4gICAgcHJvdGVjdGVkIHNlcnZpY2VzOiBNb2JzU2VydmljZXM7XG5cdHByb3RlY3RlZCByb29tc1JvdXRlcjogUm9vbXNSb3V0ZXI7XG4gICAgcHJvdGVjdGVkIHBhcnR5Um91dGVyOiBQYXJ0eVJvdXRlcjtcblx0XG5cdGluaXQoZmlsZXMsIGFwcCkge1xuXHRcdHRoaXMucm9vbXNSb3V0ZXIgPSBmaWxlcy5yb3V0ZXJzLnJvb21zO1xuICAgICAgICB0aGlzLnBhcnR5Um91dGVyID0gZmlsZXMucm91dGVycy5wYXJ0eTtcbiAgICAgICAgdGhpcy5zZXJ2aWNlcyA9IGZpbGVzLnNlcnZpY2VzO1xuXHRcdHN1cGVyLmluaXQoZmlsZXMsIGFwcCk7XG5cdH1cblx0XG5cdHByb3RlY3RlZCBpbml0Um91dGVzKGFwcCkge1xuXHRcdGFwcC5wb3N0KHRoaXMuUk9VVEVTLkdFTkVSQVRFLFxuXHRcdFx0dGhpcy5taWRkbGV3YXJlLnZhbGlkYXRlSGFzU2VyY2V0S2V5LmJpbmQodGhpcy5taWRkbGV3YXJlKSxcblx0XHRcdHRoaXMuY29udHJvbGxlci5nZW5lcmF0ZU1vYnMuYmluZCh0aGlzLmNvbnRyb2xsZXIpKTtcblx0fVxuXG4gICAgcHVibGljIG9uQ29ubmVjdGVkKHNvY2tldDogR2FtZVNvY2tldCkge1xuICAgICAgICBzb2NrZXQudGhyZWF0cyA9IG5ldyBTZXQoKTtcbiAgICB9XG5cblx0W2NvbmZpZy5TRVJWRVJfR0VUUy5FTlRFUkVEX1JPT00ubmFtZV0oZGF0YSwgc29ja2V0OiBHYW1lU29ja2V0KSB7XG5cdFx0aWYgKCF0aGlzLmNvbnRyb2xsZXIuaGFzUm9vbShzb2NrZXQuY2hhcmFjdGVyLnJvb20pKSB7XG5cdFx0XHQvLyB3ZSBtdXN0IHNwYXduIG5ldyBtb2JzXG5cdFx0XHRsZXQgcm9vbUluZm8gPSB0aGlzLnJvb21zUm91dGVyLmdldFJvb21JbmZvKHNvY2tldC5jaGFyYWN0ZXIucm9vbSk7XG5cdFx0XHRpZiAocm9vbUluZm8pIHtcblx0XHRcdFx0dGhpcy5jb250cm9sbGVyLnN0YXJ0U3Bhd25pbmdNb2JzKHJvb21JbmZvKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHRoaXMuc2VuZEVycm9yKHtjaGFyUm9vbTogc29ja2V0LmNoYXJhY3Rlci5yb29tfSwgc29ja2V0LCBcIk5vIHJvb20gaW5mbyEgY2Fubm90IHNwYXduIGFueSBtb2JzLlwiKTtcblx0XHRcdH1cblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5jb250cm9sbGVyLm5vdGlmeUFib3V0TW9icyhzb2NrZXQpO1xuXHRcdH1cblx0fVxuXG5cdFtjb25maWcuU0VSVkVSX0lOTkVSLkxFRlRfUk9PTS5uYW1lXShkYXRhLCBzb2NrZXQ6IEdhbWVTb2NrZXQpIHtcblx0XHRmb3IgKGxldCBtb2Igb2Ygc29ja2V0LnRocmVhdHMpIHtcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5yZW1vdmVUaHJlYXQobW9iLCBzb2NrZXQpO1xuICAgICAgICB9XG4gICAgICAgIHNvY2tldC50aHJlYXRzLmNsZWFyKCk7XG5cdH1cblxuXHRbY29uZmlnLlNFUlZFUl9HRVRTLk1PQl9UQUtFX0RNRy5uYW1lXShkYXRhLCBzb2NrZXQ6IEdhbWVTb2NrZXQpIHtcblx0XHRpZiAodGhpcy5jb250cm9sbGVyLmhhc01vYihkYXRhLm1vYl9pZCwgc29ja2V0KSkge1xuXHRcdFx0bGV0IGxvYWQgPSBzb2NrZXQubGFzdEF0dGFja0xvYWQgfHwgMDtcblx0XHRcdGxldCBkbWcgPSB0aGlzLmNvbnRyb2xsZXIuY2FsY3VsYXRlRGFtYWdlKHNvY2tldCwgbG9hZCk7XG5cdFx0XHRsZXQgbW9iID0gdGhpcy5jb250cm9sbGVyLmh1cnRNb2IoZGF0YS5tb2JfaWQsIGRtZywgc29ja2V0KTtcblx0XHRcdHRoaXMuaW8udG8oc29ja2V0LmNoYXJhY3Rlci5yb29tKS5lbWl0KHRoaXMuQ0xJRU5UX0dFVFMuTU9CX1RBS0VfRE1HLm5hbWUsIHtcblx0XHRcdFx0aWQ6IHNvY2tldC5jaGFyYWN0ZXIuX2lkLFxuXHRcdFx0XHRtb2JfaWQ6IG1vYi5pZCxcblx0XHRcdFx0ZG1nLFxuXHRcdFx0XHRsb2FkLFxuXHRcdFx0XHRocDogbW9iLmhwLFxuXHRcdFx0fSk7XG5cdFx0XHRpZiAobW9iLmhwID09PSAwKSB7XG5cdFx0XHRcdHRoaXMuY29udHJvbGxlci5kZXNwYXduTW9iKG1vYiwgc29ja2V0KTtcblxuICAgICAgICAgICAgICAgIGxldCBtYXggPSB7ZG1nOiAwLCBzb2NrZXQ6IG51bGx9O1xuICAgICAgICAgICAgICAgIGxldCBwYXJ0aWVzOiBNYXA8UEFSVFlfTU9ERUwgfCBHYW1lU29ja2V0LCB7ZXhwOiBudW1iZXIsIHNvY2tldDogR2FtZVNvY2tldH0+ID0gbmV3IE1hcCgpO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IFtjaGFySWQsIGNoYXJEbWddIG9mIG1vYi5kbWdlcnMpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGNoYXJTb2NrZXQgPSBzb2NrZXQubWFwLmdldChjaGFySWQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2hhclNvY2tldCAmJiBjaGFyU29ja2V0LmNoYXJhY3Rlci5yb29tID09PSBzb2NrZXQuY2hhcmFjdGVyLnJvb20gJiYgY2hhclNvY2tldC5hbGl2ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gZm91bmQgY2hhciBhbmQgaGUncyBhbGl2ZSBpbiBvdXIgcm9vbVxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGV4cCA9IHRoaXMuc2VydmljZXMuZ2V0RXhwKG1vYiwgY2hhckRtZyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGFydHkgPSB0aGlzLnBhcnR5Um91dGVyLmdldENoYXJQYXJ0eShjaGFyU29ja2V0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJ0eSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBjdXJyZW50UGFydHlFeHAgPSAocGFydGllcy5nZXQocGFydHkpIHx8IHtleHA6IDB9KS5leHA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydGllcy5zZXQocGFydHksIHtzb2NrZXQ6IGNoYXJTb2NrZXQsIGV4cDogY3VycmVudFBhcnR5RXhwfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuXHRcdFx0XHQgICAgICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdChzdGF0c0NvbmZpZy5TRVJWRVJfSU5ORVIuR0FJTl9FWFAubmFtZSwgeyBleHAgfSwgY2hhclNvY2tldCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGFyRG1nID4gbWF4LmRtZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heC5kbWcgPSBjaGFyRG1nO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heC5zb2NrZXQgPSBjaGFyU29ja2V0O1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZvciAobGV0IFssIHtzb2NrZXQsIGV4cH1dIG9mIHBhcnRpZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHBhcnR5U29ja2V0cyA9IHRoaXMucGFydHlSb3V0ZXIuZ2V0UGFydHlNZW1iZXJzSW5NYXAoc29ja2V0KTtcbiAgICAgICAgICAgICAgICAgICAgLy8gc3BsaXQgZXhwIGVxdWFsbHkgYW1vbmcgcGFydHkgbWVtYmVyc1xuICAgICAgICAgICAgICAgICAgICBleHAgPSBNYXRoLmNlaWwoZXhwIC8gcGFydHlTb2NrZXRzLmxlbmd0aCk7XG5cbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgbWVtYmVyU29ja2V0IG9mIHBhcnR5U29ja2V0cykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoc3RhdHNDb25maWcuU0VSVkVSX0lOTkVSLkdBSU5fRVhQLm5hbWUsIHsgZXhwIH0sIG1lbWJlclNvY2tldCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdChkcm9wc0NvbmZpZy5TRVJWRVJfSU5ORVIuR0VORVJBVEVfRFJPUFMubmFtZSwge3g6IG1vYi54LCB5OiBtb2IueSwgb3duZXI6IG1heC5zb2NrZXQuY2hhcmFjdGVyLm5hbWV9LCBtYXguc29ja2V0LCBtb2IuZHJvcHMpO1xuICAgICAgICAgICAgICAgIHRoaXMuZW1pdHRlci5lbWl0KHF1ZXN0c0NvbmZpZy5TRVJWRVJfSU5ORVIuSFVOVF9NT0IubmFtZSwge2lkOiBtb2IubW9iSWR9LCBtYXguc29ja2V0KTtcblx0XHRcdH1cblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5zZW5kRXJyb3IoZGF0YSwgc29ja2V0LCBcIk1vYiBkb2Vzbid0IGV4aXN0IVwiKTtcblx0XHR9XG5cdH1cblxuXHRbY29uZmlnLlNFUlZFUl9HRVRTLk1PQl9NT1ZFLm5hbWVdKGRhdGEsIHNvY2tldDogR2FtZVNvY2tldCkge1xuXHRcdGlmICghdGhpcy5jb250cm9sbGVyLmhhc01vYihkYXRhLm1vYl9pZCwgc29ja2V0KSkge1xuXHRcdFx0dGhpcy5zZW5kRXJyb3IoZGF0YSwgc29ja2V0LCBcIk1vYiBkb2Vzbid0IGV4aXN0IVwiKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5jb250cm9sbGVyLm1vdmVNb2IoZGF0YS5tb2JfaWQsIGRhdGEueCwgZGF0YS55LCBzb2NrZXQpO1xuXHRcdH1cblx0fVxuXG5cdFtjb25maWcuU0VSVkVSX0dFVFMuVEFLRV9ETUcubmFtZV0oZGF0YSwgc29ja2V0OiBHYW1lU29ja2V0KSB7XG5cdFx0aWYgKHRoaXMuY29udHJvbGxlci5oYXNNb2IoZGF0YS5tb2JfaWQsIHNvY2tldCkpIHtcblx0XHRcdGxldCBkbWcgPSB0aGlzLmNvbnRyb2xsZXIuZ2V0SHVydENoYXJEbWcoZGF0YS5tb2JfaWQsIHNvY2tldCk7XG5cdFx0XHR0aGlzLmVtaXR0ZXIuZW1pdChzdGF0c0NvbmZpZy5TRVJWRVJfSU5ORVIuVEFLRV9ETUcubmFtZSwgeyBkbWcgfSwgc29ja2V0KTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5zZW5kRXJyb3IoZGF0YSwgc29ja2V0LCBcIk1vYiBkb2Vzbid0IGV4aXN0IVwiKTtcblx0XHR9XG5cdH1cbn07XG4iXX0=
